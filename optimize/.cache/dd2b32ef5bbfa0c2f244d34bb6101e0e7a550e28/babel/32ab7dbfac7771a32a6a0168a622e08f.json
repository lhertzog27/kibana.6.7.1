{"remainingRequest":"/home/anthony/git_workspaces/kibana/node_modules/thread-loader/dist/cjs.js??ref--9-1!/home/anthony/git_workspaces/kibana/node_modules/babel-loader/lib/index.js??ref--9-2!/home/anthony/git_workspaces/kibana/x-pack/plugins/ml/public/jobs/new_job/simple/population/create_job/create_job_service.js","dependencies":[{"path":"/home/anthony/git_workspaces/kibana/x-pack/plugins/ml/public/jobs/new_job/simple/population/create_job/create_job_service.js","mtime":1567631712059},{"path":"/home/anthony/git_workspaces/kibana/node_modules/cache-loader/dist/cjs.js","mtime":1567666236302},{"path":"/home/anthony/git_workspaces/kibana/node_modules/thread-loader/dist/cjs.js","mtime":1567666239443},{"path":"/home/anthony/git_workspaces/kibana/node_modules/babel-loader/lib/index.js","mtime":1567666227676}],"contextDependencies":[],"result":["'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }(); /*\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * or more contributor license agreements. Licensed under the Elastic License;\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * you may not use this file except in compliance with the Elastic License.\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      */\n\nexports.PopulationJobServiceProvider = PopulationJobServiceProvider;\n\nvar _lodash = require('lodash');\n\nvar _lodash2 = _interopRequireDefault(_lodash);\n\nvar _general = require('plugins/ml/jobs/new_job/simple/components/constants/general');\n\nvar _job_utils = require('plugins/ml/../common/util/job_utils');\n\nvar _ml_time_buckets = require('plugins/ml/util/ml_time_buckets');\n\nvar _field_format_service = require('plugins/ml/services/field_format_service');\n\nvar _job_service = require('plugins/ml/services/job_service');\n\nvar _new_job_utils = require('plugins/ml/jobs/new_job/utils/new_job_utils');\n\nvar _ml_api_service = require('plugins/ml/services/ml_api_service');\n\nvar _timefilter = require('ui/timefilter');\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\nfunction PopulationJobServiceProvider(Private) {\n\n  var TimeBuckets = Private(_ml_time_buckets.IntervalHelperProvider);\n  var OVER_FIELD_EXAMPLES_COUNT = 40;\n\n  var PopulationJobService = function () {\n    function PopulationJobService() {\n      _classCallCheck(this, PopulationJobService);\n\n      this.chartData = {\n        job: {\n          swimlane: [],\n          line: [],\n          bars: [],\n          earliestTime: Number.MAX_SAFE_INTEGER\n        },\n        detectors: {},\n        percentComplete: 0,\n        loadingDifference: 0,\n        lastLoadTimestamp: null,\n        eventRateHighestValue: 0,\n        chartTicksMargin: { width: 30 },\n        totalResults: 0\n      };\n      this.job = {};\n    }\n\n    _createClass(PopulationJobService, [{\n      key: 'clearChartData',\n      value: function clearChartData() {\n        this.chartData.job.swimlane = [];\n        this.chartData.job.line = [];\n        this.chartData.job.bars = [];\n        this.chartData.detectors = {};\n        this.chartData.percentComplete = 0;\n        this.chartData.loadingDifference = 0;\n        this.chartData.eventRateHighestValue = 0;\n        this.chartData.totalResults = 0;\n        this.job = {};\n      }\n    }, {\n      key: 'getLineChartResults',\n      value: function getLineChartResults(formConfig, thisLoadTimestamp) {\n        var _this = this;\n\n        return new Promise(function (resolve, reject) {\n\n          var fieldIds = formConfig.fields.map(function (f) {\n            return f.id;\n          });\n\n          _this.chartData.job.earliestTime = formConfig.start;\n\n          // move event rate field to the front of the list\n          var idx = _lodash2.default.findIndex(fieldIds, function (id) {\n            return id === _general.EVENT_RATE_COUNT_FIELD;\n          });\n          if (idx !== -1) {\n            fieldIds.splice(idx, 1);\n            fieldIds.splice(0, 0, _general.EVENT_RATE_COUNT_FIELD);\n          }\n\n          fieldIds.forEach(function (fieldId, i) {\n            _this.chartData.detectors[i] = {\n              line: [],\n              swimlane: [],\n              highestValue: 0\n            };\n          });\n\n          var searchJson = getSearchJsonFromConfig(formConfig, _timefilter.timefilter, TimeBuckets);\n\n          _ml_api_service.ml.esSearch(searchJson).then(function (resp) {\n            // if this is the last chart load, wipe all previous chart data\n            if (thisLoadTimestamp === _this.chartData.lastLoadTimestamp) {\n\n              fieldIds.forEach(function (fieldId, i) {\n                _this.chartData.detectors[i] = {\n                  line: [],\n                  swimlane: [],\n                  highestValue: 0\n                };\n\n                if (fieldId !== _general.EVENT_RATE_COUNT_FIELD) {\n                  var field = formConfig.fields[i];\n                  var aggType = field.agg.type.dslName;\n                  _this.chartData.detectors[i].fieldFormat = _field_format_service.mlFieldFormatService.getFieldFormatFromIndexPattern(formConfig.indexPattern, fieldId, aggType);\n                }\n              });\n            } else {\n              resolve(_this.chartData);\n            }\n            var aggregationsByTime = _lodash2.default.get(resp, ['aggregations', 'times', 'buckets'], []);\n\n            _lodash2.default.each(aggregationsByTime, function (dataForTime) {\n              var time = +dataForTime.key;\n              var date = new Date(time);\n\n              _this.chartData.job.swimlane.push({\n                date: date,\n                time: time,\n                value: 0,\n                color: '',\n                percentComplete: 0\n              });\n\n              _this.chartData.job.earliestTime = time < _this.chartData.job.earliestTime ? time : _this.chartData.job.earliestTime;\n\n              _this.chartData.job.line.push({\n                date: date,\n                time: time,\n                value: null\n              });\n\n              fieldIds.forEach(function (fieldId, i) {\n                var populationBuckets = _lodash2.default.get(dataForTime, ['population', 'buckets'], []);\n                var values = [];\n                if (fieldId === _general.EVENT_RATE_COUNT_FIELD) {\n                  populationBuckets.forEach(function (b) {\n                    // check to see if the data is split.\n                    if (b[i] === undefined) {\n                      values.push({ label: b.key, value: b.doc_count });\n                    } else {\n                      // a split is being used, so an additional filter was added to the search\n                      values.push({ label: b.key, value: b[i].doc_count });\n                    }\n                  });\n                } else if (typeof dataForTime.population !== 'undefined') {\n                  populationBuckets.forEach(function (b) {\n                    var tempBucket = b[i];\n                    var value = null;\n                    // check to see if the data is split\n                    // if the field has been split, an additional filter and aggregation\n                    // has been added to the search in the form of splitValue\n                    var tempValue = tempBucket.value === undefined && tempBucket.splitValue !== undefined ? tempBucket.splitValue : tempBucket;\n\n                    // check to see if values is exists rather than value.\n                    // if values exists, the aggregation was median\n                    if (tempValue.value === undefined && tempValue.values !== undefined) {\n                      value = tempValue.values[_job_utils.ML_MEDIAN_PERCENTS];\n                    } else {\n                      value = tempValue.value;\n                    }\n                    values.push({ label: b.key, value: isFinite(value) ? value : null });\n                  });\n                }\n\n                var highestValueField = _lodash2.default.reduce(values, function (p, c) {\n                  return c.value > p.value ? c : p;\n                }, { value: 0 });\n\n                if (_this.chartData.detectors[i]) {\n                  _this.chartData.detectors[i].line.push({\n                    date: date,\n                    time: time,\n                    values: values\n                  });\n\n                  // init swimlane\n                  _this.chartData.detectors[i].swimlane.push({\n                    date: date,\n                    time: time,\n                    value: 0,\n                    color: '',\n                    percentComplete: 0\n                  });\n\n                  _this.chartData.detectors[i].highestValue = Math.ceil(Math.max(_this.chartData.detectors[i].highestValue, Math.abs(highestValueField.value)));\n                }\n              });\n            });\n\n            resolve(_this.chartData);\n          }).catch(function (resp) {\n            reject(resp);\n          });\n        });\n      }\n    }, {\n      key: 'getJobFromConfig',\n      value: function getJobFromConfig(formConfig) {\n        var job = _job_service.mlJobService.getBlankJob();\n        job.data_description.time_field = formConfig.timeField;\n\n        if (formConfig.enableModelPlot === true) {\n          job.model_plot_config = {\n            enabled: true\n          };\n        } else if (formConfig.enableModelPlot === false) {\n          delete job.model_plot_config;\n        }\n\n        formConfig.fields.forEach(function (field) {\n          var func = field.agg.type.mlName;\n          if (formConfig.isSparseData) {\n            if (field.agg.type.dslName === 'count') {\n              func = func.replace(/count/, 'non_zero_count');\n            } else if (field.agg.type.dslName === 'sum') {\n              func = func.replace(/sum/, 'non_null_sum');\n            }\n          }\n          var dtr = {\n            function: func\n          };\n\n          dtr.detector_description = func;\n\n          if (field.id !== _general.EVENT_RATE_COUNT_FIELD) {\n            dtr.field_name = field.name;\n            dtr.detector_description += '(' + field.name + ')';\n          }\n\n          if (field.splitField !== undefined) {\n            dtr.by_field_name = field.splitField.name;\n            dtr.detector_description += ' by ' + dtr.by_field_name;\n          }\n\n          if (formConfig.overField !== undefined) {\n            dtr.over_field_name = formConfig.overField.name;\n            dtr.detector_description += ' over ' + dtr.over_field_name;\n          }\n          // if (formConfig.splitField !== undefined) {\n          //   dtr.partition_field_name =  formConfig.splitField;\n          // }\n          job.analysis_config.detectors.push(dtr);\n        });\n\n        var influencerFields = formConfig.influencerFields.map(function (f) {\n          return f.name;\n        });\n        if (influencerFields && influencerFields.length) {\n          job.analysis_config.influencers = influencerFields;\n        }\n\n        var query = formConfig.combinedQuery;\n\n        job.analysis_config.bucket_span = formConfig.bucketSpan;\n\n        job.analysis_limits = {\n          model_memory_limit: formConfig.modelMemoryLimit\n        };\n\n        delete job.data_description.field_delimiter;\n        delete job.data_description.quote_character;\n        delete job.data_description.time_format;\n        delete job.data_description.format;\n\n        var indices = formConfig.indexPattern.title.split(',').map(function (i) {\n          return i.trim();\n        });\n\n        job.datafeed_config = {\n          query: query,\n          indices: indices\n        };\n        job.job_id = formConfig.jobId;\n        job.description = formConfig.description;\n        job.groups = formConfig.jobGroups;\n\n        if (formConfig.useDedicatedIndex) {\n          job.results_index_name = job.job_id;\n        }\n\n        if (formConfig.usesSavedSearch === false) {\n          // Jobs created from saved searches cannot be cloned in the wizard as the\n          // ML job config holds no reference to the saved search ID.\n          job.custom_settings = {\n            created_by: _general.WIZARD_TYPE.POPULATION\n          };\n        }\n\n        return job;\n      }\n    }, {\n      key: 'createJob',\n      value: function createJob(formConfig) {\n        var _this2 = this;\n\n        return new Promise(function (resolve, reject) {\n\n          _this2.job = _this2.getJobFromConfig(formConfig);\n          var job = (0, _new_job_utils.createJobForSaving)(_this2.job);\n\n          // DO THE SAVE\n          _job_service.mlJobService.saveNewJob(job).then(function (resp) {\n            if (resp.success) {\n              resolve(_this2.job);\n            } else {\n              reject(resp);\n            }\n          });\n        });\n      }\n    }, {\n      key: 'startDatafeed',\n      value: function startDatafeed(formConfig) {\n        var datafeedId = _job_service.mlJobService.getDatafeedId(formConfig.jobId);\n        return _job_service.mlJobService.startDatafeed(datafeedId, formConfig.jobId, formConfig.start, formConfig.end);\n      }\n    }, {\n      key: 'stopDatafeed',\n      value: function stopDatafeed(formConfig) {\n        var datafeedId = _job_service.mlJobService.getDatafeedId(formConfig.jobId);\n        return _job_service.mlJobService.stopDatafeed(datafeedId, formConfig.jobId);\n      }\n    }]);\n\n    return PopulationJobService;\n  }();\n\n  function getSearchJsonFromConfig(formConfig) {\n    var bounds = _timefilter.timefilter.getActiveBounds();\n    var buckets = new TimeBuckets();\n    buckets.setInterval('auto');\n    buckets.setBounds(bounds);\n\n    var interval = buckets.getInterval().asMilliseconds();\n\n    // clone the query as we're modifying it\n    var query = _lodash2.default.cloneDeep(formConfig.combinedQuery);\n\n    var json = {\n      index: formConfig.indexPattern.title,\n      size: 0,\n      body: {\n        query: {},\n        aggs: {\n          times: {\n            date_histogram: {\n              field: formConfig.timeField,\n              interval: interval,\n              min_doc_count: 0,\n              extended_bounds: {\n                min: formConfig.start,\n                max: formConfig.end\n              }\n            }\n          }\n        }\n      }\n    };\n\n    query.bool.must.push({\n      range: _defineProperty({}, formConfig.timeField, {\n        gte: formConfig.start,\n        lte: formConfig.end,\n        format: formConfig.format\n      })\n    });\n\n    // NOTE, disabled for now. this may return it global partitioning is wanted.\n    // if the data is partitioned, add an additional search term\n    // if (formConfig.firstSplitFieldName !== undefined) {\n    //   query.bool.must.push({\n    //     term: {\n    //       [formConfig.splitField] : formConfig.firstSplitFieldName\n    //     }\n    //   });\n    // }\n\n    json.body.query = query;\n\n    if (formConfig.fields.length) {\n      var aggs = {};\n      formConfig.fields.forEach(function (field, i) {\n        if (field.id === _general.EVENT_RATE_COUNT_FIELD) {\n          if (field.splitField !== undefined && field.firstSplitFieldName !== undefined) {\n            // the event rate chart is draw using doc_values, so no need to specify a field.\n            // however. if the event rate field is split, add a filter to just match the\n            // fields which match the first split value (the front chart)\n            aggs[i] = {\n              filter: {\n                term: _defineProperty({}, field.splitField.name, field.firstSplitFieldName)\n              }\n            };\n          }\n        } else {\n          if (field.splitField !== undefined && field.firstSplitFieldName !== undefined) {\n            // if the field is split, add a filter to the aggregation to just select the\n            // fields which match the first split value (the front chart)\n            aggs[i] = {\n              filter: {\n                term: _defineProperty({}, field.splitField.name, field.firstSplitFieldName)\n              },\n              aggs: {\n                splitValue: _defineProperty({}, field.agg.type.dslName, { field: field.name })\n              }\n            };\n            if (field.agg.type.dslName === 'percentiles') {\n              aggs[i].aggs.splitValue[field.agg.type.dslName].percents = [_job_utils.ML_MEDIAN_PERCENTS];\n            }\n          } else {\n            aggs[i] = _defineProperty({}, field.agg.type.dslName, { field: field.name });\n\n            if (field.agg.type.dslName === 'percentiles') {\n              aggs[i][field.agg.type.dslName].percents = [_job_utils.ML_MEDIAN_PERCENTS];\n            }\n          }\n        }\n      });\n\n      if (formConfig.overField !== undefined) {\n        // the over field should not be undefined. the user should not have got this far if it is.\n        // add the wrapping terms based aggregation to divide the results up into\n        // over field values.\n        // we just want the first 40, or whatever OVER_FIELD_EXAMPLES_COUNT is set to.\n        json.body.aggs.times.aggs = {\n          population: {\n            terms: {\n              field: formConfig.overField.name,\n              size: OVER_FIELD_EXAMPLES_COUNT\n            },\n            aggs: aggs\n          }\n        };\n      } else {\n        json.body.aggs.times.aggs = aggs;\n      }\n    }\n\n    return json;\n  }\n\n  return new PopulationJobService();\n}",null]}