"use strict";
/*
 * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
 * or more contributor license agreements. Licensed under the Elastic License;
 * you may not use this file except in compliance with the Elastic License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const runtimeTypes = tslib_1.__importStar(require("io-ts"));
const PathReporter_1 = require("io-ts/lib/PathReporter");
const framework_1 = require("../adapters/framework");
const defaults_1 = require("./defaults");
const saved_object_mappings_1 = require("./saved_object_mappings");
const types_1 = require("./types");
class InfraSources {
    constructor(libs) {
        this.libs = libs;
    }
    async getSourceConfiguration(request, sourceId) {
        const staticDefaultSourceConfiguration = await this.getStaticDefaultSourceConfiguration();
        const savedSourceConfiguration = await this.getSavedSourceConfiguration(request, sourceId).then(result => ({
            ...result,
            configuration: mergeSourceConfiguration(staticDefaultSourceConfiguration, result.configuration),
        }), err => this.libs.savedObjects.SavedObjectsClient.errors.isNotFoundError(err)
            ? Promise.resolve({
                id: sourceId,
                version: undefined,
                updatedAt: undefined,
                configuration: staticDefaultSourceConfiguration,
            })
            : Promise.reject(err));
        return savedSourceConfiguration;
    }
    async getAllSourceConfigurations(request) {
        const staticDefaultSourceConfiguration = await this.getStaticDefaultSourceConfiguration();
        const savedSourceConfigurations = await this.getAllSavedSourceConfigurations(request);
        return savedSourceConfigurations.map(savedSourceConfiguration => ({
            ...savedSourceConfiguration,
            configuration: mergeSourceConfiguration(staticDefaultSourceConfiguration, savedSourceConfiguration.configuration),
        }));
    }
    async createSourceConfiguration(request, sourceId, source) {
        const staticDefaultSourceConfiguration = await this.getStaticDefaultSourceConfiguration();
        const newSourceConfiguration = mergeSourceConfiguration(staticDefaultSourceConfiguration, source);
        const createdSourceConfiguration = convertSavedObjectToSavedSourceConfiguration(await this.libs.savedObjects
            .getScopedSavedObjectsClient(request[framework_1.internalInfraFrameworkRequest])
            .create(saved_object_mappings_1.infraSourceConfigurationSavedObjectType, types_1.pickSavedSourceConfiguration(newSourceConfiguration), { id: sourceId }));
        return {
            ...createdSourceConfiguration,
            configuration: mergeSourceConfiguration(staticDefaultSourceConfiguration, createdSourceConfiguration.configuration),
        };
    }
    async deleteSourceConfiguration(request, sourceId) {
        await this.libs.savedObjects
            .getScopedSavedObjectsClient(request[framework_1.internalInfraFrameworkRequest])
            .delete(saved_object_mappings_1.infraSourceConfigurationSavedObjectType, sourceId);
    }
    async updateSourceConfiguration(request, sourceId, updaters) {
        const staticDefaultSourceConfiguration = await this.getStaticDefaultSourceConfiguration();
        const { configuration, version } = await this.getSourceConfiguration(request, sourceId);
        const updatedConfigurationAttributes = updaters.reduce((accumulatedConfiguration, updater) => updater(accumulatedConfiguration), configuration);
        const updatedSourceConfiguration = convertSavedObjectToSavedSourceConfiguration(await this.libs.savedObjects
            .getScopedSavedObjectsClient(request[framework_1.internalInfraFrameworkRequest])
            .update(saved_object_mappings_1.infraSourceConfigurationSavedObjectType, sourceId, types_1.pickSavedSourceConfiguration(updatedConfigurationAttributes), {
            version,
        }));
        return {
            ...updatedSourceConfiguration,
            configuration: mergeSourceConfiguration(staticDefaultSourceConfiguration, updatedSourceConfiguration.configuration),
        };
    }
    async getStaticDefaultSourceConfiguration() {
        const staticConfiguration = await this.libs.configuration.get();
        const staticSourceConfiguration = runtimeTypes
            .type({
            sources: runtimeTypes.type({
                default: types_1.StaticSourceConfigurationRuntimeType,
            }),
        })
            .decode(staticConfiguration)
            .map(({ sources: { default: defaultConfiguration } }) => defaultConfiguration)
            .getOrElse({});
        return mergeSourceConfiguration(defaults_1.defaultSourceConfiguration, staticSourceConfiguration);
    }
    async getSavedSourceConfiguration(request, sourceId) {
        const savedObjectsClient = this.libs.savedObjects.getScopedSavedObjectsClient(request[framework_1.internalInfraFrameworkRequest]);
        const savedObject = await savedObjectsClient.get(saved_object_mappings_1.infraSourceConfigurationSavedObjectType, sourceId);
        return convertSavedObjectToSavedSourceConfiguration(savedObject);
    }
    async getAllSavedSourceConfigurations(request) {
        const savedObjectsClient = this.libs.savedObjects.getScopedSavedObjectsClient(request[framework_1.internalInfraFrameworkRequest]);
        const savedObjects = await savedObjectsClient.find({
            type: saved_object_mappings_1.infraSourceConfigurationSavedObjectType,
        });
        return savedObjects.saved_objects.map(convertSavedObjectToSavedSourceConfiguration);
    }
}
exports.InfraSources = InfraSources;
const mergeSourceConfiguration = (first, ...others) => others.reduce((previousSourceConfiguration, currentSourceConfiguration) => ({
    ...previousSourceConfiguration,
    ...currentSourceConfiguration,
    fields: {
        ...previousSourceConfiguration.fields,
        ...currentSourceConfiguration.fields,
    },
}), first);
const convertSavedObjectToSavedSourceConfiguration = (savedObject) => types_1.SourceConfigurationSavedObjectRuntimeType.decode(savedObject)
    .map(savedSourceConfiguration => ({
    id: savedSourceConfiguration.id,
    version: savedSourceConfiguration.version,
    updatedAt: savedSourceConfiguration.updated_at,
    configuration: savedSourceConfiguration.attributes,
}))
    .getOrElseL(errors => {
    throw new Error(PathReporter_1.failure(errors).join('\n'));
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL2hvbWUvYW50aG9ueS9naXRfd29ya3NwYWNlcy9raWJhbmEveC1wYWNrL3BsdWdpbnMvaW5mcmEvc2VydmVyL2xpYi9zb3VyY2VzL3NvdXJjZXMudHMiLCJzb3VyY2VzIjpbIi9ob21lL2FudGhvbnkvZ2l0X3dvcmtzcGFjZXMva2liYW5hL3gtcGFjay9wbHVnaW5zL2luZnJhL3NlcnZlci9saWIvc291cmNlcy9zb3VyY2VzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7OztHQUlHOzs7QUFFSCw0REFBc0M7QUFDdEMseURBQWlEO0FBS2pELHFEQUE2RjtBQUM3Rix5Q0FBd0Q7QUFDeEQsbUVBQWtGO0FBQ2xGLG1DQU9pQjtBQUVqQixNQUFhLFlBQVk7SUFDdkIsWUFDbUIsSUFJaEI7UUFKZ0IsU0FBSSxHQUFKLElBQUksQ0FJcEI7SUFDQSxDQUFDO0lBRUcsS0FBSyxDQUFDLHNCQUFzQixDQUFDLE9BQThCLEVBQUUsUUFBZ0I7UUFDbEYsTUFBTSxnQ0FBZ0MsR0FBRyxNQUFNLElBQUksQ0FBQyxtQ0FBbUMsRUFBRSxDQUFDO1FBRTFGLE1BQU0sd0JBQXdCLEdBQUcsTUFBTSxJQUFJLENBQUMsMkJBQTJCLENBQUMsT0FBTyxFQUFFLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FDN0YsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ1QsR0FBRyxNQUFNO1lBQ1QsYUFBYSxFQUFFLHdCQUF3QixDQUNyQyxnQ0FBZ0MsRUFDaEMsTUFBTSxDQUFDLGFBQWEsQ0FDckI7U0FDRixDQUFDLEVBQ0YsR0FBRyxDQUFDLEVBQUUsQ0FDSixJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQztZQUNuRSxDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQztnQkFDZCxFQUFFLEVBQUUsUUFBUTtnQkFDWixPQUFPLEVBQUUsU0FBUztnQkFDbEIsU0FBUyxFQUFFLFNBQVM7Z0JBQ3BCLGFB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WUFBWSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsNENBQTRDLENBQUMsQ0FBQztJQUN0RixDQUFDO0NBQ0Y7QUFoS0Qsb0NBZ0tDO0FBRUQsTUFBTSx3QkFBd0IsR0FBRyxDQUMvQixLQUErQixFQUMvQixHQUFHLE1BQXdDLEVBQzNDLEVBQUUsQ0FDRixNQUFNLENBQUMsTUFBTSxDQUNYLENBQUMsMkJBQTJCLEVBQUUsMEJBQTBCLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDNUQsR0FBRywyQkFBMkI7SUFDOUIsR0FBRywwQkFBMEI7SUFDN0IsTUFBTSxFQUFFO1FBQ04sR0FBRywyQkFBMkIsQ0FBQyxNQUFNO1FBQ3JDLEdBQUcsMEJBQTBCLENBQUMsTUFBTTtLQUNyQztDQUNGLENBQUMsRUFDRixLQUFLLENBQ04sQ0FBQztBQUVKLE1BQU0sNENBQTRDLEdBQUcsQ0FBQyxXQUFvQixFQUFFLEVBQUUsQ0FDNUUsaURBQXlDLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQztLQUMxRCxHQUFHLENBQUMsd0JBQXdCLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDaEMsRUFBRSxFQUFFLHdCQUF3QixDQUFDLEVBQUU7SUFDL0IsT0FBTyxFQUFFLHdCQUF3QixDQUFDLE9BQU87SUFDekMsU0FBUyxFQUFFLHdCQUF3QixDQUFDLFVBQVU7SUFDOUMsYUFBYSxFQUFFLHdCQUF3QixDQUFDLFVBQVU7Q0FDbkQsQ0FBQyxDQUFDO0tBQ0YsVUFBVSxDQUFDLE1BQU0sQ0FBQyxFQUFFO0lBQ25CLE1BQU0sSUFBSSxLQUFLLENBQUMsc0JBQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztBQUM5QyxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgRWxhc3RpY3NlYXJjaCBCLlYuIGFuZC9vciBsaWNlbnNlZCB0byBFbGFzdGljc2VhcmNoIEIuVi4gdW5kZXIgb25lXG4gKiBvciBtb3JlIGNvbnRyaWJ1dG9yIGxpY2Vuc2UgYWdyZWVtZW50cy4gTGljZW5zZWQgdW5kZXIgdGhlIEVsYXN0aWMgTGljZW5zZTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgRWxhc3RpYyBMaWNlbnNlLlxuICovXG5cbmltcG9ydCAqIGFzIHJ1bnRpbWVUeXBlcyBmcm9tICdpby10cyc7XG5pbXBvcnQgeyBmYWlsdXJlIH0gZnJvbSAnaW8tdHMvbGliL1BhdGhSZXBvcnRlcic7XG5pbXBvcnQgeyBMZWdhY3kgfSBmcm9tICdraWJhbmEnO1xuXG5pbXBvcnQgeyBQaWNrMyB9IGZyb20gJy4uLy4uLy4uL2NvbW1vbi91dGlsaXR5X3R5cGVzJztcbmltcG9ydCB7IEluZnJhQ29uZmlndXJhdGlvbkFkYXB0ZXIgfSBmcm9tICcuLi9hZGFwdGVycy9jb25maWd1cmF0aW9uJztcbmltcG9ydCB7IEluZnJhRnJhbWV3b3JrUmVxdWVzdCwgaW50ZXJuYWxJbmZyYUZyYW1ld29ya1JlcXVlc3QgfSBmcm9tICcuLi9hZGFwdGVycy9mcmFtZXdvcmsnO1xuaW1wb3J0IHsgZGVmYXVsdFNvdXJjZUNvbmZpZ3VyYXRpb24gfSBmcm9tICcuL2RlZmF1bHRzJztcbmltcG9ydCB7IGluZnJhU291cmNlQ29uZmlndXJhdGlvblNhdmVkT2JqZWN0VHlwZSB9IGZyb20gJy4vc2F2ZWRfb2JqZWN0X21hcHBpbmdzJztcbmltcG9ydCB7XG4gIEluZnJhU2F2ZWRTb3VyY2VDb25maWd1cmF0aW9uLFxuICBJbmZyYVNvdXJjZUNvbmZpZ3VyYXRpb24sXG4gIEluZnJhU3RhdGljU291cmNlQ29uZmlndXJhdGlvbixcbiAgcGlja1NhdmVkU291cmNlQ29uZmlndXJhdGlvbixcbiAgU291cmNlQ29uZmlndXJhdGlvblNhdmVkT2JqZWN0UnVudGltZVR5cGUsXG4gIFN0YXRpY1NvdXJjZUNvbmZpZ3VyYXRpb25SdW50aW1lVHlwZSxcbn0gZnJvbSAnLi90eXBlcyc7XG5cbmV4cG9ydCBjbGFzcyBJbmZyYVNvdXJjZXMge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IGxpYnM6IHtcbiAgICAgIGNvbmZpZ3VyYXRpb246IEluZnJhQ29uZmlndXJhdGlvbkFkYXB0ZXI7XG4gICAgICBzYXZlZE9iamVjdHM6IFBpY2s8TGVnYWN5LlNhdmVkT2JqZWN0c1NlcnZpY2UsICdnZXRTY29wZWRTYXZlZE9iamVjdHNDbGllbnQnPiAmXG4gICAgICAgIFBpY2szPExlZ2FjeS5TYXZlZE9iamVjdHNTZXJ2aWNlLCAnU2F2ZWRPYmplY3RzQ2xpZW50JywgJ2Vycm9ycycsICdpc05vdEZvdW5kRXJyb3InPjtcbiAgICB9XG4gICkge31cblxuICBwdWJsaWMgYXN5bmMgZ2V0U291cmNlQ29uZmlndXJhdGlvbihyZXF1ZXN0OiBJbmZyYUZyYW1ld29ya1JlcXVlc3QsIHNvdXJjZUlkOiBzdHJpbmcpIHtcbiAgICBjb25zdCBzdGF0aWNEZWZhdWx0U291cmNlQ29uZmlndXJhdGlvbiA9IGF3YWl0IHRoaXMuZ2V0U3RhdGljRGVmYXVsdFNvdXJjZUNvbmZpZ3VyYXRpb24oKTtcblxuICAgIGNvbnN0IHNhdmVkU291cmNlQ29uZmlndXJhdGlvbiA9IGF3YWl0IHRoaXMuZ2V0U2F2ZWRTb3VyY2VDb25maWd1cmF0aW9uKHJlcXVlc3QsIHNvdXJjZUlkKS50aGVuKFxuICAgICAgcmVzdWx0ID0+ICh7XG4gICAgICAgIC4uLnJlc3VsdCxcbiAgICAgICAgY29uZmlndXJhdGlvbjogbWVyZ2VTb3VyY2VDb25maWd1cmF0aW9uKFxuICAgICAgICAgIHN0YXRpY0RlZmF1bHRTb3VyY2VDb25maWd1cmF0aW9uLFxuICAgICAgICAgIHJlc3VsdC5jb25maWd1cmF0aW9uXG4gICAgICAgICksXG4gICAgICB9KSxcbiAgICAgIGVyciA9PlxuICAgICAgICB0aGlzLmxpYnMuc2F2ZWRPYmplY3RzLlNhdmVkT2JqZWN0c0NsaWVudC5lcnJvcnMuaXNOb3RGb3VuZEVycm9yKGVycilcbiAgICAgICAgICA/IFByb21pc2UucmVzb2x2ZSh7XG4gICAgICAgICAgICAgIGlkOiBzb3VyY2VJZCxcbiAgICAgICAgICAgICAgdmVyc2lvbjogdW5kZWZpbmVkLFxuICAgICAgICAgICAgICB1cGRhdGVkQXQ6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgY29uZmlndXJhdGlvbjogc3RhdGljRGVmYXVsdFNvdXJjZUNvbmZpZ3VyYXRpb24sXG4gICAgICAgICAgICB9KVxuICAgICAgICAgIDogUHJvbWlzZS5yZWplY3QoZXJyKVxuICAgICk7XG5cbiAgICByZXR1cm4gc2F2ZWRTb3VyY2VDb25maWd1cmF0aW9uO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGdldEFsbFNvdXJjZUNvbmZpZ3VyYXRpb25zKHJlcXVlc3Q6IEluZnJhRnJhbWV3b3JrUmVxdWVzdCkge1xuICAgIGNvbnN0IHN0YXRpY0RlZmF1bHRTb3VyY2VDb25maWd1cmF0aW9uID0gYXdhaXQgdGhpcy5nZXRTdGF0aWNEZWZhdWx0U291cmNlQ29uZmlndXJhdGlvbigpO1xuXG4gICAgY29uc3Qgc2F2ZWRTb3VyY2VDb25maWd1cmF0aW9ucyA9IGF3YWl0IHRoaXMuZ2V0QWxsU2F2ZWRTb3VyY2VDb25maWd1cmF0aW9ucyhyZXF1ZXN0KTtcblxuICAgIHJldHVybiBzYXZlZFNvdXJjZUNvbmZpZ3VyYXRpb25zLm1hcChzYXZlZFNvdXJjZUNvbmZpZ3VyYXRpb24gPT4gKHtcbiAgICAgIC4uLnNhdmVkU291cmNlQ29uZmlndXJhdGlvbixcbiAgICAgIGNvbmZpZ3VyYXRpb246IG1lcmdlU291cmNlQ29uZmlndXJhdGlvbihcbiAgICAgICAgc3RhdGljRGVmYXVsdFNvdXJjZUNvbmZpZ3VyYXRpb24sXG4gICAgICAgIHNhdmVkU291cmNlQ29uZmlndXJhdGlvbi5jb25maWd1cmF0aW9uXG4gICAgICApLFxuICAgIH0pKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBjcmVhdGVTb3VyY2VDb25maWd1cmF0aW9uKFxuICAgIHJlcXVlc3Q6IEluZnJhRnJhbWV3b3JrUmVxdWVzdCxcbiAgICBzb3VyY2VJZDogc3RyaW5nLFxuICAgIHNvdXJjZTogSW5mcmFTYXZlZFNvdXJjZUNvbmZpZ3VyYXRpb25cbiAgKSB7XG4gICAgY29uc3Qgc3RhdGljRGVmYXVsdFNvdXJjZUNvbmZpZ3VyYXRpb24gPSBhd2FpdCB0aGlzLmdldFN0YXRpY0RlZmF1bHRTb3VyY2VDb25maWd1cmF0aW9uKCk7XG5cbiAgICBjb25zdCBuZXdTb3VyY2VDb25maWd1cmF0aW9uID0gbWVyZ2VTb3VyY2VDb25maWd1cmF0aW9uKFxuICAgICAgc3RhdGljRGVmYXVsdFNvdXJjZUNvbmZpZ3VyYXRpb24sXG4gICAgICBzb3VyY2VcbiAgICApO1xuXG4gICAgY29uc3QgY3JlYXRlZFNvdXJjZUNvbmZpZ3VyYXRpb24gPSBjb252ZXJ0U2F2ZWRPYmplY3RUb1NhdmVkU291cmNlQ29uZmlndXJhdGlvbihcbiAgICAgIGF3YWl0IHRoaXMubGlicy5zYXZlZE9iamVjdHNcbiAgICAgICAgLmdldFNjb3BlZFNhdmVkT2JqZWN0c0NsaWVudChyZXF1ZXN0W2ludGVybmFsSW5mcmFGcmFtZXdvcmtSZXF1ZXN0XSlcbiAgICAgICAgLmNyZWF0ZShcbiAgICAgICAgICBpbmZyYVNvdXJjZUNvbmZpZ3VyYXRpb25TYXZlZE9iamVjdFR5cGUsXG4gICAgICAgICAgcGlja1NhdmVkU291cmNlQ29uZmlndXJhdGlvbihuZXdTb3VyY2VDb25maWd1cmF0aW9uKSxcbiAgICAgICAgICB7IGlkOiBzb3VyY2VJZCB9XG4gICAgICAgIClcbiAgICApO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIC4uLmNyZWF0ZWRTb3VyY2VDb25maWd1cmF0aW9uLFxuICAgICAgY29uZmlndXJhdGlvbjogbWVyZ2VTb3VyY2VDb25maWd1cmF0aW9uKFxuICAgICAgICBzdGF0aWNEZWZhdWx0U291cmNlQ29uZmlndXJhdGlvbixcbiAgICAgICAgY3JlYXRlZFNvdXJjZUNvbmZpZ3VyYXRpb24uY29uZmlndXJhdGlvblxuICAgICAgKSxcbiAgICB9O1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGRlbGV0ZVNvdXJjZUNvbmZpZ3VyYXRpb24ocmVxdWVzdDogSW5mcmFGcmFtZXdvcmtSZXF1ZXN0LCBzb3VyY2VJZDogc3RyaW5nKSB7XG4gICAgYXdhaXQgdGhpcy5saWJzLnNhdmVkT2JqZWN0c1xuICAgICAgLmdldFNjb3BlZFNhdmVkT2JqZWN0c0NsaWVudChyZXF1ZXN0W2ludGVybmFsSW5mcmFGcmFtZXdvcmtSZXF1ZXN0XSlcbiAgICAgIC5kZWxldGUoaW5mcmFTb3VyY2VDb25maWd1cmF0aW9uU2F2ZWRPYmplY3RUeXBlLCBzb3VyY2VJZCk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgdXBkYXRlU291cmNlQ29uZmlndXJhdGlvbihcbiAgICByZXF1ZXN0OiBJbmZyYUZyYW1ld29ya1JlcXVlc3QsXG4gICAgc291cmNlSWQ6IHN0cmluZyxcbiAgICB1cGRhdGVyczogQXJyYXk8KGNvbmZpZ3VyYXRpb246IEluZnJhU291cmNlQ29uZmlndXJhdGlvbikgPT4gSW5mcmFTb3VyY2VDb25maWd1cmF0aW9uPlxuICApIHtcbiAgICBjb25zdCBzdGF0aWNEZWZhdWx0U291cmNlQ29uZmlndXJhdGlvbiA9IGF3YWl0IHRoaXMuZ2V0U3RhdGljRGVmYXVsdFNvdXJjZUNvbmZpZ3VyYXRpb24oKTtcblxuICAgIGNvbnN0IHsgY29uZmlndXJhdGlvbiwgdmVyc2lvbiB9ID0gYXdhaXQgdGhpcy5nZXRTb3VyY2VDb25maWd1cmF0aW9uKHJlcXVlc3QsIHNvdXJjZUlkKTtcblxuICAgIGNvbnN0IHVwZGF0ZWRDb25maWd1cmF0aW9uQXR0cmlidXRlcyA9IHVwZGF0ZXJzLnJlZHVjZShcbiAgICAgIChhY2N1bXVsYXRlZENvbmZpZ3VyYXRpb24sIHVwZGF0ZXIpID0+IHVwZGF0ZXIoYWNjdW11bGF0ZWRDb25maWd1cmF0aW9uKSxcbiAgICAgIGNvbmZpZ3VyYXRpb25cbiAgICApO1xuXG4gICAgY29uc3QgdXBkYXRlZFNvdXJjZUNvbmZpZ3VyYXRpb24gPSBjb252ZXJ0U2F2ZWRPYmplY3RUb1NhdmVkU291cmNlQ29uZmlndXJhdGlvbihcbiAgICAgIGF3YWl0IHRoaXMubGlicy5zYXZlZE9iamVjdHNcbiAgICAgICAgLmdldFNjb3BlZFNhdmVkT2JqZWN0c0NsaWVudChyZXF1ZXN0W2ludGVybmFsSW5mcmFGcmFtZXdvcmtSZXF1ZXN0XSlcbiAgICAgICAgLnVwZGF0ZShcbiAgICAgICAgICBpbmZyYVNvdXJjZUNvbmZpZ3VyYXRpb25TYXZlZE9iamVjdFR5cGUsXG4gICAgICAgICAgc291cmNlSWQsXG4gICAgICAgICAgcGlja1NhdmVkU291cmNlQ29uZmlndXJhdGlvbih1cGRhdGVkQ29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIHZlcnNpb24sXG4gICAgICAgICAgfVxuICAgICAgICApXG4gICAgKTtcblxuICAgIHJldHVybiB7XG4gICAgICAuLi51cGRhdGVkU291cmNlQ29uZmlndXJhdGlvbixcbiAgICAgIGNvbmZpZ3VyYXRpb246IG1lcmdlU291cmNlQ29uZmlndXJhdGlvbihcbiAgICAgICAgc3RhdGljRGVmYXVsdFNvdXJjZUNvbmZpZ3VyYXRpb24sXG4gICAgICAgIHVwZGF0ZWRTb3VyY2VDb25maWd1cmF0aW9uLmNvbmZpZ3VyYXRpb25cbiAgICAgICksXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZ2V0U3RhdGljRGVmYXVsdFNvdXJjZUNvbmZpZ3VyYXRpb24oKSB7XG4gICAgY29uc3Qgc3RhdGljQ29uZmlndXJhdGlvbiA9IGF3YWl0IHRoaXMubGlicy5jb25maWd1cmF0aW9uLmdldCgpO1xuICAgIGNvbnN0IHN0YXRpY1NvdXJjZUNvbmZpZ3VyYXRpb24gPSBydW50aW1lVHlwZXNcbiAgICAgIC50eXBlKHtcbiAgICAgICAgc291cmNlczogcnVudGltZVR5cGVzLnR5cGUoe1xuICAgICAgICAgIGRlZmF1bHQ6IFN0YXRpY1NvdXJjZUNvbmZpZ3VyYXRpb25SdW50aW1lVHlwZSxcbiAgICAgICAgfSksXG4gICAgICB9KVxuICAgICAgLmRlY29kZShzdGF0aWNDb25maWd1cmF0aW9uKVxuICAgICAgLm1hcCgoeyBzb3VyY2VzOiB7IGRlZmF1bHQ6IGRlZmF1bHRDb25maWd1cmF0aW9uIH0gfSkgPT4gZGVmYXVsdENvbmZpZ3VyYXRpb24pXG4gICAgICAuZ2V0T3JFbHNlKHt9KTtcblxuICAgIHJldHVybiBtZXJnZVNvdXJjZUNvbmZpZ3VyYXRpb24oZGVmYXVsdFNvdXJjZUNvbmZpZ3VyYXRpb24sIHN0YXRpY1NvdXJjZUNvbmZpZ3VyYXRpb24pO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBnZXRTYXZlZFNvdXJjZUNvbmZpZ3VyYXRpb24ocmVxdWVzdDogSW5mcmFGcmFtZXdvcmtSZXF1ZXN0LCBzb3VyY2VJZDogc3RyaW5nKSB7XG4gICAgY29uc3Qgc2F2ZWRPYmplY3RzQ2xpZW50ID0gdGhpcy5saWJzLnNhdmVkT2JqZWN0cy5nZXRTY29wZWRTYXZlZE9iamVjdHNDbGllbnQoXG4gICAgICByZXF1ZXN0W2ludGVybmFsSW5mcmFGcmFtZXdvcmtSZXF1ZXN0XVxuICAgICk7XG5cbiAgICBjb25zdCBzYXZlZE9iamVjdCA9IGF3YWl0IHNhdmVkT2JqZWN0c0NsaWVudC5nZXQoXG4gICAgICBpbmZyYVNvdXJjZUNvbmZpZ3VyYXRpb25TYXZlZE9iamVjdFR5cGUsXG4gICAgICBzb3VyY2VJZFxuICAgICk7XG5cbiAgICByZXR1cm4gY29udmVydFNhdmVkT2JqZWN0VG9TYXZlZFNvdXJjZUNvbmZpZ3VyYXRpb24oc2F2ZWRPYmplY3QpO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBnZXRBbGxTYXZlZFNvdXJjZUNvbmZpZ3VyYXRpb25zKHJlcXVlc3Q6IEluZnJhRnJhbWV3b3JrUmVxdWVzdCkge1xuICAgIGNvbnN0IHNhdmVkT2JqZWN0c0NsaWVudCA9IHRoaXMubGlicy5zYXZlZE9iamVjdHMuZ2V0U2NvcGVkU2F2ZWRPYmplY3RzQ2xpZW50KFxuICAgICAgcmVxdWVzdFtpbnRlcm5hbEluZnJhRnJhbWV3b3JrUmVxdWVzdF1cbiAgICApO1xuXG4gICAgY29uc3Qgc2F2ZWRPYmplY3RzID0gYXdhaXQgc2F2ZWRPYmplY3RzQ2xpZW50LmZpbmQoe1xuICAgICAgdHlwZTogaW5mcmFTb3VyY2VDb25maWd1cmF0aW9uU2F2ZWRPYmplY3RUeXBlLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHNhdmVkT2JqZWN0cy5zYXZlZF9vYmplY3RzLm1hcChjb252ZXJ0U2F2ZWRPYmplY3RUb1NhdmVkU291cmNlQ29uZmlndXJhdGlvbik7XG4gIH1cbn1cblxuY29uc3QgbWVyZ2VTb3VyY2VDb25maWd1cmF0aW9uID0gKFxuICBmaXJzdDogSW5mcmFTb3VyY2VDb25maWd1cmF0aW9uLFxuICAuLi5vdGhlcnM6IEluZnJhU3RhdGljU291cmNlQ29uZmlndXJhdGlvbltdXG4pID0+XG4gIG90aGVycy5yZWR1Y2U8SW5mcmFTb3VyY2VDb25maWd1cmF0aW9uPihcbiAgICAocHJldmlvdXNTb3VyY2VDb25maWd1cmF0aW9uLCBjdXJyZW50U291cmNlQ29uZmlndXJhdGlvbikgPT4gKHtcbiAgICAgIC4uLnByZXZpb3VzU291cmNlQ29uZmlndXJhdGlvbixcbiAgICAgIC4uLmN1cnJlbnRTb3VyY2VDb25maWd1cmF0aW9uLFxuICAgICAgZmllbGRzOiB7XG4gICAgICAgIC4uLnByZXZpb3VzU291cmNlQ29uZmlndXJhdGlvbi5maWVsZHMsXG4gICAgICAgIC4uLmN1cnJlbnRTb3VyY2VDb25maWd1cmF0aW9uLmZpZWxkcyxcbiAgICAgIH0sXG4gICAgfSksXG4gICAgZmlyc3RcbiAgKTtcblxuY29uc3QgY29udmVydFNhdmVkT2JqZWN0VG9TYXZlZFNvdXJjZUNvbmZpZ3VyYXRpb24gPSAoc2F2ZWRPYmplY3Q6IHVua25vd24pID0+XG4gIFNvdXJjZUNvbmZpZ3VyYXRpb25TYXZlZE9iamVjdFJ1bnRpbWVUeXBlLmRlY29kZShzYXZlZE9iamVjdClcbiAgICAubWFwKHNhdmVkU291cmNlQ29uZmlndXJhdGlvbiA9PiAoe1xuICAgICAgaWQ6IHNhdmVkU291cmNlQ29uZmlndXJhdGlvbi5pZCxcbiAgICAgIHZlcnNpb246IHNhdmVkU291cmNlQ29uZmlndXJhdGlvbi52ZXJzaW9uLFxuICAgICAgdXBkYXRlZEF0OiBzYXZlZFNvdXJjZUNvbmZpZ3VyYXRpb24udXBkYXRlZF9hdCxcbiAgICAgIGNvbmZpZ3VyYXRpb246IHNhdmVkU291cmNlQ29uZmlndXJhdGlvbi5hdHRyaWJ1dGVzLFxuICAgIH0pKVxuICAgIC5nZXRPckVsc2VMKGVycm9ycyA9PiB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoZmFpbHVyZShlcnJvcnMpLmpvaW4oJ1xcbicpKTtcbiAgICB9KTtcbiJdfQ==