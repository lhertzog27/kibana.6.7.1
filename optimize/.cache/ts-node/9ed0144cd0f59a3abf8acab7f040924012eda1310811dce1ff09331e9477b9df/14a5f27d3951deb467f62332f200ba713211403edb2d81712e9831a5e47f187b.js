"use strict";
/*
 * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
 * or more contributor license agreements. Licensed under the Elastic License;
 * you may not use this file except in compliance with the Elastic License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const lodash_1 = require("lodash");
const builtin_rules_1 = require("./builtin_rules");
const convert_document_source_to_log_item_fields_1 = require("./convert_document_source_to_log_item_fields");
const message_1 = require("./message");
class InfraLogEntriesDomain {
    constructor(adapter, libs) {
        this.adapter = adapter;
        this.libs = libs;
    }
    async getLogEntriesAround(request, sourceId, key, maxCountBefore, maxCountAfter, filterQuery, highlightQuery) {
        if (maxCountBefore <= 0 && maxCountAfter <= 0) {
            return {
                entriesBefore: [],
                entriesAfter: [],
            };
        }
        const { configuration } = await this.libs.sources.getSourceConfiguration(request, sourceId);
        const formattingRules = message_1.compileFormattingRules(builtin_rules_1.getBuiltinRules(configuration.fields.message));
        const documentsBefore = await this.adapter.getAdjacentLogEntryDocuments(request, configuration, formattingRules.requiredFields, key, 'desc', Math.max(maxCountBefore, 1), filterQuery, highlightQuery);
        const lastKeyBefore = documentsBefore.length > 0
            ? documentsBefore[documentsBefore.length - 1].key
            : {
                time: key.time - 1,
                tiebreaker: 0,
            };
        const documentsAfter = await this.adapter.getAdjacentLogEntryDocuments(request, configuration, formattingRules.requiredFields, lastKeyBefore, 'asc', maxCountAfter, filterQuery, highlightQuery);
        return {
            entriesBefore: (maxCountBefore > 0 ? documentsBefore : []).map(convertLogDocumentToEntry(sourceId, formattingRules.format)),
            entriesAfter: documentsAfter.map(convertLogDocumentToEntry(sourceId, formattingRules.format)),
        };
    }
    async getLogEntriesBetween(request, sourceId, startKey, endKey, filterQuery, highlightQuery) {
        const { configuration } = await this.libs.sources.getSourceConfiguration(request, sourceId);
        const formattingRules = message_1.compileFormattingRules(builtin_rules_1.getBuiltinRules(configuration.fields.message));
        const documents = await this.adapter.getContainedLogEntryDocuments(request, configuration, formattingRules.requiredFields, startKey, endKey, filterQuery, highlightQuery);
        const entries = documents.map(convertLogDocumentToEntry(sourceId, formattingRules.format));
        return entries;
    }
    async getLogSummaryBucketsBetween(request, sourceId, start, end, bucketSize, filterQuery) {
        const { configuration } = await this.libs.sources.getSourceConfiguration(request, sourceId);
        const dateRangeBuckets = await this.adapter.getContainedLogSummaryBuckets(request, configuration, start, end, bucketSize, filterQuery);
        const buckets = dateRangeBuckets.map(convertDateRangeBucketToSummaryBucket);
        return buckets;
    }
    async getLogItem(request, id, sourceConfiguration) {
        const document = await this.adapter.getLogItem(request, id, sourceConfiguration);
        const defaultFields = [
            { field: '_index', value: document._index },
            { field: '_id', value: document._id },
        ];
        return {
            id: document._id,
            index: document._index,
            fields: lodash_1.sortBy([...defaultFields, ...convert_document_source_to_log_item_fields_1.convertDocumentSourceToLogItemFields(document._source)], 'field'),
        };
    }
}
exports.InfraLogEntriesDomain = InfraLogEntriesDomain;
const convertLogDocumentToEntry = (sourceId, formatMessage) => (document) => ({
    key: document.key,
    gid: document.gid,
    source: sourceId,
    message: formatMessage(document.fields),
});
const convertDateRangeBucketToSummaryBucket = (bucket) => ({
    entriesCount: bucket.doc_count,
    start: bucket.from || 0,
    end: bucket.to || 0,
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL2hvbWUvYW50aG9ueS9naXRfd29ya3NwYWNlcy9raWJhbmEveC1wYWNrL3BsdWdpbnMvaW5mcmEvc2VydmVyL2xpYi9kb21haW5zL2xvZ19lbnRyaWVzX2RvbWFpbi9sb2dfZW50cmllc19kb21haW4udHMiLCJzb3VyY2VzIjpbIi9ob21lL2FudGhvbnkvZ2l0X3dvcmtzcGFjZXMva2liYW5hL3gtcGFjay9wbHVnaW5zL2luZnJhL3NlcnZlci9saWIvZG9tYWlucy9sb2dfZW50cmllc19kb21haW4vbG9nX2VudHJpZXNfZG9tYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7OztHQUlHOztBQUVILG1DQUFnQztBQVdoQyxtREFBa0Q7QUFDbEQsNkdBQW9HO0FBQ3BHLHVDQUFtRDtBQUVuRCxNQUFhLHFCQUFxQjtJQUNoQyxZQUNtQixPQUEwQixFQUMxQixJQUErQjtRQUQvQixZQUFPLEdBQVAsT0FBTyxDQUFtQjtRQUMxQixTQUFJLEdBQUosSUFBSSxDQUEyQjtJQUMvQyxDQUFDO0lBRUcsS0FBSyxDQUFDLG1CQUFtQixDQUM5QixPQUE4QixFQUM5QixRQUFnQixFQUNoQixHQUFZLEVBQ1osY0FBc0IsRUFDdEIsYUFBcUIsRUFDckIsV0FBMkIsRUFDM0IsY0FBdUI7UUFFdkIsSUFBSSxjQUFjLElBQUksQ0FBQyxJQUFJLGFBQWEsSUFBSSxDQUFDLEVBQUU7WUFDN0MsT0FBTztnQkFDTCxhQUFhLEVBQUUsRUFBRTtnQkFDakIsWUFBWSxFQUFFLEVBQUU7YUFDakIsQ0FBQztTQUNIO1FBRUQsTUFBTSxFQUFFLGFBQWEsRUFBRSxHQUFHLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsc0JBQXNCLENBQUMsT0FBTyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQzVGLE1BQU0sZUFBZSxHQUFHLGdDQUFzQixDQUFDLCtCQUFlLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1FBRTlGLE1BQU0sZUFBZSxH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OlsiLypcbiAqIENvcHlyaWdodCBFbGFzdGljc2VhcmNoIEIuVi4gYW5kL29yIGxpY2Vuc2VkIHRvIEVsYXN0aWNzZWFyY2ggQi5WLiB1bmRlciBvbmVcbiAqIG9yIG1vcmUgY29udHJpYnV0b3IgbGljZW5zZSBhZ3JlZW1lbnRzLiBMaWNlbnNlZCB1bmRlciB0aGUgRWxhc3RpYyBMaWNlbnNlO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBFbGFzdGljIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgc29ydEJ5IH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IFRpbWVLZXkgfSBmcm9tICcuLi8uLi8uLi8uLi9jb21tb24vdGltZSc7XG5pbXBvcnQgeyBKc29uT2JqZWN0IH0gZnJvbSAnLi4vLi4vLi4vLi4vY29tbW9uL3R5cGVkX2pzb24nO1xuaW1wb3J0IHsgSW5mcmFMb2dJdGVtIH0gZnJvbSAnLi4vLi4vLi4vZ3JhcGhxbC90eXBlcyc7XG5pbXBvcnQge1xuICBJbmZyYUxvZ0VudHJ5LFxuICBJbmZyYUxvZ01lc3NhZ2VTZWdtZW50LFxuICBJbmZyYUxvZ1N1bW1hcnlCdWNrZXQsXG59IGZyb20gJy4uLy4uLy4uL2dyYXBocWwvdHlwZXMnO1xuaW1wb3J0IHsgSW5mcmFEYXRlUmFuZ2VBZ2dyZWdhdGlvbkJ1Y2tldCwgSW5mcmFGcmFtZXdvcmtSZXF1ZXN0IH0gZnJvbSAnLi4vLi4vYWRhcHRlcnMvZnJhbWV3b3JrJztcbmltcG9ydCB7IEluZnJhU291cmNlQ29uZmlndXJhdGlvbiwgSW5mcmFTb3VyY2VzIH0gZnJvbSAnLi4vLi4vc291cmNlcyc7XG5pbXBvcnQgeyBnZXRCdWlsdGluUnVsZXMgfSBmcm9tICcuL2J1aWx0aW5fcnVsZXMnO1xuaW1wb3J0IHsgY29udmVydERvY3VtZW50U291cmNlVG9Mb2dJdGVtRmllbGRzIH0gZnJvbSAnLi9jb252ZXJ0X2RvY3VtZW50X3NvdXJjZV90b19sb2dfaXRlbV9maWVsZHMnO1xuaW1wb3J0IHsgY29tcGlsZUZvcm1hdHRpbmdSdWxlcyB9IGZyb20gJy4vbWVzc2FnZSc7XG5cbmV4cG9ydCBjbGFzcyBJbmZyYUxvZ0VudHJpZXNEb21haW4ge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IGFkYXB0ZXI6IExvZ0VudHJpZXNBZGFwdGVyLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgbGliczogeyBzb3VyY2VzOiBJbmZyYVNvdXJjZXMgfVxuICApIHt9XG5cbiAgcHVibGljIGFzeW5jIGdldExvZ0VudHJpZXNBcm91bmQoXG4gICAgcmVxdWVzdDogSW5mcmFGcmFtZXdvcmtSZXF1ZXN0LFxuICAgIHNvdXJjZUlkOiBzdHJpbmcsXG4gICAga2V5OiBUaW1lS2V5LFxuICAgIG1heENvdW50QmVmb3JlOiBudW1iZXIsXG4gICAgbWF4Q291bnRBZnRlcjogbnVtYmVyLFxuICAgIGZpbHRlclF1ZXJ5PzogTG9nRW50cnlRdWVyeSxcbiAgICBoaWdobGlnaHRRdWVyeT86IHN0cmluZ1xuICApOiBQcm9taXNlPHsgZW50cmllc0JlZm9yZTogSW5mcmFMb2dFbnRyeVtdOyBlbnRyaWVzQWZ0ZXI6IEluZnJhTG9nRW50cnlbXSB9PiB7XG4gICAgaWYgKG1heENvdW50QmVmb3JlIDw9IDAgJiYgbWF4Q291bnRBZnRlciA8PSAwKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBlbnRyaWVzQmVmb3JlOiBbXSxcbiAgICAgICAgZW50cmllc0FmdGVyOiBbXSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgY29uc3QgeyBjb25maWd1cmF0aW9uIH0gPSBhd2FpdCB0aGlzLmxpYnMuc291cmNlcy5nZXRTb3VyY2VDb25maWd1cmF0aW9uKHJlcXVlc3QsIHNvdXJjZUlkKTtcbiAgICBjb25zdCBmb3JtYXR0aW5nUnVsZXMgPSBjb21waWxlRm9ybWF0dGluZ1J1bGVzKGdldEJ1aWx0aW5SdWxlcyhjb25maWd1cmF0aW9uLmZpZWxkcy5tZXNzYWdlKSk7XG5cbiAgICBjb25zdCBkb2N1bWVudHNCZWZvcmUgPSBhd2FpdCB0aGlzLmFkYXB0ZXIuZ2V0QWRqYWNlbnRMb2dFbnRyeURvY3VtZW50cyhcbiAgICAgIHJlcXVlc3QsXG4gICAgICBjb25maWd1cmF0aW9uLFxuICAgICAgZm9ybWF0dGluZ1J1bGVzLnJlcXVpcmVkRmllbGRzLFxuICAgICAga2V5LFxuICAgICAgJ2Rlc2MnLFxuICAgICAgTWF0aC5tYXgobWF4Q291bnRCZWZvcmUsIDEpLFxuICAgICAgZmlsdGVyUXVlcnksXG4gICAgICBoaWdobGlnaHRRdWVyeVxuICAgICk7XG4gICAgY29uc3QgbGFzdEtleUJlZm9yZSA9XG4gICAgICBkb2N1bWVudHNCZWZvcmUubGVuZ3RoID4gMFxuICAgICAgICA/IGRvY3VtZW50c0JlZm9yZVtkb2N1bWVudHNCZWZvcmUubGVuZ3RoIC0gMV0ua2V5XG4gICAgICAgIDoge1xuICAgICAgICAgICAgdGltZToga2V5LnRpbWUgLSAxLFxuICAgICAgICAgICAgdGllYnJlYWtlcjogMCxcbiAgICAgICAgICB9O1xuXG4gICAgY29uc3QgZG9jdW1lbnRzQWZ0ZXIgPSBhd2FpdCB0aGlzLmFkYXB0ZXIuZ2V0QWRqYWNlbnRMb2dFbnRyeURvY3VtZW50cyhcbiAgICAgIHJlcXVlc3QsXG4gICAgICBjb25maWd1cmF0aW9uLFxuICAgICAgZm9ybWF0dGluZ1J1bGVzLnJlcXVpcmVkRmllbGRzLFxuICAgICAgbGFzdEtleUJlZm9yZSxcbiAgICAgICdhc2MnLFxuICAgICAgbWF4Q291bnRBZnRlcixcbiAgICAgIGZpbHRlclF1ZXJ5LFxuICAgICAgaGlnaGxpZ2h0UXVlcnlcbiAgICApO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIGVudHJpZXNCZWZvcmU6IChtYXhDb3VudEJlZm9yZSA+IDAgPyBkb2N1bWVudHNCZWZvcmUgOiBbXSkubWFwKFxuICAgICAgICBjb252ZXJ0TG9nRG9jdW1lbnRUb0VudHJ5KHNvdXJjZUlkLCBmb3JtYXR0aW5nUnVsZXMuZm9ybWF0KVxuICAgICAgKSxcbiAgICAgIGVudHJpZXNBZnRlcjogZG9jdW1lbnRzQWZ0ZXIubWFwKGNvbnZlcnRMb2dEb2N1bWVudFRvRW50cnkoc291cmNlSWQsIGZvcm1hdHRpbmdSdWxlcy5mb3JtYXQpKSxcbiAgICB9O1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGdldExvZ0VudHJpZXNCZXR3ZWVuKFxuICAgIHJlcXVlc3Q6IEluZnJhRnJhbWV3b3JrUmVxdWVzdCxcbiAgICBzb3VyY2VJZDogc3RyaW5nLFxuICAgIHN0YXJ0S2V5OiBUaW1lS2V5LFxuICAgIGVuZEtleTogVGltZUtleSxcbiAgICBmaWx0ZXJRdWVyeT86IExvZ0VudHJ5UXVlcnksXG4gICAgaGlnaGxpZ2h0UXVlcnk/OiBzdHJpbmdcbiAgKTogUHJvbWlzZTxJbmZyYUxvZ0VudHJ5W10+IHtcbiAgICBjb25zdCB7IGNvbmZpZ3VyYXRpb24gfSA9IGF3YWl0IHRoaXMubGlicy5zb3VyY2VzLmdldFNvdXJjZUNvbmZpZ3VyYXRpb24ocmVxdWVzdCwgc291cmNlSWQpO1xuICAgIGNvbnN0IGZvcm1hdHRpbmdSdWxlcyA9IGNvbXBpbGVGb3JtYXR0aW5nUnVsZXMoZ2V0QnVpbHRpblJ1bGVzKGNvbmZpZ3VyYXRpb24uZmllbGRzLm1lc3NhZ2UpKTtcbiAgICBjb25zdCBkb2N1bWVudHMgPSBhd2FpdCB0aGlzLmFkYXB0ZXIuZ2V0Q29udGFpbmVkTG9nRW50cnlEb2N1bWVudHMoXG4gICAgICByZXF1ZXN0LFxuICAgICAgY29uZmlndXJhdGlvbixcbiAgICAgIGZvcm1hdHRpbmdSdWxlcy5yZXF1aXJlZEZpZWxkcyxcbiAgICAgIHN0YXJ0S2V5LFxuICAgICAgZW5kS2V5LFxuICAgICAgZmlsdGVyUXVlcnksXG4gICAgICBoaWdobGlnaHRRdWVyeVxuICAgICk7XG4gICAgY29uc3QgZW50cmllcyA9IGRvY3VtZW50cy5tYXAoY29udmVydExvZ0RvY3VtZW50VG9FbnRyeShzb3VyY2VJZCwgZm9ybWF0dGluZ1J1bGVzLmZvcm1hdCkpO1xuICAgIHJldHVybiBlbnRyaWVzO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGdldExvZ1N1bW1hcnlCdWNrZXRzQmV0d2VlbihcbiAgICByZXF1ZXN0OiBJbmZyYUZyYW1ld29ya1JlcXVlc3QsXG4gICAgc291cmNlSWQ6IHN0cmluZyxcbiAgICBzdGFydDogbnVtYmVyLFxuICAgIGVuZDogbnVtYmVyLFxuICAgIGJ1Y2tldFNpemU6IG51bWJlcixcbiAgICBmaWx0ZXJRdWVyeT86IExvZ0VudHJ5UXVlcnlcbiAgKTogUHJvbWlzZTxJbmZyYUxvZ1N1bW1hcnlCdWNrZXRbXT4ge1xuICAgIGNvbnN0IHsgY29uZmlndXJhdGlvbiB9ID0gYXdhaXQgdGhpcy5saWJzLnNvdXJjZXMuZ2V0U291cmNlQ29uZmlndXJhdGlvbihyZXF1ZXN0LCBzb3VyY2VJZCk7XG4gICAgY29uc3QgZGF0ZVJhbmdlQnVja2V0cyA9IGF3YWl0IHRoaXMuYWRhcHRlci5nZXRDb250YWluZWRMb2dTdW1tYXJ5QnVja2V0cyhcbiAgICAgIHJlcXVlc3QsXG4gICAgICBjb25maWd1cmF0aW9uLFxuICAgICAgc3RhcnQsXG4gICAgICBlbmQsXG4gICAgICBidWNrZXRTaXplLFxuICAgICAgZmlsdGVyUXVlcnlcbiAgICApO1xuICAgIGNvbnN0IGJ1Y2tldHMgPSBkYXRlUmFuZ2VCdWNrZXRzLm1hcChjb252ZXJ0RGF0ZVJhbmdlQnVja2V0VG9TdW1tYXJ5QnVja2V0KTtcbiAgICByZXR1cm4gYnVja2V0cztcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBnZXRMb2dJdGVtKFxuICAgIHJlcXVlc3Q6IEluZnJhRnJhbWV3b3JrUmVxdWVzdCxcbiAgICBpZDogc3RyaW5nLFxuICAgIHNvdXJjZUNvbmZpZ3VyYXRpb246IEluZnJhU291cmNlQ29uZmlndXJhdGlvblxuICApOiBQcm9taXNlPEluZnJhTG9nSXRlbT4ge1xuICAgIGNvbnN0IGRvY3VtZW50ID0gYXdhaXQgdGhpcy5hZGFwdGVyLmdldExvZ0l0ZW0ocmVxdWVzdCwgaWQsIHNvdXJjZUNvbmZpZ3VyYXRpb24pO1xuICAgIGNvbnN0IGRlZmF1bHRGaWVsZHMgPSBbXG4gICAgICB7IGZpZWxkOiAnX2luZGV4JywgdmFsdWU6IGRvY3VtZW50Ll9pbmRleCB9LFxuICAgICAgeyBmaWVsZDogJ19pZCcsIHZhbHVlOiBkb2N1bWVudC5faWQgfSxcbiAgICBdO1xuICAgIHJldHVybiB7XG4gICAgICBpZDogZG9jdW1lbnQuX2lkLFxuICAgICAgaW5kZXg6IGRvY3VtZW50Ll9pbmRleCxcbiAgICAgIGZpZWxkczogc29ydEJ5KFxuICAgICAgICBbLi4uZGVmYXVsdEZpZWxkcywgLi4uY29udmVydERvY3VtZW50U291cmNlVG9Mb2dJdGVtRmllbGRzKGRvY3VtZW50Ll9zb3VyY2UpXSxcbiAgICAgICAgJ2ZpZWxkJ1xuICAgICAgKSxcbiAgICB9O1xuICB9XG59XG5cbmludGVyZmFjZSBMb2dJdGVtSGl0IHtcbiAgX2luZGV4OiBzdHJpbmc7XG4gIF9pZDogc3RyaW5nO1xuICBfc291cmNlOiBKc29uT2JqZWN0O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIExvZ0VudHJpZXNBZGFwdGVyIHtcbiAgZ2V0QWRqYWNlbnRMb2dFbnRyeURvY3VtZW50cyhcbiAgICByZXF1ZXN0OiBJbmZyYUZyYW1ld29ya1JlcXVlc3QsXG4gICAgc291cmNlQ29uZmlndXJhdGlvbjogSW5mcmFTb3VyY2VDb25maWd1cmF0aW9uLFxuICAgIGZpZWxkczogc3RyaW5nW10sXG4gICAgc3RhcnQ6IFRpbWVLZXksXG4gICAgZGlyZWN0aW9uOiAnYXNjJyB8ICdkZXNjJyxcbiAgICBtYXhDb3VudDogbnVtYmVyLFxuICAgIGZpbHRlclF1ZXJ5PzogTG9nRW50cnlRdWVyeSxcbiAgICBoaWdobGlnaHRRdWVyeT86IHN0cmluZ1xuICApOiBQcm9taXNlPExvZ0VudHJ5RG9jdW1lbnRbXT47XG5cbiAgZ2V0Q29udGFpbmVkTG9nRW50cnlEb2N1bWVudHMoXG4gICAgcmVxdWVzdDogSW5mcmFGcmFtZXdvcmtSZXF1ZXN0LFxuICAgIHNvdXJjZUNvbmZpZ3VyYXRpb246IEluZnJhU291cmNlQ29uZmlndXJhdGlvbixcbiAgICBmaWVsZHM6IHN0cmluZ1tdLFxuICAgIHN0YXJ0OiBUaW1lS2V5LFxuICAgIGVuZDogVGltZUtleSxcbiAgICBmaWx0ZXJRdWVyeT86IExvZ0VudHJ5UXVlcnksXG4gICAgaGlnaGxpZ2h0UXVlcnk/OiBzdHJpbmdcbiAgKTogUHJvbWlzZTxMb2dFbnRyeURvY3VtZW50W10+O1xuXG4gIGdldENvbnRhaW5lZExvZ1N1bW1hcnlCdWNrZXRzKFxuICAgIHJlcXVlc3Q6IEluZnJhRnJhbWV3b3JrUmVxdWVzdCxcbiAgICBzb3VyY2VDb25maWd1cmF0aW9uOiBJbmZyYVNvdXJjZUNvbmZpZ3VyYXRpb24sXG4gICAgc3RhcnQ6IG51bWJlcixcbiAgICBlbmQ6IG51bWJlcixcbiAgICBidWNrZXRTaXplOiBudW1iZXIsXG4gICAgZmlsdGVyUXVlcnk/OiBMb2dFbnRyeVF1ZXJ5XG4gICk6IFByb21pc2U8SW5mcmFEYXRlUmFuZ2VBZ2dyZWdhdGlvbkJ1Y2tldFtdPjtcblxuICBnZXRMb2dJdGVtKFxuICAgIHJlcXVlc3Q6IEluZnJhRnJhbWV3b3JrUmVxdWVzdCxcbiAgICBpZDogc3RyaW5nLFxuICAgIHNvdXJjZTogSW5mcmFTb3VyY2VDb25maWd1cmF0aW9uXG4gICk6IFByb21pc2U8TG9nSXRlbUhpdD47XG59XG5cbmV4cG9ydCB0eXBlIExvZ0VudHJ5UXVlcnkgPSBKc29uT2JqZWN0O1xuXG5leHBvcnQgaW50ZXJmYWNlIExvZ0VudHJ5RG9jdW1lbnQge1xuICBmaWVsZHM6IExvZ0VudHJ5RG9jdW1lbnRGaWVsZHM7XG4gIGdpZDogc3RyaW5nO1xuICBrZXk6IFRpbWVLZXk7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgTG9nRW50cnlEb2N1bWVudEZpZWxkcyB7XG4gIFtmaWVsZE5hbWU6IHN0cmluZ106IHN0cmluZyB8IG51bWJlciB8IGJvb2xlYW4gfCBudWxsO1xufVxuXG5jb25zdCBjb252ZXJ0TG9nRG9jdW1lbnRUb0VudHJ5ID0gKFxuICBzb3VyY2VJZDogc3RyaW5nLFxuICBmb3JtYXRNZXNzYWdlOiAoZmllbGRzOiBMb2dFbnRyeURvY3VtZW50RmllbGRzKSA9PiBJbmZyYUxvZ01lc3NhZ2VTZWdtZW50W11cbikgPT4gKGRvY3VtZW50OiBMb2dFbnRyeURvY3VtZW50KTogSW5mcmFMb2dFbnRyeSA9PiAoe1xuICBrZXk6IGRvY3VtZW50LmtleSxcbiAgZ2lkOiBkb2N1bWVudC5naWQsXG4gIHNvdXJjZTogc291cmNlSWQsXG4gIG1lc3NhZ2U6IGZvcm1hdE1lc3NhZ2UoZG9jdW1lbnQuZmllbGRzKSxcbn0pO1xuXG5jb25zdCBjb252ZXJ0RGF0ZVJhbmdlQnVja2V0VG9TdW1tYXJ5QnVja2V0ID0gKFxuICBidWNrZXQ6IEluZnJhRGF0ZVJhbmdlQWdncmVnYXRpb25CdWNrZXRcbik6IEluZnJhTG9nU3VtbWFyeUJ1Y2tldCA9PiAoe1xuICBlbnRyaWVzQ291bnQ6IGJ1Y2tldC5kb2NfY291bnQsXG4gIHN0YXJ0OiBidWNrZXQuZnJvbSB8fCAwLFxuICBlbmQ6IGJ1Y2tldC50byB8fCAwLFxufSk7XG4iXX0=