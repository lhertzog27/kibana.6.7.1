"use strict";
/*
 * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
 * or more contributor license agreements. Licensed under the Elastic License;
 * you may not use this file except in compliance with the Elastic License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const moment_1 = tslib_1.__importDefault(require("moment"));
const types_1 = require("../../../common/types");
const index_settings_1 = require("./index_settings");
// TODO: base on elasticsearch.requestTimeout?
exports.LOCK_WINDOW = moment_1.default.duration(90, 'seconds');
exports.reindexActionsFactory = (client, callCluster) => {
    // ----- Internal functions
    const isLocked = (reindexOp) => {
        if (reindexOp.attributes.locked) {
            const now = moment_1.default();
            const lockedTime = moment_1.default(reindexOp.attributes.locked);
            // If the object has been locked for more than the LOCK_WINDOW, assume the process that locked it died.
            if (now.subtract(exports.LOCK_WINDOW) < lockedTime) {
                return true;
            }
        }
        return false;
    };
    const acquireLock = async (reindexOp) => {
        if (isLocked(reindexOp)) {
            throw new Error(`Another Kibana process is currently modifying this reindex operation.`);
        }
        return client.update(types_1.REINDEX_OP_TYPE, reindexOp.id, { ...reindexOp.attributes, locked: moment_1.default().format() }, { version: reindexOp.version });
    };
    const releaseLock = (reindexOp) => {
        return client.update(types_1.REINDEX_OP_TYPE, reindexOp.id, { ...reindexOp.attributes, locked: null }, { version: reindexOp.version });
    };
    // ----- Public interface
    return {
        async createReindexOp(indexName) {
            return client.create(types_1.REINDEX_OP_TYPE, {
                indexName,
                newIndexName: index_settings_1.generateNewIndexName(indexName),
                status: types_1.ReindexStatus.inProgress,
                lastCompletedStep: types_1.ReindexStep.created,
                locked: null,
                reindexTaskId: null,
                reindexTaskPercComplete: null,
                errorMessage: null,
                runningReindexCount: null,
            });
        },
        deleteReindexOp(reindexOp) {
            return client.delete(types_1.REINDEX_OP_TYPE, reindexOp.id);
        },
        async updateReindexOp(reindexOp, attrs = {}) {
            if (!isLocked(reindexOp)) {
                throw new Error(`ReindexOperation must be locked before updating.`);
            }
            const newAttrs = { ...reindexOp.attributes, locked: moment_1.default().format(), ...attrs };
            return client.update(types_1.REINDEX_OP_TYPE, reindexOp.id, newAttrs, {
                version: reindexOp.version,
            });
        },
        async runWhileLocked(reindexOp, func) {
            reindexOp = await acquireLock(reindexOp);
            try {
                reindexOp = await func(reindexOp);
            }
            finally {
                reindexOp = await releaseLock(reindexOp);
            }
            return reindexOp;
        },
        findReindexOperations(indexName) {
            return client.find({
                type: types_1.REINDEX_OP_TYPE,
                search: `"${indexName}"`,
                searchFields: ['indexName'],
            });
        },
        async findAllByStatus(status) {
            const firstPage = await client.find({
                type: types_1.REINDEX_OP_TYPE,
                search: status.toString(),
                searchFields: ['status'],
            });
            if (firstPage.total === firstPage.saved_objects.length) {
                return firstPage.saved_objects;
            }
            let allOps = firstPage.saved_objects;
            let page = firstPage.page + 1;
            while (allOps.length < firstPage.total) {
                const nextPage = await client.find({
                    type: types_1.REINDEX_OP_TYPE,
                    search: status.toString(),
                    searchFields: ['status'],
                    page,
                });
                allOps = [...allOps, ...nextPage.saved_objects];
                page++;
            }
            return allOps;
        },
        async getBooleanFieldPaths(indexName) {
            const results = await callCluster('indices.getMapping', {
                index: indexName,
                include_type_name: true,
            });
            const mapping = index_settings_1.getSingleMappingType(results[indexName].mappings);
            // It's possible an index doesn't have a mapping.
            return mapping && mapping.properties ? index_settings_1.findBooleanFields(mapping.properties) : [];
        },
        async getFlatSettings(indexName) {
            const flatSettings = (await callCluster('transport.request', {
                path: `/${encodeURIComponent(indexName)}?include_type_name=true&flat_settings=true`,
            }));
            if (!flatSettings[indexName]) {
                return null;
            }
            return flatSettings[indexName];
        },
        async _fetchAndLockIndexGroupDoc(indexGroup) {
            const fetchDoc = async () => {
                try {
                    // The IndexGroup enum value (a string) serves as the ID of the lock doc
                    return await client.get(types_1.REINDEX_OP_TYPE, indexGroup);
                }
                catch (e) {
                    if (e.isBoom && e.output.statusCode === 404) {
                        return await client.create(types_1.REINDEX_OP_TYPE, {
                            indexName: null,
                            newIndexName: null,
                            locked: null,
                            status: null,
                            lastCompletedStep: null,
                            reindexTaskId: null,
                            reindexTaskPercComplete: null,
                            errorMessage: null,
                            runningReindexCount: 0,
                        }, { id: indexGroup });
                    }
                    else {
                        throw e;
                    }
                }
            };
            const lockDoc = async (attempt = 1) => {
                try {
                    // Refetch the document each time to avoid version conflicts.
                    return await acquireLock(await fetchDoc());
                }
                catch (e) {
                    if (attempt >= 10) {
                        throw new Error(`Could not acquire lock for ML jobs`);
                    }
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    return lockDoc(attempt + 1);
                }
            };
            return lockDoc();
        },
        async incrementIndexGroupReindexes(indexGroup) {
            this.runWhileIndexGroupLocked(indexGroup, lockDoc => this.updateReindexOp(lockDoc, {
                runningReindexCount: lockDoc.attributes.runningReindexCount + 1,
            }));
        },
        async decrementIndexGroupReindexes(indexGroup) {
            this.runWhileIndexGroupLocked(indexGroup, lockDoc => this.updateReindexOp(lockDoc, {
                runningReindexCount: lockDoc.attributes.runningReindexCount - 1,
            }));
        },
        async runWhileIndexGroupLocked(indexGroup, func) {
            let lockDoc = await this._fetchAndLockIndexGroupDoc(indexGroup);
            try {
                lockDoc = await func(lockDoc);
            }
            finally {
                await releaseLock(lockDoc);
            }
        },
    };
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL2hvbWUvYW50aG9ueS9naXRfd29ya3NwYWNlcy9raWJhbmEveC1wYWNrL3BsdWdpbnMvdXBncmFkZV9hc3Npc3RhbnQvc2VydmVyL2xpYi9yZWluZGV4aW5nL3JlaW5kZXhfYWN0aW9ucy50cyIsInNvdXJjZXMiOlsiL2hvbWUvYW50aG9ueS9naXRfd29ya3NwYWNlcy9raWJhbmEveC1wYWNrL3BsdWdpbnMvdXBncmFkZV9hc3Npc3RhbnQvc2VydmVyL2xpYi9yZWluZGV4aW5nL3JlaW5kZXhfYWN0aW9ucy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7R0FJRzs7O0FBRUgsNERBQTRCO0FBTzVCLGlEQU8rQjtBQUMvQixxREFBaUc7QUFHakcsOENBQThDO0FBQ2pDLFFBQUEsV0FBVyxHQUFHLGdCQUFNLENBQUMsUUFBUSxDQUFDLEVBQUUsRUFBRSxTQUFTLENBQUMsQ0FBQztBQStGN0MsUUFBQSxxQkFBcUIsR0FBRyxDQUNuQyxNQUEwQixFQUMxQixXQUF3QixFQUNSLEVBQUU7SUFDbEIsMkJBQTJCO0lBQzNCLE1BQU0sUUFBUSxHQUFHLENBQUMsU0FBNkIsRUFBRSxFQUFFO1FBQ2pELElBQUksU0FBUyxDQUFDLFVBQVUsQ0FBQyxNQUFNLEVBQUU7WUFDL0IsTUFBTSxHQUFHLEdBQUcsZ0JBQU0sRUFBRSxDQUFDO1lBQ3JCLE1BQU0sVUFBVSxHQUFHLGdCQUFNLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUN2RCx1R0FBdUc7WUFDdkcsSUFBSSxHQUFHLENBQUMsUUFBUSxDQUFDLG1CQUFXLENBQUMsR0FBRyxVQUFVLEVBQUU7Z0JBQzFDLE9BQU8sSUFBSSxDQUFDO2FBQ2I7U0FDRjtRQUVELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQyxDQUFDO0lBRUYsTUFBTSxXQUFXLEdBQUcsS0FBSyxFQUFFLFNBQTZCLEVBQUUsRUFBRTtRQUMxRCxJQUFJLFFBQVEsQ0FBQyxTQUFTLENBQUMsRUFBRTtZQUN2QixNQUFN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RUQsS0FBSyxDQUFDLHdCQUF3QixDQUFDLFVBQVUsRUFBRSxJQUFJO1lBQzdDLElBQUksT0FBTyxHQUFHLE1BQU0sSUFBSSxDQUFDLDBCQUEwQixDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBRWhFLElBQUk7Z0JBQ0YsT0FBTyxHQUFHLE1BQU0sSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO2FBQy9CO29CQUFTO2dCQUNSLE1BQU0sV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDO2FBQzVCO1FBQ0gsQ0FBQztLQUNGLENBQUM7QUFDSixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQ29weXJpZ2h0IEVsYXN0aWNzZWFyY2ggQi5WLiBhbmQvb3IgbGljZW5zZWQgdG8gRWxhc3RpY3NlYXJjaCBCLlYuIHVuZGVyIG9uZVxuICogb3IgbW9yZSBjb250cmlidXRvciBsaWNlbnNlIGFncmVlbWVudHMuIExpY2Vuc2VkIHVuZGVyIHRoZSBFbGFzdGljIExpY2Vuc2U7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIEVsYXN0aWMgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgbW9tZW50IGZyb20gJ21vbWVudCc7XG5cbmltcG9ydCB7IENhbGxDbHVzdGVyIH0gZnJvbSAnc3JjL2xlZ2FjeS9jb3JlX3BsdWdpbnMvZWxhc3RpY3NlYXJjaCc7XG5pbXBvcnQge1xuICBGaW5kUmVzcG9uc2UsXG4gIFNhdmVkT2JqZWN0c0NsaWVudCxcbn0gZnJvbSAnc3JjL3NlcnZlci9zYXZlZF9vYmplY3RzL3NlcnZpY2Uvc2F2ZWRfb2JqZWN0c19jbGllbnQnO1xuaW1wb3J0IHtcbiAgSW5kZXhHcm91cCxcbiAgUkVJTkRFWF9PUF9UWVBFLFxuICBSZWluZGV4T3BlcmF0aW9uLFxuICBSZWluZGV4U2F2ZWRPYmplY3QsXG4gIFJlaW5kZXhTdGF0dXMsXG4gIFJlaW5kZXhTdGVwLFxufSBmcm9tICcuLi8uLi8uLi9jb21tb24vdHlwZXMnO1xuaW1wb3J0IHsgZmluZEJvb2xlYW5GaWVsZHMsIGdlbmVyYXRlTmV3SW5kZXhOYW1lLCBnZXRTaW5nbGVNYXBwaW5nVHlwZSB9IGZyb20gJy4vaW5kZXhfc2V0dGluZ3MnO1xuaW1wb3J0IHsgRmxhdFNldHRpbmdzIH0gZnJvbSAnLi90eXBlcyc7XG5cbi8vIFRPRE86IGJhc2Ugb24gZWxhc3RpY3NlYXJjaC5yZXF1ZXN0VGltZW91dD9cbmV4cG9ydCBjb25zdCBMT0NLX1dJTkRPVyA9IG1vbWVudC5kdXJhdGlvbig5MCwgJ3NlY29uZHMnKTtcblxuLyoqXG4gKiBBIGNvbGxlY3Rpb24gb2YgdXRpbGl0eSBmdW5jdGlvbnMgcHVsbGVkIG91dCBvdXQgb2YgdGhlIFJlaW5kZXhTZXJ2aWNlIHRvIG1ha2UgdGVzdGluZyBzaW1wbGVyLlxuICogVGhpcyBpcyBOT1QgaW50ZW5kZWQgdG8gYmUgdXNlZCBieSBhbnkgb3RoZXIgY29kZS5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBSZWluZGV4QWN0aW9ucyB7XG4gIC8qKlxuICAgKiBOYW1lc3BhY2UgZm9yIE1MLXNwZWNpZmljIGFjdGlvbnMuXG4gICAqL1xuICAvLyBtbDogTWxBY3Rpb25zO1xuXG4gIC8qKlxuICAgKiBDcmVhdGVzIGEgbmV3IHJlaW5kZXhPcCwgZG9lcyBub3QgcGVyZm9ybSBhbnkgcHJlLWZsaWdodCBjaGVja3MuXG4gICAqIEBwYXJhbSBpbmRleE5hbWVcbiAgICovXG4gIGNyZWF0ZVJlaW5kZXhPcChpbmRleE5hbWU6IHN0cmluZyk6IFByb21pc2U8UmVpbmRleFNhdmVkT2JqZWN0PjtcblxuICAvKipcbiAgICogRGVsZXRlcyBhIHJlaW5kZXhPcC5cbiAgICogQHBhcmFtIHJlaW5kZXhPcFxuICAgKi9cbiAgZGVsZXRlUmVpbmRleE9wKHJlaW5kZXhPcDogUmVpbmRleFNhdmVkT2JqZWN0KTogdm9pZDtcblxuICAvKipcbiAgICogVXBkYXRlcyBhIFJlaW5kZXhTYXZlZE9iamVjdC5cbiAgICogQHBhcmFtIHJlaW5kZXhPcFxuICAgKiBAcGFyYW0gYXR0cnNcbiAgICovXG4gIHVwZGF0ZVJlaW5kZXhPcChcbiAgICByZWluZGV4T3A6IFJlaW5kZXhTYXZlZE9iamVjdCxcbiAgICBhdHRycz86IFBhcnRpYWw8UmVpbmRleE9wZXJhdGlvbj5cbiAgKTogUHJvbWlzZTxSZWluZGV4U2F2ZWRPYmplY3Q+O1xuXG4gIC8qKlxuICAgKiBSdW5zIGEgY2FsbGJhY2sgZnVuY3Rpb24gd2hpbGUgbG9ja2luZyB0aGUgcmVpbmRleCBvcGVyYXRpb24uIEd1YXJhbnRlZWQgdG8gdW5sb2NrIHRoZSByZWluZGV4IG9wZXJhdGlvbiB3aGVuIGNvbXBsZXRlLlxuICAgKiBAcGFyYW0gZnVuYyBBIGZ1bmN0aW9uIHRvIHJ1biB3aXRoIHRoZSBsb2NrZWQgTUwgbG9jayBkb2N1bWVudC4gTXVzdCByZXR1cm4gYSBwcm9taXNlIHRoYXQgcmVzb2x2ZXNcbiAgICogdG8gdGhlIHVwZGF0ZWQgUmVpbmRleFNhdmVkT2JqZWN0LlxuICAgKi9cbiAgcnVuV2hpbGVMb2NrZWQoXG4gICAgcmVpbmRleE9wOiBSZWluZGV4U2F2ZWRPYmplY3QsXG4gICAgZnVuYzogKHJlaW5kZXhPcDogUmVpbmRleFNhdmVkT2JqZWN0KSA9PiBQcm9taXNlPFJlaW5kZXhTYXZlZE9iamVjdD5cbiAgKTogUHJvbWlzZTxSZWluZGV4U2F2ZWRPYmplY3Q+O1xuXG4gIC8qKlxuICAgKiBGaW5kcyB0aGUgcmVpbmRleCBvcGVyYXRpb24gc2F2ZWQgb2JqZWN0IGZvciB0aGUgZ2l2ZW4gaW5kZXguXG4gICAqIEBwYXJhbSBpbmRleE5hbWVcbiAgICovXG4gIGZpbmRSZWluZGV4T3BlcmF0aW9ucyhpbmRleE5hbWU6IHN0cmluZyk6IFByb21pc2U8RmluZFJlc3BvbnNlPFJlaW5kZXhPcGVyYXRpb24+PjtcblxuICAvKipcbiAgICogUmV0dXJucyBhbiBhcnJheSBvZiBhbGwgcmVpbmRleCBvcGVyYXRpb25zIHRoYXQgaGF2ZSBhIHN0YXR1cy5cbiAgICovXG4gIGZpbmRBbGxCeVN0YXR1cyhzdGF0dXM6IFJlaW5kZXhTdGF0dXMpOiBQcm9taXNlPFJlaW5kZXhTYXZlZE9iamVjdFtdPjtcblxuICAvKipcbiAgICogUmV0dXJucyBhcnJheSBvZiBmaWVsZCBwYXRocyB0byBib29sZWFuIGZpZWxkcyBpbiB0aGUgaW5kZXgncyBtYXBwaW5nLlxuICAgKiBAcGFyYW0gaW5kZXhOYW1lXG4gICAqL1xuICBnZXRCb29sZWFuRmllbGRQYXRocyhpbmRleE5hbWU6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nW11bXT47XG5cbiAgLyoqXG4gICAqIFJldHJpZXZlIGluZGV4IHNldHRpbmdzIChpbiBmbGF0LCBkb3Qtbm90YXRpb24gc3R5bGUpIGFuZCBtYXBwaW5ncy5cbiAgICogQHBhcmFtIGluZGV4TmFtZVxuICAgKi9cbiAgZ2V0RmxhdFNldHRpbmdzKGluZGV4TmFtZTogc3RyaW5nKTogUHJvbWlzZTxGbGF0U2V0dGluZ3MgfCBudWxsPjtcblxuICAvLyAtLS0tLSBGdW5jdGlvbnMgYmVsb3cgYXJlIGZvciBlbmZvcmNpbmcgbG9ja3MgYXJvdW5kIGdyb3VwcyBvZiBpbmRpY2VzIGxpa2UgTUwgb3IgV2F0Y2hlclxuXG4gIC8qKlxuICAgKiBBdG9taWNhbGx5IGluY3JlbWVudHMgdGhlIG51bWJlciBvZiByZWluZGV4IG9wZXJhdGlvbnMgcnVubmluZyBmb3IgYW4gaW5kZXggZ3JvdXAuXG4gICAqL1xuICBpbmNyZW1lbnRJbmRleEdyb3VwUmVpbmRleGVzKGdyb3VwOiBJbmRleEdyb3VwKTogUHJvbWlzZTx2b2lkPjtcblxuICAvKipcbiAgICogQXRvbWljYWxseSBkZWNyZW1lbnRzIHRoZSBudW1iZXIgb2YgcmVpbmRleCBvcGVyYXRpb25zIHJ1bm5pbmcgZm9yIGFuIGluZGV4IGdyb3VwLlxuICAgKi9cbiAgZGVjcmVtZW50SW5kZXhHcm91cFJlaW5kZXhlcyhncm91cDogSW5kZXhHcm91cCk6IFByb21pc2U8dm9pZD47XG5cbiAgLyoqXG4gICAqIFJ1bnMgYSBjYWxsYmFjayBmdW5jdGlvbiB3aGlsZSBsb2NraW5nIGFuIGluZGV4IGdyb3VwLlxuICAgKiBAcGFyYW0gZnVuYyBBIGZ1bmN0aW9uIHRvIHJ1biB3aXRoIHRoZSBsb2NrZWQgaW5kZXggZ3JvdXAgbG9jayBkb2N1bWVudC4gTXVzdCByZXR1cm4gYSBwcm9taXNlIHRoYXQgcmVzb2x2ZXNcbiAgICogdG8gdGhlIHVwZGF0ZWQgUmVpbmRleFNhdmVkT2JqZWN0LlxuICAgKi9cbiAgcnVuV2hpbGVJbmRleEdyb3VwTG9ja2VkKFxuICAgIGdyb3VwOiBJbmRleEdyb3VwLFxuICAgIGZ1bmM6IChsb2NrRG9jOiBSZWluZGV4U2F2ZWRPYmplY3QpID0+IFByb21pc2U8UmVpbmRleFNhdmVkT2JqZWN0PlxuICApOiBQcm9taXNlPHZvaWQ+O1xuXG4gIC8qKlxuICAgKiBFeHBvc2VkIG9ubHkgZm9yIHRlc3RpbmcsIERPIE5PVCBVU0UuXG4gICAqL1xuICBfZmV0Y2hBbmRMb2NrSW5kZXhHcm91cERvYyhncm91cDogSW5kZXhHcm91cCk6IFByb21pc2U8UmVpbmRleFNhdmVkT2JqZWN0Pjtcbn1cblxuZXhwb3J0IGNvbnN0IHJlaW5kZXhBY3Rpb25zRmFjdG9yeSA9IChcbiAgY2xpZW50OiBTYXZlZE9iamVjdHNDbGllbnQsXG4gIGNhbGxDbHVzdGVyOiBDYWxsQ2x1c3RlclxuKTogUmVpbmRleEFjdGlvbnMgPT4ge1xuICAvLyAtLS0tLSBJbnRlcm5hbCBmdW5jdGlvbnNcbiAgY29uc3QgaXNMb2NrZWQgPSAocmVpbmRleE9wOiBSZWluZGV4U2F2ZWRPYmplY3QpID0+IHtcbiAgICBpZiAocmVpbmRleE9wLmF0dHJpYnV0ZXMubG9ja2VkKSB7XG4gICAgICBjb25zdCBub3cgPSBtb21lbnQoKTtcbiAgICAgIGNvbnN0IGxvY2tlZFRpbWUgPSBtb21lbnQocmVpbmRleE9wLmF0dHJpYnV0ZXMubG9ja2VkKTtcbiAgICAgIC8vIElmIHRoZSBvYmplY3QgaGFzIGJlZW4gbG9ja2VkIGZvciBtb3JlIHRoYW4gdGhlIExPQ0tfV0lORE9XLCBhc3N1bWUgdGhlIHByb2Nlc3MgdGhhdCBsb2NrZWQgaXQgZGllZC5cbiAgICAgIGlmIChub3cuc3VidHJhY3QoTE9DS19XSU5ET1cpIDwgbG9ja2VkVGltZSkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gZmFsc2U7XG4gIH07XG5cbiAgY29uc3QgYWNxdWlyZUxvY2sgPSBhc3luYyAocmVpbmRleE9wOiBSZWluZGV4U2F2ZWRPYmplY3QpID0+IHtcbiAgICBpZiAoaXNMb2NrZWQocmVpbmRleE9wKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBBbm90aGVyIEtpYmFuYSBwcm9jZXNzIGlzIGN1cnJlbnRseSBtb2RpZnlpbmcgdGhpcyByZWluZGV4IG9wZXJhdGlvbi5gKTtcbiAgICB9XG5cbiAgICByZXR1cm4gY2xpZW50LnVwZGF0ZTxSZWluZGV4T3BlcmF0aW9uPihcbiAgICAgIFJFSU5ERVhfT1BfVFlQRSxcbiAgICAgIHJlaW5kZXhPcC5pZCxcbiAgICAgIHsgLi4ucmVpbmRleE9wLmF0dHJpYnV0ZXMsIGxvY2tlZDogbW9tZW50KCkuZm9ybWF0KCkgfSxcbiAgICAgIHsgdmVyc2lvbjogcmVpbmRleE9wLnZlcnNpb24gfVxuICAgICk7XG4gIH07XG5cbiAgY29uc3QgcmVsZWFzZUxvY2sgPSAocmVpbmRleE9wOiBSZWluZGV4U2F2ZWRPYmplY3QpID0+IHtcbiAgICByZXR1cm4gY2xpZW50LnVwZGF0ZTxSZWluZGV4T3BlcmF0aW9uPihcbiAgICAgIFJFSU5ERVhfT1BfVFlQRSxcbiAgICAgIHJlaW5kZXhPcC5pZCxcbiAgICAgIHsgLi4ucmVpbmRleE9wLmF0dHJpYnV0ZXMsIGxvY2tlZDogbnVsbCB9LFxuICAgICAgeyB2ZXJzaW9uOiByZWluZGV4T3AudmVyc2lvbiB9XG4gICAgKTtcbiAgfTtcblxuICAvLyAtLS0tLSBQdWJsaWMgaW50ZXJmYWNlXG4gIHJldHVybiB7XG4gICAgYXN5bmMgY3JlYXRlUmVpbmRleE9wKGluZGV4TmFtZTogc3RyaW5nKSB7XG4gICAgICByZXR1cm4gY2xpZW50LmNyZWF0ZTxSZWluZGV4T3BlcmF0aW9uPihSRUlOREVYX09QX1RZUEUsIHtcbiAgICAgICAgaW5kZXhOYW1lLFxuICAgICAgICBuZXdJbmRleE5hbWU6IGdlbmVyYXRlTmV3SW5kZXhOYW1lKGluZGV4TmFtZSksXG4gICAgICAgIHN0YXR1czogUmVpbmRleFN0YXR1cy5pblByb2dyZXNzLFxuICAgICAgICBsYXN0Q29tcGxldGVkU3RlcDogUmVpbmRleFN0ZXAuY3JlYXRlZCxcbiAgICAgICAgbG9ja2VkOiBudWxsLFxuICAgICAgICByZWluZGV4VGFza0lkOiBudWxsLFxuICAgICAgICByZWluZGV4VGFza1BlcmNDb21wbGV0ZTogbnVsbCxcbiAgICAgICAgZXJyb3JNZXNzYWdlOiBudWxsLFxuICAgICAgICBydW5uaW5nUmVpbmRleENvdW50OiBudWxsLFxuICAgICAgfSk7XG4gICAgfSxcblxuICAgIGRlbGV0ZVJlaW5kZXhPcChyZWluZGV4T3A6IFJlaW5kZXhTYXZlZE9iamVjdCkge1xuICAgICAgcmV0dXJuIGNsaWVudC5kZWxldGUoUkVJTkRFWF9PUF9UWVBFLCByZWluZGV4T3AuaWQpO1xuICAgIH0sXG5cbiAgICBhc3luYyB1cGRhdGVSZWluZGV4T3AocmVpbmRleE9wOiBSZWluZGV4U2F2ZWRPYmplY3QsIGF0dHJzOiBQYXJ0aWFsPFJlaW5kZXhPcGVyYXRpb24+ID0ge30pIHtcbiAgICAgIGlmICghaXNMb2NrZWQocmVpbmRleE9wKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFJlaW5kZXhPcGVyYXRpb24gbXVzdCBiZSBsb2NrZWQgYmVmb3JlIHVwZGF0aW5nLmApO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBuZXdBdHRycyA9IHsgLi4ucmVpbmRleE9wLmF0dHJpYnV0ZXMsIGxvY2tlZDogbW9tZW50KCkuZm9ybWF0KCksIC4uLmF0dHJzIH07XG4gICAgICByZXR1cm4gY2xpZW50LnVwZGF0ZTxSZWluZGV4T3BlcmF0aW9uPihSRUlOREVYX09QX1RZUEUsIHJlaW5kZXhPcC5pZCwgbmV3QXR0cnMsIHtcbiAgICAgICAgdmVyc2lvbjogcmVpbmRleE9wLnZlcnNpb24sXG4gICAgICB9KTtcbiAgICB9LFxuXG4gICAgYXN5bmMgcnVuV2hpbGVMb2NrZWQocmVpbmRleE9wLCBmdW5jKSB7XG4gICAgICByZWluZGV4T3AgPSBhd2FpdCBhY3F1aXJlTG9jayhyZWluZGV4T3ApO1xuXG4gICAgICB0cnkge1xuICAgICAgICByZWluZGV4T3AgPSBhd2FpdCBmdW5jKHJlaW5kZXhPcCk7XG4gICAgICB9IGZpbmFsbHkge1xuICAgICAgICByZWluZGV4T3AgPSBhd2FpdCByZWxlYXNlTG9jayhyZWluZGV4T3ApO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gcmVpbmRleE9wO1xuICAgIH0sXG5cbiAgICBmaW5kUmVpbmRleE9wZXJhdGlvbnMoaW5kZXhOYW1lOiBzdHJpbmcpIHtcbiAgICAgIHJldHVybiBjbGllbnQuZmluZDxSZWluZGV4T3BlcmF0aW9uPih7XG4gICAgICAgIHR5cGU6IFJFSU5ERVhfT1BfVFlQRSxcbiAgICAgICAgc2VhcmNoOiBgXCIke2luZGV4TmFtZX1cImAsXG4gICAgICAgIHNlYXJjaEZpZWxkczogWydpbmRleE5hbWUnXSxcbiAgICAgIH0pO1xuICAgIH0sXG5cbiAgICBhc3luYyBmaW5kQWxsQnlTdGF0dXMoc3RhdHVzOiBSZWluZGV4U3RhdHVzKSB7XG4gICAgICBjb25zdCBmaXJzdFBhZ2UgPSBhd2FpdCBjbGllbnQuZmluZDxSZWluZGV4T3BlcmF0aW9uPih7XG4gICAgICAgIHR5cGU6IFJFSU5ERVhfT1BfVFlQRSxcbiAgICAgICAgc2VhcmNoOiBzdGF0dXMudG9TdHJpbmcoKSxcbiAgICAgICAgc2VhcmNoRmllbGRzOiBbJ3N0YXR1cyddLFxuICAgICAgfSk7XG5cbiAgICAgIGlmIChmaXJzdFBhZ2UudG90YWwgPT09IGZpcnN0UGFnZS5zYXZlZF9vYmplY3RzLmxlbmd0aCkge1xuICAgICAgICByZXR1cm4gZmlyc3RQYWdlLnNhdmVkX29iamVjdHM7XG4gICAgICB9XG5cbiAgICAgIGxldCBhbGxPcHMgPSBmaXJzdFBhZ2Uuc2F2ZWRfb2JqZWN0cztcbiAgICAgIGxldCBwYWdlID0gZmlyc3RQYWdlLnBhZ2UgKyAxO1xuXG4gICAgICB3aGlsZSAoYWxsT3BzLmxlbmd0aCA8IGZpcnN0UGFnZS50b3RhbCkge1xuICAgICAgICBjb25zdCBuZXh0UGFnZSA9IGF3YWl0IGNsaWVudC5maW5kPFJlaW5kZXhPcGVyYXRpb24+KHtcbiAgICAgICAgICB0eXBlOiBSRUlOREVYX09QX1RZUEUsXG4gICAgICAgICAgc2VhcmNoOiBzdGF0dXMudG9TdHJpbmcoKSxcbiAgICAgICAgICBzZWFyY2hGaWVsZHM6IFsnc3RhdHVzJ10sXG4gICAgICAgICAgcGFnZSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgYWxsT3BzID0gWy4uLmFsbE9wcywgLi4ubmV4dFBhZ2Uuc2F2ZWRfb2JqZWN0c107XG4gICAgICAgIHBhZ2UrKztcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGFsbE9wcztcbiAgICB9LFxuXG4gICAgYXN5bmMgZ2V0Qm9vbGVhbkZpZWxkUGF0aHMoaW5kZXhOYW1lOiBzdHJpbmcpIHtcbiAgICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCBjYWxsQ2x1c3RlcignaW5kaWNlcy5nZXRNYXBwaW5nJywge1xuICAgICAgICBpbmRleDogaW5kZXhOYW1lLFxuICAgICAgICBpbmNsdWRlX3R5cGVfbmFtZTogdHJ1ZSxcbiAgICAgIH0pO1xuICAgICAgY29uc3QgbWFwcGluZyA9IGdldFNpbmdsZU1hcHBpbmdUeXBlKHJlc3VsdHNbaW5kZXhOYW1lXS5tYXBwaW5ncyk7XG5cbiAgICAgIC8vIEl0J3MgcG9zc2libGUgYW4gaW5kZXggZG9lc24ndCBoYXZlIGEgbWFwcGluZy5cbiAgICAgIHJldHVybiBtYXBwaW5nICYmIG1hcHBpbmcucHJvcGVydGllcyA/IGZpbmRCb29sZWFuRmllbGRzKG1hcHBpbmcucHJvcGVydGllcykgOiBbXTtcbiAgICB9LFxuXG4gICAgYXN5bmMgZ2V0RmxhdFNldHRpbmdzKGluZGV4TmFtZTogc3RyaW5nKSB7XG4gICAgICBjb25zdCBmbGF0U2V0dGluZ3MgPSAoYXdhaXQgY2FsbENsdXN0ZXIoJ3RyYW5zcG9ydC5yZXF1ZXN0Jywge1xuICAgICAgICBwYXRoOiBgLyR7ZW5jb2RlVVJJQ29tcG9uZW50KGluZGV4TmFtZSl9P2luY2x1ZGVfdHlwZV9uYW1lPXRydWUmZmxhdF9zZXR0aW5ncz10cnVlYCxcbiAgICAgIH0pKSBhcyB7IFtpbmRleE5hbWU6IHN0cmluZ106IEZsYXRTZXR0aW5ncyB9O1xuXG4gICAgICBpZiAoIWZsYXRTZXR0aW5nc1tpbmRleE5hbWVdKSB7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gZmxhdFNldHRpbmdzW2luZGV4TmFtZV07XG4gICAgfSxcblxuICAgIGFzeW5jIF9mZXRjaEFuZExvY2tJbmRleEdyb3VwRG9jKGluZGV4R3JvdXApIHtcbiAgICAgIGNvbnN0IGZldGNoRG9jID0gYXN5bmMgKCkgPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIC8vIFRoZSBJbmRleEdyb3VwIGVudW0gdmFsdWUgKGEgc3RyaW5nKSBzZXJ2ZXMgYXMgdGhlIElEIG9mIHRoZSBsb2NrIGRvY1xuICAgICAgICAgIHJldHVybiBhd2FpdCBjbGllbnQuZ2V0PFJlaW5kZXhPcGVyYXRpb24+KFJFSU5ERVhfT1BfVFlQRSwgaW5kZXhHcm91cCk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICBpZiAoZS5pc0Jvb20gJiYgZS5vdXRwdXQuc3RhdHVzQ29kZSA9PT0gNDA0KSB7XG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgY2xpZW50LmNyZWF0ZTxSZWluZGV4T3BlcmF0aW9uPihcbiAgICAgICAgICAgICAgUkVJTkRFWF9PUF9UWVBFLFxuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgaW5kZXhOYW1lOiBudWxsLFxuICAgICAgICAgICAgICAgIG5ld0luZGV4TmFtZTogbnVsbCxcbiAgICAgICAgICAgICAgICBsb2NrZWQ6IG51bGwsXG4gICAgICAgICAgICAgICAgc3RhdHVzOiBudWxsLFxuICAgICAgICAgICAgICAgIGxhc3RDb21wbGV0ZWRTdGVwOiBudWxsLFxuICAgICAgICAgICAgICAgIHJlaW5kZXhUYXNrSWQ6IG51bGwsXG4gICAgICAgICAgICAgICAgcmVpbmRleFRhc2tQZXJjQ29tcGxldGU6IG51bGwsXG4gICAgICAgICAgICAgICAgZXJyb3JNZXNzYWdlOiBudWxsLFxuICAgICAgICAgICAgICAgIHJ1bm5pbmdSZWluZGV4Q291bnQ6IDAsXG4gICAgICAgICAgICAgIH0gYXMgYW55LFxuICAgICAgICAgICAgICB7IGlkOiBpbmRleEdyb3VwIH1cbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRocm93IGU7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9O1xuXG4gICAgICBjb25zdCBsb2NrRG9jID0gYXN5bmMgKGF0dGVtcHQgPSAxKTogUHJvbWlzZTxSZWluZGV4U2F2ZWRPYmplY3Q+ID0+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAvLyBSZWZldGNoIHRoZSBkb2N1bWVudCBlYWNoIHRpbWUgdG8gYXZvaWQgdmVyc2lvbiBjb25mbGljdHMuXG4gICAgICAgICAgcmV0dXJuIGF3YWl0IGFjcXVpcmVMb2NrKGF3YWl0IGZldGNoRG9jKCkpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgaWYgKGF0dGVtcHQgPj0gMTApIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IGFjcXVpcmUgbG9jayBmb3IgTUwgam9ic2ApO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCAxMDAwKSk7XG4gICAgICAgICAgcmV0dXJuIGxvY2tEb2MoYXR0ZW1wdCArIDEpO1xuICAgICAgICB9XG4gICAgICB9O1xuXG4gICAgICByZXR1cm4gbG9ja0RvYygpO1xuICAgIH0sXG5cbiAgICBhc3luYyBpbmNyZW1lbnRJbmRleEdyb3VwUmVpbmRleGVzKGluZGV4R3JvdXApIHtcbiAgICAgIHRoaXMucnVuV2hpbGVJbmRleEdyb3VwTG9ja2VkKGluZGV4R3JvdXAsIGxvY2tEb2MgPT5cbiAgICAgICAgdGhpcy51cGRhdGVSZWluZGV4T3AobG9ja0RvYywge1xuICAgICAgICAgIHJ1bm5pbmdSZWluZGV4Q291bnQ6IGxvY2tEb2MuYXR0cmlidXRlcy5ydW5uaW5nUmVpbmRleENvdW50ISArIDEsXG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH0sXG5cbiAgICBhc3luYyBkZWNyZW1lbnRJbmRleEdyb3VwUmVpbmRleGVzKGluZGV4R3JvdXApIHtcbiAgICAgIHRoaXMucnVuV2hpbGVJbmRleEdyb3VwTG9ja2VkKGluZGV4R3JvdXAsIGxvY2tEb2MgPT5cbiAgICAgICAgdGhpcy51cGRhdGVSZWluZGV4T3AobG9ja0RvYywge1xuICAgICAgICAgIHJ1bm5pbmdSZWluZGV4Q291bnQ6IGxvY2tEb2MuYXR0cmlidXRlcy5ydW5uaW5nUmVpbmRleENvdW50ISAtIDEsXG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH0sXG5cbiAgICBhc3luYyBydW5XaGlsZUluZGV4R3JvdXBMb2NrZWQoaW5kZXhHcm91cCwgZnVuYykge1xuICAgICAgbGV0IGxvY2tEb2MgPSBhd2FpdCB0aGlzLl9mZXRjaEFuZExvY2tJbmRleEdyb3VwRG9jKGluZGV4R3JvdXApO1xuXG4gICAgICB0cnkge1xuICAgICAgICBsb2NrRG9jID0gYXdhaXQgZnVuYyhsb2NrRG9jKTtcbiAgICAgIH0gZmluYWxseSB7XG4gICAgICAgIGF3YWl0IHJlbGVhc2VMb2NrKGxvY2tEb2MpO1xuICAgICAgfVxuICAgIH0sXG4gIH07XG59O1xuIl19