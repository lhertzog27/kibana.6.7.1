"use strict";
/*
 * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
 * or more contributor license agreements. Licensed under the Elastic License;
 * you may not use this file except in compliance with the Elastic License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const json_stable_stringify_1 = tslib_1.__importDefault(require("json-stable-stringify"));
function compileFormattingRules(rules) {
    const compiledRules = rules.map(compileRule);
    return {
        requiredFields: Array.from(new Set(compiledRules.reduce((combinedRequiredFields, { requiredFields }) => [
            ...combinedRequiredFields,
            ...requiredFields,
        ], []))),
        format: (fields) => {
            for (const compiledRule of compiledRules) {
                if (compiledRule.fulfillsCondition(fields)) {
                    return compiledRule.format(fields);
                }
            }
            return [];
        },
    };
}
exports.compileFormattingRules = compileFormattingRules;
const compileRule = (rule) => {
    const { conditionFields, fulfillsCondition } = compileCondition(rule.when);
    const { formattingFields, format } = compileFormattingInstructions(rule.format);
    return {
        requiredFields: [...conditionFields, ...formattingFields],
        fulfillsCondition,
        format,
    };
};
const compileCondition = (condition) => [compileExistsCondition, compileFieldValueCondition].reduce((compiledCondition, compile) => compile(condition) || compiledCondition, catchAllCondition);
const catchAllCondition = {
    conditionFields: [],
    fulfillsCondition: (fields) => false,
};
const compileExistsCondition = (condition) => 'exists' in condition
    ? {
        conditionFields: condition.exists,
        fulfillsCondition: (fields) => condition.exists.every(fieldName => fieldName in fields),
    }
    : null;
const compileFieldValueCondition = (condition) => 'values' in condition
    ? {
        conditionFields: Object.keys(condition.values),
        fulfillsCondition: (fields) => Object.entries(condition.values).every(([fieldName, expectedValue]) => fields[fieldName] === expectedValue),
    }
    : null;
const compileFormattingInstructions = (formattingInstructions) => formattingInstructions.reduce((combinedFormattingInstructions, formattingInstruction) => {
    const compiledFormattingInstruction = compileFormattingInstruction(formattingInstruction);
    return {
        formattingFields: [
            ...combinedFormattingInstructions.formattingFields,
            ...compiledFormattingInstruction.formattingFields,
        ],
        format: (fields) => [
            ...combinedFormattingInstructions.format(fields),
            ...compiledFormattingInstruction.format(fields),
        ],
    };
}, {
    formattingFields: [],
    format: (fields) => [],
});
const compileFormattingInstruction = (formattingInstruction) => [compileFieldReferenceFormattingInstruction, compileConstantFormattingInstruction].reduce((compiledFormattingInstruction, compile) => compile(formattingInstruction) || compiledFormattingInstruction, catchAllFormattingInstruction);
const catchAllFormattingInstruction = {
    formattingFields: [],
    format: (fields) => [
        {
            constant: 'invalid format',
        },
    ],
};
const compileFieldReferenceFormattingInstruction = (formattingInstruction) => 'field' in formattingInstruction
    ? {
        formattingFields: [formattingInstruction.field],
        format: (fields) => {
            const value = fields[formattingInstruction.field];
            return [
                {
                    field: formattingInstruction.field,
                    value: typeof value === 'object' ? json_stable_stringify_1.default(value) : `${value}`,
                    highlights: [],
                },
            ];
        },
    }
    : null;
const compileConstantFormattingInstruction = (formattingInstruction) => 'constant' in formattingInstruction
    ? {
        formattingFields: [],
        format: (fields) => [
            {
                constant: formattingInstruction.constant,
            },
        ],
    }
    : null;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL2hvbWUvYW50aG9ueS9naXRfd29ya3NwYWNlcy9raWJhbmEveC1wYWNrL3BsdWdpbnMvaW5mcmEvc2VydmVyL2xpYi9kb21haW5zL2xvZ19lbnRyaWVzX2RvbWFpbi9tZXNzYWdlLnRzIiwic291cmNlcyI6WyIvaG9tZS9hbnRob255L2dpdF93b3Jrc3BhY2VzL2tpYmFuYS94LXBhY2svcGx1Z2lucy9pbmZyYS9zZXJ2ZXIvbGliL2RvbWFpbnMvbG9nX2VudHJpZXNfZG9tYWluL21lc3NhZ2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7O0dBSUc7OztBQUVILDBGQUE4QztBQVM5QyxTQUFnQixzQkFBc0IsQ0FBQyxLQUFpQztJQUN0RSxNQUFNLGFBQWEsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBRTdDLE9BQU87UUFDTCxjQUFjLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FDeEIsSUFBSSxHQUFHLENBQ0wsYUFBYSxDQUFDLE1BQU0sQ0FDbEIsQ0FBQyxzQkFBc0IsRUFBRSxFQUFFLGNBQWMsRUFBRSxFQUFFLEVBQUUsQ0FBQztZQUM5QyxHQUFHLHNCQUFzQjtZQUN6QixHQUFHLGNBQWM7U0FDbEIsRUFDRCxFQUFjLENBQ2YsQ0FDRixDQUNGO1FBQ0QsTUFBTSxFQUFFLENBQUMsTUFBYyxFQUE0QixFQUFFO1lBQ25ELEtBQUssTUFBTSxZQUFZLElBQUksYUFBYSxFQUFFO2dCQUN4QyxJQUFJLFlBQVksQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsRUFBRTtvQkFDMUMsT0FBTyxZQUFZLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2lCQUNwQzthQUNGO1lBRUQsT0FBTyxFQUFFLENBQUM7UUFDWixDQUFDO0tBQ0YsQ0FBQztBQUNKLENBQUM7QUF6QkQsd0RBeUJDO0FBRUQsTUFBTSxXQUFXLEdBQUcsQ0FBQyxJQUE4QixFQUFvQyxFQUFFO0lBQ3ZGLE1BQU0sRUFBRSxlQUFlLEVBQUUsaUJBQWlCLEVB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bnNlZCB0byBFbGFzdGljc2VhcmNoIEIuVi4gdW5kZXIgb25lXG4gKiBvciBtb3JlIGNvbnRyaWJ1dG9yIGxpY2Vuc2UgYWdyZWVtZW50cy4gTGljZW5zZWQgdW5kZXIgdGhlIEVsYXN0aWMgTGljZW5zZTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgRWxhc3RpYyBMaWNlbnNlLlxuICovXG5cbmltcG9ydCBzdHJpbmdpZnkgZnJvbSAnanNvbi1zdGFibGUtc3RyaW5naWZ5JztcblxuaW1wb3J0IHsgSW5mcmFMb2dNZXNzYWdlU2VnbWVudCB9IGZyb20gJy4uLy4uLy4uL2dyYXBocWwvdHlwZXMnO1xuaW1wb3J0IHtcbiAgTG9nTWVzc2FnZUZvcm1hdHRpbmdDb25kaXRpb24sXG4gIExvZ01lc3NhZ2VGb3JtYXR0aW5nSW5zdHJ1Y3Rpb24sXG4gIExvZ01lc3NhZ2VGb3JtYXR0aW5nUnVsZSxcbn0gZnJvbSAnLi9ydWxlX3R5cGVzJztcblxuZXhwb3J0IGZ1bmN0aW9uIGNvbXBpbGVGb3JtYXR0aW5nUnVsZXMocnVsZXM6IExvZ01lc3NhZ2VGb3JtYXR0aW5nUnVsZVtdKSB7XG4gIGNvbnN0IGNvbXBpbGVkUnVsZXMgPSBydWxlcy5tYXAoY29tcGlsZVJ1bGUpO1xuXG4gIHJldHVybiB7XG4gICAgcmVxdWlyZWRGaWVsZHM6IEFycmF5LmZyb20oXG4gICAgICBuZXcgU2V0KFxuICAgICAgICBjb21waWxlZFJ1bGVzLnJlZHVjZShcbiAgICAgICAgICAoY29tYmluZWRSZXF1aXJlZEZpZWxkcywgeyByZXF1aXJlZEZpZWxkcyB9KSA9PiBbXG4gICAgICAgICAgICAuLi5jb21iaW5lZFJlcXVpcmVkRmllbGRzLFxuICAgICAgICAgICAgLi4ucmVxdWlyZWRGaWVsZHMsXG4gICAgICAgICAgXSxcbiAgICAgICAgICBbXSBhcyBzdHJpbmdbXVxuICAgICAgICApXG4gICAgICApXG4gICAgKSxcbiAgICBmb3JtYXQ6IChmaWVsZHM6IEZpZWxkcyk6IEluZnJhTG9nTWVzc2FnZVNlZ21lbnRbXSA9PiB7XG4gICAgICBmb3IgKGNvbnN0IGNvbXBpbGVkUnVsZSBvZiBjb21waWxlZFJ1bGVzKSB7XG4gICAgICAgIGlmIChjb21waWxlZFJ1bGUuZnVsZmlsbHNDb25kaXRpb24oZmllbGRzKSkge1xuICAgICAgICAgIHJldHVybiBjb21waWxlZFJ1bGUuZm9ybWF0KGZpZWxkcyk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgcmV0dXJuIFtdO1xuICAgIH0sXG4gIH07XG59XG5cbmNvbnN0IGNvbXBpbGVSdWxlID0gKHJ1bGU6IExvZ01lc3NhZ2VGb3JtYXR0aW5nUnVsZSk6IENvbXBpbGVkTG9nTWVzc2FnZUZvcm1hdHRpbmdSdWxlID0+IHtcbiAgY29uc3QgeyBjb25kaXRpb25GaWVsZHMsIGZ1bGZpbGxzQ29uZGl0aW9uIH0gPSBjb21waWxlQ29uZGl0aW9uKHJ1bGUud2hlbik7XG4gIGNvbnN0IHsgZm9ybWF0dGluZ0ZpZWxkcywgZm9ybWF0IH0gPSBjb21waWxlRm9ybWF0dGluZ0luc3RydWN0aW9ucyhydWxlLmZvcm1hdCk7XG5cbiAgcmV0dXJuIHtcbiAgICByZXF1aXJlZEZpZWxkczogWy4uLmNvbmRpdGlvbkZpZWxkcywgLi4uZm9ybWF0dGluZ0ZpZWxkc10sXG4gICAgZnVsZmlsbHNDb25kaXRpb24sXG4gICAgZm9ybWF0LFxuICB9O1xufTtcblxuY29uc3QgY29tcGlsZUNvbmRpdGlvbiA9IChcbiAgY29uZGl0aW9uOiBMb2dNZXNzYWdlRm9ybWF0dGluZ0NvbmRpdGlvblxuKTogQ29tcGlsZWRMb2dNZXNzYWdlRm9ybWF0dGluZ0NvbmRpdGlvbiA9PlxuICBbY29tcGlsZUV4aXN0c0NvbmRpdGlvbiwgY29tcGlsZUZpZWxkVmFsdWVDb25kaXRpb25dLnJlZHVjZShcbiAgICAoY29tcGlsZWRDb25kaXRpb24sIGNvbXBpbGUpID0+IGNvbXBpbGUoY29uZGl0aW9uKSB8fCBjb21waWxlZENvbmRpdGlvbixcbiAgICBjYXRjaEFsbENvbmRpdGlvblxuICApO1xuXG5jb25zdCBjYXRjaEFsbENvbmRpdGlvbjogQ29tcGlsZWRMb2dNZXNzYWdlRm9ybWF0dGluZ0NvbmRpdGlvbiA9IHtcbiAgY29uZGl0aW9uRmllbGRzOiBbXSBhcyBzdHJpbmdbXSxcbiAgZnVsZmlsbHNDb25kaXRpb246IChmaWVsZHM6IEZpZWxkcykgPT4gZmFsc2UsXG59O1xuXG5jb25zdCBjb21waWxlRXhpc3RzQ29uZGl0aW9uID0gKGNvbmRpdGlvbjogTG9nTWVzc2FnZUZvcm1hdHRpbmdDb25kaXRpb24pID0+XG4gICdleGlzdHMnIGluIGNvbmRpdGlvblxuICAgID8ge1xuICAgICAgICBjb25kaXRpb25GaWVsZHM6IGNvbmRpdGlvbi5leGlzdHMsXG4gICAgICAgIGZ1bGZpbGxzQ29uZGl0aW9uOiAoZmllbGRzOiBGaWVsZHMpID0+XG4gICAgICAgICAgY29uZGl0aW9uLmV4aXN0cy5ldmVyeShmaWVsZE5hbWUgPT4gZmllbGROYW1lIGluIGZpZWxkcyksXG4gICAgICB9XG4gICAgOiBudWxsO1xuXG5jb25zdCBjb21waWxlRmllbGRWYWx1ZUNvbmRpdGlvbiA9IChjb25kaXRpb246IExvZ01lc3NhZ2VGb3JtYXR0aW5nQ29uZGl0aW9uKSA9PlxuICAndmFsdWVzJyBpbiBjb25kaXRpb25cbiAgICA/IHtcbiAgICAgICAgY29uZGl0aW9uRmllbGRzOiBPYmplY3Qua2V5cyhjb25kaXRpb24udmFsdWVzKSxcbiAgICAgICAgZnVsZmlsbHNDb25kaXRpb246IChmaWVsZHM6IEZpZWxkcykgPT5cbiAgICAgICAgICBPYmplY3QuZW50cmllcyhjb25kaXRpb24udmFsdWVzKS5ldmVyeShcbiAgICAgICAgICAgIChbZmllbGROYW1lLCBleHBlY3RlZFZhbHVlXSkgPT4gZmllbGRzW2ZpZWxkTmFtZV0gPT09IGV4cGVjdGVkVmFsdWVcbiAgICAgICAgICApLFxuICAgICAgfVxuICAgIDogbnVsbDtcblxuY29uc3QgY29tcGlsZUZvcm1hdHRpbmdJbnN0cnVjdGlvbnMgPSAoXG4gIGZvcm1hdHRpbmdJbnN0cnVjdGlvbnM6IExvZ01lc3NhZ2VGb3JtYXR0aW5nSW5zdHJ1Y3Rpb25bXVxuKTogQ29tcGlsZWRMb2dNZXNzYWdlRm9ybWF0dGluZ0luc3RydWN0aW9uID0+XG4gIGZvcm1hdHRpbmdJbnN0cnVjdGlvbnMucmVkdWNlKFxuICAgIChjb21iaW5lZEZvcm1hdHRpbmdJbnN0cnVjdGlvbnMsIGZvcm1hdHRpbmdJbnN0cnVjdGlvbikgPT4ge1xuICAgICAgY29uc3QgY29tcGlsZWRGb3JtYXR0aW5nSW5zdHJ1Y3Rpb24gPSBjb21waWxlRm9ybWF0dGluZ0luc3RydWN0aW9uKGZvcm1hdHRpbmdJbnN0cnVjdGlvbik7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIGZvcm1hdHRpbmdGaWVsZHM6IFtcbiAgICAgICAgICAuLi5jb21iaW5lZEZvcm1hdHRpbmdJbnN0cnVjdGlvbnMuZm9ybWF0dGluZ0ZpZWxkcyxcbiAgICAgICAgICAuLi5jb21waWxlZEZvcm1hdHRpbmdJbnN0cnVjdGlvbi5mb3JtYXR0aW5nRmllbGRzLFxuICAgICAgICBdLFxuICAgICAgICBmb3JtYXQ6IChmaWVsZHM6IEZpZWxkcykgPT4gW1xuICAgICAgICAgIC4uLmNvbWJpbmVkRm9ybWF0dGluZ0luc3RydWN0aW9ucy5mb3JtYXQoZmllbGRzKSxcbiAgICAgICAgICAuLi5jb21waWxlZEZvcm1hdHRpbmdJbnN0cnVjdGlvbi5mb3JtYXQoZmllbGRzKSxcbiAgICAgICAgXSxcbiAgICAgIH07XG4gICAgfSxcbiAgICB7XG4gICAgICBmb3JtYXR0aW5nRmllbGRzOiBbXSxcbiAgICAgIGZvcm1hdDogKGZpZWxkczogRmllbGRzKSA9PiBbXSxcbiAgICB9IGFzIENvbXBpbGVkTG9nTWVzc2FnZUZvcm1hdHRpbmdJbnN0cnVjdGlvblxuICApO1xuXG5jb25zdCBjb21waWxlRm9ybWF0dGluZ0luc3RydWN0aW9uID0gKFxuICBmb3JtYXR0aW5nSW5zdHJ1Y3Rpb246IExvZ01lc3NhZ2VGb3JtYXR0aW5nSW5zdHJ1Y3Rpb25cbik6IENvbXBpbGVkTG9nTWVzc2FnZUZvcm1hdHRpbmdJbnN0cnVjdGlvbiA9PlxuICBbY29tcGlsZUZpZWxkUmVmZXJlbmNlRm9ybWF0dGluZ0luc3RydWN0aW9uLCBjb21waWxlQ29uc3RhbnRGb3JtYXR0aW5nSW5zdHJ1Y3Rpb25dLnJlZHVjZShcbiAgICAoY29tcGlsZWRGb3JtYXR0aW5nSW5zdHJ1Y3Rpb24sIGNvbXBpbGUpID0+XG4gICAgICBjb21waWxlKGZvcm1hdHRpbmdJbnN0cnVjdGlvbikgfHwgY29tcGlsZWRGb3JtYXR0aW5nSW5zdHJ1Y3Rpb24sXG4gICAgY2F0Y2hBbGxGb3JtYXR0aW5nSW5zdHJ1Y3Rpb25cbiAgKTtcblxuY29uc3QgY2F0Y2hBbGxGb3JtYXR0aW5nSW5zdHJ1Y3Rpb246IENvbXBpbGVkTG9nTWVzc2FnZUZvcm1hdHRpbmdJbnN0cnVjdGlvbiA9IHtcbiAgZm9ybWF0dGluZ0ZpZWxkczogW10sXG4gIGZvcm1hdDogKGZpZWxkczogRmllbGRzKSA9PiBbXG4gICAge1xuICAgICAgY29uc3RhbnQ6ICdpbnZhbGlkIGZvcm1hdCcsXG4gICAgfSxcbiAgXSxcbn07XG5cbmNvbnN0IGNvbXBpbGVGaWVsZFJlZmVyZW5jZUZvcm1hdHRpbmdJbnN0cnVjdGlvbiA9IChcbiAgZm9ybWF0dGluZ0luc3RydWN0aW9uOiBMb2dNZXNzYWdlRm9ybWF0dGluZ0luc3RydWN0aW9uXG4pOiBDb21waWxlZExvZ01lc3NhZ2VGb3JtYXR0aW5nSW5zdHJ1Y3Rpb24gfCBudWxsID0+XG4gICdmaWVsZCcgaW4gZm9ybWF0dGluZ0luc3RydWN0aW9uXG4gICAgPyB7XG4gICAgICAgIGZvcm1hdHRpbmdGaWVsZHM6IFtmb3JtYXR0aW5nSW5zdHJ1Y3Rpb24uZmllbGRdLFxuICAgICAgICBmb3JtYXQ6IChmaWVsZHM6IEZpZWxkcykgPT4ge1xuICAgICAgICAgIGNvbnN0IHZhbHVlID0gZmllbGRzW2Zvcm1hdHRpbmdJbnN0cnVjdGlvbi5maWVsZF07XG4gICAgICAgICAgcmV0dXJuIFtcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgZmllbGQ6IGZvcm1hdHRpbmdJbnN0cnVjdGlvbi5maWVsZCxcbiAgICAgICAgICAgICAgdmFsdWU6IHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcgPyBzdHJpbmdpZnkodmFsdWUpIDogYCR7dmFsdWV9YCxcbiAgICAgICAgICAgICAgaGlnaGxpZ2h0czogW10sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIF07XG4gICAgICAgIH0sXG4gICAgICB9XG4gICAgOiBudWxsO1xuXG5jb25zdCBjb21waWxlQ29uc3RhbnRGb3JtYXR0aW5nSW5zdHJ1Y3Rpb24gPSAoXG4gIGZvcm1hdHRpbmdJbnN0cnVjdGlvbjogTG9nTWVzc2FnZUZvcm1hdHRpbmdJbnN0cnVjdGlvblxuKTogQ29tcGlsZWRMb2dNZXNzYWdlRm9ybWF0dGluZ0luc3RydWN0aW9uIHwgbnVsbCA9PlxuICAnY29uc3RhbnQnIGluIGZvcm1hdHRpbmdJbnN0cnVjdGlvblxuICAgID8ge1xuICAgICAgICBmb3JtYXR0aW5nRmllbGRzOiBbXSBhcyBzdHJpbmdbXSxcbiAgICAgICAgZm9ybWF0OiAoZmllbGRzOiBGaWVsZHMpID0+IFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICBjb25zdGFudDogZm9ybWF0dGluZ0luc3RydWN0aW9uLmNvbnN0YW50LFxuICAgICAgICAgIH0sXG4gICAgICAgIF0sXG4gICAgICB9XG4gICAgOiBudWxsO1xuXG5pbnRlcmZhY2UgRmllbGRzIHtcbiAgW2ZpZWxkTmFtZTogc3RyaW5nXTogc3RyaW5nIHwgbnVtYmVyIHwgb2JqZWN0IHwgYm9vbGVhbiB8IG51bGw7XG59XG5cbmludGVyZmFjZSBDb21waWxlZExvZ01lc3NhZ2VGb3JtYXR0aW5nUnVsZSB7XG4gIHJlcXVpcmVkRmllbGRzOiBzdHJpbmdbXTtcbiAgZnVsZmlsbHNDb25kaXRpb24oZmllbGRzOiBGaWVsZHMpOiBib29sZWFuO1xuICBmb3JtYXQoZmllbGRzOiBGaWVsZHMpOiBJbmZyYUxvZ01lc3NhZ2VTZWdtZW50W107XG59XG5cbmludGVyZmFjZSBDb21waWxlZExvZ01lc3NhZ2VGb3JtYXR0aW5nQ29uZGl0aW9uIHtcbiAgY29uZGl0aW9uRmllbGRzOiBzdHJpbmdbXTtcbiAgZnVsZmlsbHNDb25kaXRpb24oZmllbGRzOiBGaWVsZHMpOiBib29sZWFuO1xufVxuXG5pbnRlcmZhY2UgQ29tcGlsZWRMb2dNZXNzYWdlRm9ybWF0dGluZ0luc3RydWN0aW9uIHtcbiAgZm9ybWF0dGluZ0ZpZWxkczogc3RyaW5nW107XG4gIGZvcm1hdChmaWVsZHM6IEZpZWxkcyk6IEluZnJhTG9nTWVzc2FnZVNlZ21lbnRbXTtcbn1cbiJdfQ==