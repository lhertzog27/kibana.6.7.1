"use strict";
/*
 * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
 * or more contributor license agreements. Licensed under the Elastic License;
 * you may not use this file except in compliance with the Elastic License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const lodash_1 = require("lodash");
const constants_1 = require("../../../../common/constants");
class ElasticsearchBeatsAdapter {
    constructor(database) {
        this.database = database;
    }
    async get(user, id) {
        const params = {
            id: `beat:${id}`,
            ignore: [404],
            index: constants_1.INDEX_NAMES.BEATS,
            type: '_doc',
        };
        const response = await this.database.get(user, params);
        if (!response.found) {
            return null;
        }
        const beat = lodash_1.get(response, '_source.beat');
        beat.tags = beat.tags || [];
        return beat;
    }
    async insert(user, beat) {
        const body = {
            beat,
            type: 'beat',
        };
        await this.database.index(user, {
            body,
            id: `beat:${beat.id}`,
            index: constants_1.INDEX_NAMES.BEATS,
            refresh: 'wait_for',
            type: '_doc',
        });
    }
    async update(user, beat) {
        const body = {
            beat,
            type: 'beat',
        };
        const params = {
            body,
            id: `beat:${beat.id}`,
            index: constants_1.INDEX_NAMES.BEATS,
            refresh: 'wait_for',
            type: '_doc',
        };
        await this.database.index(user, params);
    }
    async getWithIds(user, beatIds) {
        const ids = beatIds.map(beatId => `beat:${beatId}`);
        const params = {
            body: {
                ids,
            },
            index: constants_1.INDEX_NAMES.BEATS,
            type: '_doc',
        };
        const response = await this.database.mget(user, params);
        return lodash_1.get(response, 'docs', [])
            .filter((b) => b.found)
            .map((b) => ({ tags: [], ...b._source.beat }));
    }
    async getAllWithTags(user, tagIds) {
        const params = {
            ignore: [404],
            index: constants_1.INDEX_NAMES.BEATS,
            type: '_doc',
            body: {
                query: {
                    terms: { 'beat.tags': tagIds },
                },
            },
        };
        const response = await this.database.search(user, params);
        const beats = lodash_1.get(response, 'hits.hits', []);
        if (beats.length === 0) {
            return [];
        }
        return beats.map((beat) => ({
            tags: [],
            ...lodash_1.omit(beat._source.beat, ['access_token']),
        }));
    }
    async getBeatWithToken(user, enrollmentToken) {
        const params = {
            ignore: [404],
            index: constants_1.INDEX_NAMES.BEATS,
            type: '_doc',
            body: {
                query: {
                    match: { 'beat.enrollment_token': enrollmentToken },
                },
            },
        };
        const response = await this.database.search(user, params);
        const beats = lodash_1.get(response, 'hits.hits', []);
        if (beats.length === 0) {
            return null;
        }
        return lodash_1.omit(lodash_1.get({ tags: [], ...beats[0] }, '_source.beat'), [
            'access_token',
        ]);
    }
    async getAll(user, ESQuery) {
        const params = {
            index: constants_1.INDEX_NAMES.BEATS,
            size: 10000,
            ignore: [404],
            type: '_doc',
            body: {
                query: {
                    bool: {
                        must: {
                            term: {
                                type: 'beat',
                            },
                        },
                    },
                },
            },
        };
        if (ESQuery) {
            params.body.query = {
                ...params.body.query,
                ...ESQuery,
            };
        }
        let response;
        try {
            response = await this.database.search(user, params);
        }
        catch (e) {
            // TODO something
        }
        if (!response) {
            return [];
        }
        const beats = lodash_1.get(response, 'hits.hits', []);
        return beats.map((beat) => ({
            tags: [],
            ...lodash_1.omit(beat._source.beat, ['access_token']),
        }));
    }
    async removeTagsFromBeats(user, removals) {
        const body = lodash_1.flatten(removals.map(({ beatId, tag }) => {
            const script = `
          def beat = ctx._source.beat;
          if (beat.tags != null) {
            beat.tags.removeAll([params.tag]);
          }`;
            return [
                { update: { _id: `beat:${beatId}` } },
                { script: { source: script.replace('          ', ''), params: { tag } } },
            ];
        }));
        const response = await this.database.bulk(user, {
            body,
            index: constants_1.INDEX_NAMES.BEATS,
            refresh: 'wait_for',
            type: '_doc',
        });
        return lodash_1.get(response, 'items', []).map((item, resultIdx) => ({
            idxInRequest: removals[resultIdx].idxInRequest,
            result: item.update.result,
            status: item.update.status,
        }));
    }
    async assignTagsToBeats(user, assignments) {
        const body = lodash_1.flatten(assignments.map(({ beatId, tag }) => {
            const script = `
          def beat = ctx._source.beat;
          if (beat.tags == null) {
            beat.tags = [];
          }
          if (!beat.tags.contains(params.tag)) {
            beat.tags.add(params.tag);
          }`;
            return [
                { update: { _id: `beat:${beatId}` } },
                { script: { source: script.replace('          ', ''), params: { tag } } },
            ];
        }));
        const response = await this.database.bulk(user, {
            body,
            index: constants_1.INDEX_NAMES.BEATS,
            refresh: 'wait_for',
            type: '_doc',
        });
        // console.log(response.items[0].update.error);
        return lodash_1.get(response, 'items', []).map((item, resultIdx) => ({
            idxInRequest: assignments[resultIdx].idxInRequest,
            result: item.update.result,
            status: item.update.status,
        }));
    }
}
exports.ElasticsearchBeatsAdapter = ElasticsearchBeatsAdapter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL2hvbWUvYW50aG9ueS9naXRfd29ya3NwYWNlcy9raWJhbmEveC1wYWNrL3BsdWdpbnMvYmVhdHNfbWFuYWdlbWVudC9zZXJ2ZXIvbGliL2FkYXB0ZXJzL2JlYXRzL2VsYXN0aWNzZWFyY2hfYmVhdHNfYWRhcHRlci50cyIsInNvdXJjZXMiOlsiL2hvbWUvYW50aG9ueS9naXRfd29ya3NwYWNlcy9raWJhbmEveC1wYWNrL3BsdWdpbnMvYmVhdHNfbWFuYWdlbWVudC9zZXJ2ZXIvbGliL2FkYXB0ZXJzL2JlYXRzL2VsYXN0aWNzZWFyY2hfYmVhdHNfYWRhcHRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7R0FJRzs7QUFFSCxtQ0FBb0Q7QUFDcEQsNERBQTJEO0FBTTNELE1BQWEseUJBQXlCO0lBR3BDLFlBQVksUUFBeUI7UUFDbkMsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7SUFDM0IsQ0FBQztJQUVNLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBbUIsRUFBRSxFQUFVO1FBQzlDLE1BQU0sTUFBTSxHQUFHO1lBQ2IsRUFBRSxFQUFFLFFBQVEsRUFBRSxFQUFFO1lBQ2hCLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQztZQUNiLEtBQUssRUFBRSx1QkFBVyxDQUFDLEtBQUs7WUFDeEIsSUFBSSxFQUFFLE1BQU07U0FDYixDQUFDO1FBRUYsTUFBTSxRQUFRLEdBQUcsTUFBTSxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDdkQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUU7WUFDbkIsT0FBTyxJQUFJLENBQUM7U0FDYjtRQUNELE1BQU0sSUFBSSxHQUFHLFlBQUksQ0FBUyxRQUFRLEVBQUUsY0FBYyxDQUFDLENBQUM7UUFDcEQsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQztRQUM1QixPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7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QUMxRSxDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQ0gsQ0FBQztRQUVGLE1BQU0sUUFBUSxHQUFHLE1BQU0sSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFO1lBQzlDLElBQUk7WUFDSixLQUFLLEVBQUUsdUJBQVcsQ0FBQyxLQUFLO1lBQ3hCLE9BQU8sRUFBRSxVQUFVO1lBQ25CLElBQUksRUFBRSxNQUFNO1NBQ2IsQ0FBQyxDQUFDO1FBQ0gsK0NBQStDO1FBQy9DLE9BQU8sWUFBSSxDQUFNLFFBQVEsRUFBRSxPQUFPLEVBQUUsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBUyxFQUFFLFNBQWMsRUFBRSxFQUFFLENBQUMsQ0FBQztZQUMxRSxZQUFZLEVBQUUsV0FBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDLFlBQVk7WUFDakQsTUFBTSxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTTtZQUMxQixNQUFNLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNO1NBQzNCLENBQUMsQ0FBQyxDQUFDO0lBQ04sQ0FBQztDQUNGO0FBMU9ELDhEQTBPQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgRWxhc3RpY3NlYXJjaCBCLlYuIGFuZC9vciBsaWNlbnNlZCB0byBFbGFzdGljc2VhcmNoIEIuVi4gdW5kZXIgb25lXG4gKiBvciBtb3JlIGNvbnRyaWJ1dG9yIGxpY2Vuc2UgYWdyZWVtZW50cy4gTGljZW5zZWQgdW5kZXIgdGhlIEVsYXN0aWMgTGljZW5zZTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgRWxhc3RpYyBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IGZsYXR0ZW4sIGdldCBhcyBfZ2V0LCBvbWl0IH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IElOREVYX05BTUVTIH0gZnJvbSAnLi4vLi4vLi4vLi4vY29tbW9uL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBDTUJlYXQgfSBmcm9tICcuLi8uLi8uLi8uLi9jb21tb24vZG9tYWluX3R5cGVzJztcbmltcG9ydCB7IERhdGFiYXNlQWRhcHRlciB9IGZyb20gJy4uL2RhdGFiYXNlL2FkYXB0ZXJfdHlwZXMnO1xuaW1wb3J0IHsgRnJhbWV3b3JrVXNlciB9IGZyb20gJy4uL2ZyYW1ld29yay9hZGFwdGVyX3R5cGVzJztcbmltcG9ydCB7IEJlYXRzVGFnQXNzaWdubWVudCwgQ01CZWF0c0FkYXB0ZXIgfSBmcm9tICcuL2FkYXB0ZXJfdHlwZXMnO1xuXG5leHBvcnQgY2xhc3MgRWxhc3RpY3NlYXJjaEJlYXRzQWRhcHRlciBpbXBsZW1lbnRzIENNQmVhdHNBZGFwdGVyIHtcbiAgcHJpdmF0ZSBkYXRhYmFzZTogRGF0YWJhc2VBZGFwdGVyO1xuXG4gIGNvbnN0cnVjdG9yKGRhdGFiYXNlOiBEYXRhYmFzZUFkYXB0ZXIpIHtcbiAgICB0aGlzLmRhdGFiYXNlID0gZGF0YWJhc2U7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZ2V0KHVzZXI6IEZyYW1ld29ya1VzZXIsIGlkOiBzdHJpbmcpIHtcbiAgICBjb25zdCBwYXJhbXMgPSB7XG4gICAgICBpZDogYGJlYXQ6JHtpZH1gLFxuICAgICAgaWdub3JlOiBbNDA0XSxcbiAgICAgIGluZGV4OiBJTkRFWF9OQU1FUy5CRUFUUyxcbiAgICAgIHR5cGU6ICdfZG9jJyxcbiAgICB9O1xuXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLmRhdGFiYXNlLmdldCh1c2VyLCBwYXJhbXMpO1xuICAgIGlmICghcmVzcG9uc2UuZm91bmQpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBjb25zdCBiZWF0ID0gX2dldDxDTUJlYXQ+KHJlc3BvbnNlLCAnX3NvdXJjZS5iZWF0Jyk7XG4gICAgYmVhdC50YWdzID0gYmVhdC50YWdzIHx8IFtdO1xuICAgIHJldHVybiBiZWF0O1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGluc2VydCh1c2VyOiBGcmFtZXdvcmtVc2VyLCBiZWF0OiBDTUJlYXQpIHtcbiAgICBjb25zdCBib2R5ID0ge1xuICAgICAgYmVhdCxcbiAgICAgIHR5cGU6ICdiZWF0JyxcbiAgICB9O1xuXG4gICAgYXdhaXQgdGhpcy5kYXRhYmFzZS5pbmRleCh1c2VyLCB7XG4gICAgICBib2R5LFxuICAgICAgaWQ6IGBiZWF0OiR7YmVhdC5pZH1gLFxuICAgICAgaW5kZXg6IElOREVYX05BTUVTLkJFQVRTLFxuICAgICAgcmVmcmVzaDogJ3dhaXRfZm9yJyxcbiAgICAgIHR5cGU6ICdfZG9jJyxcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyB1cGRhdGUodXNlcjogRnJhbWV3b3JrVXNlciwgYmVhdDogQ01CZWF0KSB7XG4gICAgY29uc3QgYm9keSA9IHtcbiAgICAgIGJlYXQsXG4gICAgICB0eXBlOiAnYmVhdCcsXG4gICAgfTtcblxuICAgIGNvbnN0IHBhcmFtcyA9IHtcbiAgICAgIGJvZHksXG4gICAgICBpZDogYGJlYXQ6JHtiZWF0LmlkfWAsXG4gICAgICBpbmRleDogSU5ERVhfTkFNRVMuQkVBVFMsXG4gICAgICByZWZyZXNoOiAnd2FpdF9mb3InLFxuICAgICAgdHlwZTogJ19kb2MnLFxuICAgIH07XG4gICAgYXdhaXQgdGhpcy5kYXRhYmFzZS5pbmRleCh1c2VyLCBwYXJhbXMpO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGdldFdpdGhJZHModXNlcjogRnJhbWV3b3JrVXNlciwgYmVhdElkczogc3RyaW5nW10pIHtcbiAgICBjb25zdCBpZHMgPSBiZWF0SWRzLm1hcChiZWF0SWQgPT4gYGJlYXQ6JHtiZWF0SWR9YCk7XG5cbiAgICBjb25zdCBwYXJhbXMgPSB7XG4gICAgICBib2R5OiB7XG4gICAgICAgIGlkcyxcbiAgICAgIH0sXG4gICAgICBpbmRleDogSU5ERVhfTkFNRVMuQkVBVFMsXG4gICAgICB0eXBlOiAnX2RvYycsXG4gICAgfTtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuZGF0YWJhc2UubWdldCh1c2VyLCBwYXJhbXMpO1xuXG4gICAgcmV0dXJuIF9nZXQocmVzcG9uc2UsICdkb2NzJywgW10pXG4gICAgICAuZmlsdGVyKChiOiBhbnkpID0+IGIuZm91bmQpXG4gICAgICAubWFwKChiOiBhbnkpID0+ICh7IHRhZ3M6IFtdLCAuLi5iLl9zb3VyY2UuYmVhdCB9KSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZ2V0QWxsV2l0aFRhZ3ModXNlcjogRnJhbWV3b3JrVXNlciwgdGFnSWRzOiBzdHJpbmdbXSk6IFByb21pc2U8Q01CZWF0W10+IHtcbiAgICBjb25zdCBwYXJhbXMgPSB7XG4gICAgICBpZ25vcmU6IFs0MDRdLFxuICAgICAgaW5kZXg6IElOREVYX05BTUVTLkJFQVRTLFxuICAgICAgdHlwZTogJ19kb2MnLFxuICAgICAgYm9keToge1xuICAgICAgICBxdWVyeToge1xuICAgICAgICAgIHRlcm1zOiB7ICdiZWF0LnRhZ3MnOiB0YWdJZHMgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfTtcblxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5kYXRhYmFzZS5zZWFyY2godXNlciwgcGFyYW1zKTtcblxuICAgIGNvbnN0IGJlYXRzID0gX2dldDxDTUJlYXRbXT4ocmVzcG9uc2UsICdoaXRzLmhpdHMnLCBbXSk7XG5cbiAgICBpZiAoYmVhdHMubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuICAgIHJldHVybiBiZWF0cy5tYXAoKGJlYXQ6IGFueSkgPT4gKHtcbiAgICAgIHRhZ3M6IFtdIGFzIHN0cmluZ1tdLFxuICAgICAgLi4uKG9taXQoYmVhdC5fc291cmNlLmJlYXQgYXMgQ01CZWF0LCBbJ2FjY2Vzc190b2tlbiddKSBhcyBDTUJlYXQpLFxuICAgIH0pKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBnZXRCZWF0V2l0aFRva2VuKFxuICAgIHVzZXI6IEZyYW1ld29ya1VzZXIsXG4gICAgZW5yb2xsbWVudFRva2VuOiBzdHJpbmdcbiAgKTogUHJvbWlzZTxDTUJlYXQgfCBudWxsPiB7XG4gICAgY29uc3QgcGFyYW1zID0ge1xuICAgICAgaWdub3JlOiBbNDA0XSxcbiAgICAgIGluZGV4OiBJTkRFWF9OQU1FUy5CRUFUUyxcbiAgICAgIHR5cGU6ICdfZG9jJyxcbiAgICAgIGJvZHk6IHtcbiAgICAgICAgcXVlcnk6IHtcbiAgICAgICAgICBtYXRjaDogeyAnYmVhdC5lbnJvbGxtZW50X3Rva2VuJzogZW5yb2xsbWVudFRva2VuIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH07XG5cbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuZGF0YWJhc2Uuc2VhcmNoKHVzZXIsIHBhcmFtcyk7XG5cbiAgICBjb25zdCBiZWF0cyA9IF9nZXQ8Q01CZWF0W10+KHJlc3BvbnNlLCAnaGl0cy5oaXRzJywgW10pO1xuXG4gICAgaWYgKGJlYXRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIHJldHVybiBvbWl0PENNQmVhdCwge30+KF9nZXQ8Q01CZWF0Pih7IHRhZ3M6IFtdLCAuLi5iZWF0c1swXSB9LCAnX3NvdXJjZS5iZWF0JyksIFtcbiAgICAgICdhY2Nlc3NfdG9rZW4nLFxuICAgIF0pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGdldEFsbCh1c2VyOiBGcmFtZXdvcmtVc2VyLCBFU1F1ZXJ5PzogYW55KSB7XG4gICAgY29uc3QgcGFyYW1zID0ge1xuICAgICAgaW5kZXg6IElOREVYX05BTUVTLkJFQVRTLFxuICAgICAgc2l6ZTogMTAwMDAsXG4gICAgICBpZ25vcmU6IFs0MDRdLFxuICAgICAgdHlwZTogJ19kb2MnLFxuICAgICAgYm9keToge1xuICAgICAgICBxdWVyeToge1xuICAgICAgICAgIGJvb2w6IHtcbiAgICAgICAgICAgIG11c3Q6IHtcbiAgICAgICAgICAgICAgdGVybToge1xuICAgICAgICAgICAgICAgIHR5cGU6ICdiZWF0JyxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfTtcblxuICAgIGlmIChFU1F1ZXJ5KSB7XG4gICAgICBwYXJhbXMuYm9keS5xdWVyeSA9IHtcbiAgICAgICAgLi4ucGFyYW1zLmJvZHkucXVlcnksXG4gICAgICAgIC4uLkVTUXVlcnksXG4gICAgICB9O1xuICAgIH1cblxuICAgIGxldCByZXNwb25zZTtcbiAgICB0cnkge1xuICAgICAgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLmRhdGFiYXNlLnNlYXJjaCh1c2VyLCBwYXJhbXMpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIC8vIFRPRE8gc29tZXRoaW5nXG4gICAgfVxuICAgIGlmICghcmVzcG9uc2UpIHtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG4gICAgY29uc3QgYmVhdHMgPSBfZ2V0PGFueT4ocmVzcG9uc2UsICdoaXRzLmhpdHMnLCBbXSk7XG5cbiAgICByZXR1cm4gYmVhdHMubWFwKChiZWF0OiBhbnkpID0+ICh7XG4gICAgICB0YWdzOiBbXSBhcyBzdHJpbmdbXSxcbiAgICAgIC4uLihvbWl0KGJlYXQuX3NvdXJjZS5iZWF0IGFzIENNQmVhdCwgWydhY2Nlc3NfdG9rZW4nXSkgYXMgQ01CZWF0KSxcbiAgICB9KSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgcmVtb3ZlVGFnc0Zyb21CZWF0cyhcbiAgICB1c2VyOiBGcmFtZXdvcmtVc2VyLFxuICAgIHJlbW92YWxzOiBCZWF0c1RhZ0Fzc2lnbm1lbnRbXVxuICApOiBQcm9taXNlPEJlYXRzVGFnQXNzaWdubWVudFtdPiB7XG4gICAgY29uc3QgYm9keSA9IGZsYXR0ZW4oXG4gICAgICByZW1vdmFscy5tYXAoKHsgYmVhdElkLCB0YWcgfSkgPT4ge1xuICAgICAgICBjb25zdCBzY3JpcHQgPSBgXG4gICAgICAgICAgZGVmIGJlYXQgPSBjdHguX3NvdXJjZS5iZWF0O1xuICAgICAgICAgIGlmIChiZWF0LnRhZ3MgIT0gbnVsbCkge1xuICAgICAgICAgICAgYmVhdC50YWdzLnJlbW92ZUFsbChbcGFyYW1zLnRhZ10pO1xuICAgICAgICAgIH1gO1xuXG4gICAgICAgIHJldHVybiBbXG4gICAgICAgICAgeyB1cGRhdGU6IHsgX2lkOiBgYmVhdDoke2JlYXRJZH1gIH0gfSxcbiAgICAgICAgICB7IHNjcmlwdDogeyBzb3VyY2U6IHNjcmlwdC5yZXBsYWNlKCcgICAgICAgICAgJywgJycpLCBwYXJhbXM6IHsgdGFnIH0gfSB9LFxuICAgICAgICBdO1xuICAgICAgfSlcbiAgICApO1xuXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLmRhdGFiYXNlLmJ1bGsodXNlciwge1xuICAgICAgYm9keSxcbiAgICAgIGluZGV4OiBJTkRFWF9OQU1FUy5CRUFUUyxcbiAgICAgIHJlZnJlc2g6ICd3YWl0X2ZvcicsXG4gICAgICB0eXBlOiAnX2RvYycsXG4gICAgfSk7XG4gICAgcmV0dXJuIF9nZXQ8YW55PihyZXNwb25zZSwgJ2l0ZW1zJywgW10pLm1hcCgoaXRlbTogYW55LCByZXN1bHRJZHg6IG51bWJlcikgPT4gKHtcbiAgICAgIGlkeEluUmVxdWVzdDogcmVtb3ZhbHNbcmVzdWx0SWR4XS5pZHhJblJlcXVlc3QsXG4gICAgICByZXN1bHQ6IGl0ZW0udXBkYXRlLnJlc3VsdCxcbiAgICAgIHN0YXR1czogaXRlbS51cGRhdGUuc3RhdHVzLFxuICAgIH0pKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBhc3NpZ25UYWdzVG9CZWF0cyhcbiAgICB1c2VyOiBGcmFtZXdvcmtVc2VyLFxuICAgIGFzc2lnbm1lbnRzOiBCZWF0c1RhZ0Fzc2lnbm1lbnRbXVxuICApOiBQcm9taXNlPEJlYXRzVGFnQXNzaWdubWVudFtdPiB7XG4gICAgY29uc3QgYm9keSA9IGZsYXR0ZW4oXG4gICAgICBhc3NpZ25tZW50cy5tYXAoKHsgYmVhdElkLCB0YWcgfSkgPT4ge1xuICAgICAgICBjb25zdCBzY3JpcHQgPSBgXG4gICAgICAgICAgZGVmIGJlYXQgPSBjdHguX3NvdXJjZS5iZWF0O1xuICAgICAgICAgIGlmIChiZWF0LnRhZ3MgPT0gbnVsbCkge1xuICAgICAgICAgICAgYmVhdC50YWdzID0gW107XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICghYmVhdC50YWdzLmNvbnRhaW5zKHBhcmFtcy50YWcpKSB7XG4gICAgICAgICAgICBiZWF0LnRhZ3MuYWRkKHBhcmFtcy50YWcpO1xuICAgICAgICAgIH1gO1xuXG4gICAgICAgIHJldHVybiBbXG4gICAgICAgICAgeyB1cGRhdGU6IHsgX2lkOiBgYmVhdDoke2JlYXRJZH1gIH0gfSxcbiAgICAgICAgICB7IHNjcmlwdDogeyBzb3VyY2U6IHNjcmlwdC5yZXBsYWNlKCcgICAgICAgICAgJywgJycpLCBwYXJhbXM6IHsgdGFnIH0gfSB9LFxuICAgICAgICBdO1xuICAgICAgfSlcbiAgICApO1xuXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLmRhdGFiYXNlLmJ1bGsodXNlciwge1xuICAgICAgYm9keSxcbiAgICAgIGluZGV4OiBJTkRFWF9OQU1FUy5CRUFUUyxcbiAgICAgIHJlZnJlc2g6ICd3YWl0X2ZvcicsXG4gICAgICB0eXBlOiAnX2RvYycsXG4gICAgfSk7XG4gICAgLy8gY29uc29sZS5sb2cocmVzcG9uc2UuaXRlbXNbMF0udXBkYXRlLmVycm9yKTtcbiAgICByZXR1cm4gX2dldDxhbnk+KHJlc3BvbnNlLCAnaXRlbXMnLCBbXSkubWFwKChpdGVtOiBhbnksIHJlc3VsdElkeDogYW55KSA9PiAoe1xuICAgICAgaWR4SW5SZXF1ZXN0OiBhc3NpZ25tZW50c1tyZXN1bHRJZHhdLmlkeEluUmVxdWVzdCxcbiAgICAgIHJlc3VsdDogaXRlbS51cGRhdGUucmVzdWx0LFxuICAgICAgc3RhdHVzOiBpdGVtLnVwZGF0ZS5zdGF0dXMsXG4gICAgfSkpO1xuICB9XG59XG4iXX0=