"use strict";
/*
 * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
 * or more contributor license agreements. Licensed under the Elastic License;
 * you may not use this file except in compliance with the Elastic License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const lodash_1 = require("lodash");
const constants_1 = require("../../../../common/constants");
class ElasticsearchTagsAdapter {
    constructor(database) {
        this.database = database;
    }
    async getAll(user, ESQuery) {
        const params = {
            ignore: [404],
            _source: true,
            size: 10000,
            index: constants_1.INDEX_NAMES.BEATS,
            type: '_doc',
            body: {
                query: {
                    bool: {
                        must: {
                            term: {
                                type: 'tag',
                            },
                        },
                    },
                },
            },
        };
        if (ESQuery) {
            params.body.query = {
                ...params.body.query,
                ...ESQuery,
            };
        }
        const response = await this.database.search(user, params);
        const tags = lodash_1.get(response, 'hits.hits', []);
        return tags.map((tag) => ({ hasConfigurationBlocksTypes: [], ...tag._source.tag }));
    }
    async delete(user, tagIds) {
        const ids = tagIds.map(tag => tag);
        const params = {
            ignore: [404],
            index: constants_1.INDEX_NAMES.BEATS,
            type: '_doc',
            body: {
                query: {
                    terms: { 'beat.tags': tagIds },
                },
            },
        };
        const beatsResponse = await this.database.search(user, params);
        const beats = lodash_1.get(beatsResponse, 'hits.hits', []).map((beat) => beat._source.beat);
        const inactiveBeats = beats.filter(beat => beat.active === false);
        const activeBeats = beats.filter(beat => beat.active === true);
        if (activeBeats.length !== 0) {
            return false;
        }
        const beatIds = inactiveBeats.map((beat) => beat.id);
        // While we block tag deletion when on an active beat, we should remove from inactive
        const bulkInactiveBeatsUpdates = lodash_1.flatten(beatIds.map(beatId => {
            const script = `
        def beat = ctx._source.beat;
        if (beat.tags != null) {
          beat.tags.removeAll([params.tag]);
        }`;
            return lodash_1.flatten(ids.map(tagId => [
                { update: { _id: `beat:${beatId}` } },
                { script: { source: script.replace('          ', ''), params: { tagId } } },
            ]));
        }));
        const bulkTagsDelete = ids.map(tagId => ({ delete: { _id: `tag:${tagId}` } }));
        await this.database.bulk(user, {
            body: lodash_1.flatten([...bulkInactiveBeatsUpdates, ...bulkTagsDelete]),
            index: constants_1.INDEX_NAMES.BEATS,
            refresh: 'wait_for',
            type: '_doc',
        });
        return true;
    }
    async getTagsWithIds(user, tagIds) {
        if (tagIds.length === 0) {
            return [];
        }
        const ids = tagIds.map(tag => `tag:${tag}`);
        const params = {
            ignore: [404],
            _source: true,
            body: {
                ids,
            },
            index: constants_1.INDEX_NAMES.BEATS,
            type: '_doc',
        };
        const response = await this.database.mget(user, params);
        return lodash_1.get(response, 'docs', [])
            .filter((b) => b.found)
            .map((b) => ({
            hasConfigurationBlocksTypes: [],
            ...b._source.tag,
            id: b._id.replace('tag:', ''),
        }));
    }
    async upsertTag(user, tag) {
        const body = {
            tag,
            type: 'tag',
        };
        const params = {
            body,
            id: `tag:${tag.id}`,
            index: constants_1.INDEX_NAMES.BEATS,
            refresh: 'wait_for',
            type: '_doc',
        };
        const response = await this.database.index(user, params);
        return lodash_1.get(response, 'result');
    }
    async getWithoutConfigTypes(user, blockTypes) {
        const body = {
            query: {
                bool: {
                    filter: {
                        match: {
                            type: 'tag',
                        },
                    },
                    must_not: {
                        terms: { 'tag.hasConfigurationBlocksTypes': blockTypes },
                    },
                },
            },
        };
        const params = {
            body,
            index: constants_1.INDEX_NAMES.BEATS,
            ignore: [404],
            _source: true,
            size: 10000,
            type: '_doc',
        };
        const response = await this.database.search(user, params);
        const tags = lodash_1.get(response, 'hits.hits', []);
        return tags.map((tag) => ({ hasConfigurationBlocksTypes: [], ...tag._source.tag }));
    }
}
exports.ElasticsearchTagsAdapter = ElasticsearchTagsAdapter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL2hvbWUvYW50aG9ueS9naXRfd29ya3NwYWNlcy9raWJhbmEveC1wYWNrL3BsdWdpbnMvYmVhdHNfbWFuYWdlbWVudC9zZXJ2ZXIvbGliL2FkYXB0ZXJzL3RhZ3MvZWxhc3RpY3NlYXJjaF90YWdzX2FkYXB0ZXIudHMiLCJzb3VyY2VzIjpbIi9ob21lL2FudGhvbnkvZ2l0X3dvcmtzcGFjZXMva2liYW5hL3gtcGFjay9wbHVnaW5zL2JlYXRzX21hbmFnZW1lbnQvc2VydmVyL2xpYi9hZGFwdGVycy90YWdzL2VsYXN0aWNzZWFyY2hfdGFnc19hZGFwdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7OztHQUlHOztBQUVILG1DQUFzQztBQUN0Qyw0REFBMkQ7QUFNM0QsTUFBYSx3QkFBd0I7SUFHbkMsWUFBWSxRQUF5QjtRQUNuQyxJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztJQUMzQixDQUFDO0lBRU0sS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFtQixFQUFFLE9BQWE7UUFDcEQsTUFBTSxNQUFNLEdBQUc7WUFDYixNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUM7WUFDYixPQUFPLEVBQUUsSUFBSTtZQUNiLElBQUksRUFBRSxLQUFLO1lBQ1gsS0FBSyxFQUFFLHVCQUFXLENBQUMsS0FBSztZQUN4QixJQUFJLEVBQUUsTUFBTTtZQUNaLElBQUksRUFBRTtnQkFDSixLQUFLLEVBQUU7b0JBQ0wsSUFBSSxFQUFFO3dCQUNKLElBQUksRUFBRTs0QkFDSixJQUFJLEVBQUU7Z0NBQ0osSUFBSSxFQUFFLEtBQUs7NkJBQ1o7eUJBQ0Y7cUJBQ0Y7aUJBQ0Y7YUFDRjtTQUNGLENBQUM7UUFDRixJQUFJLE9BQU8sRUFBRTtZQUNYLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxHQUFHO2dCQUNsQixHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSztnQkFDcEIsR0FBRyxPQUFPO2FBQ1gsQ0FBQztTQUNIO1FBQ0QsTUFBTSxRQUFRLEdBQUcsTUFBTSxJ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QUFFLFdBQVcsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVqRCxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFRLEVBQUUsRUFBRSxDQUFDLENBQUMsRUFBRSwyQkFBMkIsRUFBRSxFQUFFLEVBQUUsR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUMzRixDQUFDO0NBQ0Y7QUEzS0QsNERBMktDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIENvcHlyaWdodCBFbGFzdGljc2VhcmNoIEIuVi4gYW5kL29yIGxpY2Vuc2VkIHRvIEVsYXN0aWNzZWFyY2ggQi5WLiB1bmRlciBvbmVcbiAqIG9yIG1vcmUgY29udHJpYnV0b3IgbGljZW5zZSBhZ3JlZW1lbnRzLiBMaWNlbnNlZCB1bmRlciB0aGUgRWxhc3RpYyBMaWNlbnNlO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBFbGFzdGljIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgZmxhdHRlbiwgZ2V0IH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IElOREVYX05BTUVTIH0gZnJvbSAnLi4vLi4vLi4vLi4vY29tbW9uL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBCZWF0VGFnIH0gZnJvbSAnLi4vLi4vLi4vLi4vY29tbW9uL2RvbWFpbl90eXBlcyc7XG5pbXBvcnQgeyBEYXRhYmFzZUFkYXB0ZXIgfSBmcm9tICcuLi9kYXRhYmFzZS9hZGFwdGVyX3R5cGVzJztcbmltcG9ydCB7IEZyYW1ld29ya1VzZXIgfSBmcm9tICcuLi9mcmFtZXdvcmsvYWRhcHRlcl90eXBlcyc7XG5pbXBvcnQgeyBDTVRhZ3NBZGFwdGVyIH0gZnJvbSAnLi9hZGFwdGVyX3R5cGVzJztcblxuZXhwb3J0IGNsYXNzIEVsYXN0aWNzZWFyY2hUYWdzQWRhcHRlciBpbXBsZW1lbnRzIENNVGFnc0FkYXB0ZXIge1xuICBwcml2YXRlIGRhdGFiYXNlOiBEYXRhYmFzZUFkYXB0ZXI7XG5cbiAgY29uc3RydWN0b3IoZGF0YWJhc2U6IERhdGFiYXNlQWRhcHRlcikge1xuICAgIHRoaXMuZGF0YWJhc2UgPSBkYXRhYmFzZTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBnZXRBbGwodXNlcjogRnJhbWV3b3JrVXNlciwgRVNRdWVyeT86IGFueSk6IFByb21pc2U8QmVhdFRhZ1tdPiB7XG4gICAgY29uc3QgcGFyYW1zID0ge1xuICAgICAgaWdub3JlOiBbNDA0XSxcbiAgICAgIF9zb3VyY2U6IHRydWUsXG4gICAgICBzaXplOiAxMDAwMCxcbiAgICAgIGluZGV4OiBJTkRFWF9OQU1FUy5CRUFUUyxcbiAgICAgIHR5cGU6ICdfZG9jJyxcbiAgICAgIGJvZHk6IHtcbiAgICAgICAgcXVlcnk6IHtcbiAgICAgICAgICBib29sOiB7XG4gICAgICAgICAgICBtdXN0OiB7XG4gICAgICAgICAgICAgIHRlcm06IHtcbiAgICAgICAgICAgICAgICB0eXBlOiAndGFnJyxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfTtcbiAgICBpZiAoRVNRdWVyeSkge1xuICAgICAgcGFyYW1zLmJvZHkucXVlcnkgPSB7XG4gICAgICAgIC4uLnBhcmFtcy5ib2R5LnF1ZXJ5LFxuICAgICAgICAuLi5FU1F1ZXJ5LFxuICAgICAgfTtcbiAgICB9XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLmRhdGFiYXNlLnNlYXJjaCh1c2VyLCBwYXJhbXMpO1xuICAgIGNvbnN0IHRhZ3MgPSBnZXQ8YW55PihyZXNwb25zZSwgJ2hpdHMuaGl0cycsIFtdKTtcblxuICAgIHJldHVybiB0YWdzLm1hcCgodGFnOiBhbnkpID0+ICh7IGhhc0NvbmZpZ3VyYXRpb25CbG9ja3NUeXBlczogW10sIC4uLnRhZy5fc291cmNlLnRhZyB9KSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZGVsZXRlKHVzZXI6IEZyYW1ld29ya1VzZXIsIHRhZ0lkczogc3RyaW5nW10pOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBjb25zdCBpZHMgPSB0YWdJZHMubWFwKHRhZyA9PiB0YWcpO1xuXG4gICAgY29uc3QgcGFyYW1zID0ge1xuICAgICAgaWdub3JlOiBbNDA0XSxcbiAgICAgIGluZGV4OiBJTkRFWF9OQU1FUy5CRUFUUyxcbiAgICAgIHR5cGU6ICdfZG9jJyxcbiAgICAgIGJvZHk6IHtcbiAgICAgICAgcXVlcnk6IHtcbiAgICAgICAgICB0ZXJtczogeyAnYmVhdC50YWdzJzogdGFnSWRzIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH07XG5cbiAgICBjb25zdCBiZWF0c1Jlc3BvbnNlID0gYXdhaXQgdGhpcy5kYXRhYmFzZS5zZWFyY2godXNlciwgcGFyYW1zKTtcblxuICAgIGNvbnN0IGJlYXRzID0gZ2V0PEJlYXRUYWdbXT4oYmVhdHNSZXNwb25zZSwgJ2hpdHMuaGl0cycsIFtdKS5tYXAoXG4gICAgICAoYmVhdDogYW55KSA9PiBiZWF0Ll9zb3VyY2UuYmVhdFxuICAgICk7XG5cbiAgICBjb25zdCBpbmFjdGl2ZUJlYXRzID0gYmVhdHMuZmlsdGVyKGJlYXQgPT4gYmVhdC5hY3RpdmUgPT09IGZhbHNlKTtcbiAgICBjb25zdCBhY3RpdmVCZWF0cyA9IGJlYXRzLmZpbHRlcihiZWF0ID0+IGJlYXQuYWN0aXZlID09PSB0cnVlKTtcbiAgICBpZiAoYWN0aXZlQmVhdHMubGVuZ3RoICE9PSAwKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGNvbnN0IGJlYXRJZHMgPSBpbmFjdGl2ZUJlYXRzLm1hcCgoYmVhdDogQmVhdFRhZykgPT4gYmVhdC5pZCk7XG5cbiAgICAvLyBXaGlsZSB3ZSBibG9jayB0YWcgZGVsZXRpb24gd2hlbiBvbiBhbiBhY3RpdmUgYmVhdCwgd2Ugc2hvdWxkIHJlbW92ZSBmcm9tIGluYWN0aXZlXG4gICAgY29uc3QgYnVsa0luYWN0aXZlQmVhdHNVcGRhdGVzID0gZmxhdHRlbihcbiAgICAgIGJlYXRJZHMubWFwKGJlYXRJZCA9PiB7XG4gICAgICAgIGNvbnN0IHNjcmlwdCA9IGBcbiAgICAgICAgZGVmIGJlYXQgPSBjdHguX3NvdXJjZS5iZWF0O1xuICAgICAgICBpZiAoYmVhdC50YWdzICE9IG51bGwpIHtcbiAgICAgICAgICBiZWF0LnRhZ3MucmVtb3ZlQWxsKFtwYXJhbXMudGFnXSk7XG4gICAgICAgIH1gO1xuXG4gICAgICAgIHJldHVybiBmbGF0dGVuKFxuICAgICAgICAgIGlkcy5tYXAodGFnSWQgPT4gW1xuICAgICAgICAgICAgeyB1cGRhdGU6IHsgX2lkOiBgYmVhdDoke2JlYXRJZH1gIH0gfSxcbiAgICAgICAgICAgIHsgc2NyaXB0OiB7IHNvdXJjZTogc2NyaXB0LnJlcGxhY2UoJyAgICAgICAgICAnLCAnJyksIHBhcmFtczogeyB0YWdJZCB9IH0gfSxcbiAgICAgICAgICBdKVxuICAgICAgICApO1xuICAgICAgfSlcbiAgICApO1xuXG4gICAgY29uc3QgYnVsa1RhZ3NEZWxldGUgPSBpZHMubWFwKHRhZ0lkID0+ICh7IGRlbGV0ZTogeyBfaWQ6IGB0YWc6JHt0YWdJZH1gIH0gfSkpO1xuXG4gICAgYXdhaXQgdGhpcy5kYXRhYmFzZS5idWxrKHVzZXIsIHtcbiAgICAgIGJvZHk6IGZsYXR0ZW4oWy4uLmJ1bGtJbmFjdGl2ZUJlYXRzVXBkYXRlcywgLi4uYnVsa1RhZ3NEZWxldGVdKSxcbiAgICAgIGluZGV4OiBJTkRFWF9OQU1FUy5CRUFUUyxcbiAgICAgIHJlZnJlc2g6ICd3YWl0X2ZvcicsXG4gICAgICB0eXBlOiAnX2RvYycsXG4gICAgfSk7XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBnZXRUYWdzV2l0aElkcyh1c2VyOiBGcmFtZXdvcmtVc2VyLCB0YWdJZHM6IHN0cmluZ1tdKTogUHJvbWlzZTxCZWF0VGFnW10+IHtcbiAgICBpZiAodGFnSWRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgICBjb25zdCBpZHMgPSB0YWdJZHMubWFwKHRhZyA9PiBgdGFnOiR7dGFnfWApO1xuXG4gICAgY29uc3QgcGFyYW1zID0ge1xuICAgICAgaWdub3JlOiBbNDA0XSxcbiAgICAgIF9zb3VyY2U6IHRydWUsXG4gICAgICBib2R5OiB7XG4gICAgICAgIGlkcyxcbiAgICAgIH0sXG4gICAgICBpbmRleDogSU5ERVhfTkFNRVMuQkVBVFMsXG4gICAgICB0eXBlOiAnX2RvYycsXG4gICAgfTtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuZGF0YWJhc2UubWdldCh1c2VyLCBwYXJhbXMpO1xuXG4gICAgcmV0dXJuIGdldChyZXNwb25zZSwgJ2RvY3MnLCBbXSlcbiAgICAgIC5maWx0ZXIoKGI6IGFueSkgPT4gYi5mb3VuZClcbiAgICAgIC5tYXAoKGI6IGFueSkgPT4gKHtcbiAgICAgICAgaGFzQ29uZmlndXJhdGlvbkJsb2Nrc1R5cGVzOiBbXSxcbiAgICAgICAgLi4uYi5fc291cmNlLnRhZyxcbiAgICAgICAgaWQ6IGIuX2lkLnJlcGxhY2UoJ3RhZzonLCAnJyksXG4gICAgICB9KSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgdXBzZXJ0VGFnKHVzZXI6IEZyYW1ld29ya1VzZXIsIHRhZzogQmVhdFRhZyk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgY29uc3QgYm9keSA9IHtcbiAgICAgIHRhZyxcbiAgICAgIHR5cGU6ICd0YWcnLFxuICAgIH07XG5cbiAgICBjb25zdCBwYXJhbXMgPSB7XG4gICAgICBib2R5LFxuICAgICAgaWQ6IGB0YWc6JHt0YWcuaWR9YCxcbiAgICAgIGluZGV4OiBJTkRFWF9OQU1FUy5CRUFUUyxcbiAgICAgIHJlZnJlc2g6ICd3YWl0X2ZvcicsXG4gICAgICB0eXBlOiAnX2RvYycsXG4gICAgfTtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuZGF0YWJhc2UuaW5kZXgodXNlciwgcGFyYW1zKTtcblxuICAgIHJldHVybiBnZXQ8c3RyaW5nPihyZXNwb25zZSwgJ3Jlc3VsdCcpO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGdldFdpdGhvdXRDb25maWdUeXBlcyhcbiAgICB1c2VyOiBGcmFtZXdvcmtVc2VyLFxuICAgIGJsb2NrVHlwZXM6IHN0cmluZ1tdXG4gICk6IFByb21pc2U8QmVhdFRhZ1tdPiB7XG4gICAgY29uc3QgYm9keSA9IHtcbiAgICAgIHF1ZXJ5OiB7XG4gICAgICAgIGJvb2w6IHtcbiAgICAgICAgICBmaWx0ZXI6IHtcbiAgICAgICAgICAgIG1hdGNoOiB7XG4gICAgICAgICAgICAgIHR5cGU6ICd0YWcnLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIG11c3Rfbm90OiB7XG4gICAgICAgICAgICB0ZXJtczogeyAndGFnLmhhc0NvbmZpZ3VyYXRpb25CbG9ja3NUeXBlcyc6IGJsb2NrVHlwZXMgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9O1xuXG4gICAgY29uc3QgcGFyYW1zID0ge1xuICAgICAgYm9keSxcbiAgICAgIGluZGV4OiBJTkRFWF9OQU1FUy5CRUFUUyxcbiAgICAgIGlnbm9yZTogWzQwNF0sXG4gICAgICBfc291cmNlOiB0cnVlLFxuICAgICAgc2l6ZTogMTAwMDAsXG4gICAgICB0eXBlOiAnX2RvYycsXG4gICAgfTtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuZGF0YWJhc2Uuc2VhcmNoKHVzZXIsIHBhcmFtcyk7XG4gICAgY29uc3QgdGFncyA9IGdldDxhbnk+KHJlc3BvbnNlLCAnaGl0cy5oaXRzJywgW10pO1xuXG4gICAgcmV0dXJuIHRhZ3MubWFwKCh0YWc6IGFueSkgPT4gKHsgaGFzQ29uZmlndXJhdGlvbkJsb2Nrc1R5cGVzOiBbXSwgLi4udGFnLl9zb3VyY2UudGFnIH0pKTtcbiAgfVxufVxuIl19