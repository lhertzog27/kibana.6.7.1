"use strict";
/*
 * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
 * or more contributor license agreements. Licensed under the Elastic License;
 * you may not use this file except in compliance with the Elastic License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const lodash_1 = require("lodash");
const moment_1 = tslib_1.__importDefault(require("moment"));
const find_non_existent_items_1 = require("../utils/find_non_existent_items");
const types_1 = require("./types");
class CMBeatsDomain {
    constructor(adapter, libs) {
        this.adapter = adapter;
        this.adapter = adapter;
        this.tags = libs.tags;
        this.tokens = libs.tokens;
        this.framework = libs.framework;
    }
    async getById(user, beatId) {
        const beat = await this.adapter.get(user, beatId);
        return beat && beat.active ? beat : null;
    }
    async getByIds(user, beatIds) {
        const beats = await this.adapter.getWithIds(user, beatIds);
        return beats.filter(beat => beat.active);
    }
    async getAll(user, ESQuery) {
        return (await this.adapter.getAll(user, ESQuery)).filter((beat) => beat.active === true);
    }
    async getAllWithTag(user, tagId) {
        return (await this.adapter.getAllWithTags(user, [tagId])).filter((beat) => beat.active === true);
    }
    async getByEnrollmentToken(user, enrollmentToken) {
        const beat = await this.adapter.getBeatWithToken(user, enrollmentToken);
        return beat && beat.active ? beat : null;
    }
    async update(userOrToken, beatId, beatData) {
        const beat = await this.adapter.get(this.framework.internalUser, beatId);
        // FIXME make return type enum
        if (beat === null) {
            return 'beat-not-found';
        }
        if (typeof userOrToken === 'string') {
            const { verified: isAccessTokenValid } = this.tokens.verifyToken(beat ? beat.access_token : '', userOrToken);
            if (!isAccessTokenValid) {
                return 'invalid-access-token';
            }
        }
        const user = typeof userOrToken === 'string' ? this.framework.internalUser : userOrToken;
        await this.adapter.update(user, {
            ...beat,
            ...beatData,
        });
    }
    async enrollBeat(enrollmentToken, beatId, remoteAddress, beat) {
        const { token, expires_on } = await this.tokens.getEnrollmentToken(enrollmentToken);
        if (expires_on && moment_1.default(expires_on).isBefore(moment_1.default())) {
            return { status: types_1.BeatEnrollmentStatus.ExpiredEnrollmentToken };
        }
        if (!token) {
            return { status: types_1.BeatEnrollmentStatus.InvalidEnrollmentToken };
        }
        const existingBeat = await this.getById(this.framework.internalUser, beatId);
        if (existingBeat) {
            return { status: types_1.BeatEnrollmentStatus.Success };
        }
        const accessToken = this.tokens.generateAccessToken();
        const verifiedOn = moment_1.default().toJSON();
        await this.adapter.insert(this.framework.internalUser, {
            tags: [],
            ...beat,
            active: true,
            enrollment_token: enrollmentToken,
            verified_on: verifiedOn,
            access_token: accessToken,
            host_ip: remoteAddress,
            id: beatId,
        });
        await this.tokens.deleteEnrollmentToken(enrollmentToken);
        return { status: types_1.BeatEnrollmentStatus.Success, accessToken };
    }
    async removeTagsFromBeats(user, removals) {
        const beatIds = lodash_1.uniq(removals.map(removal => removal.beatId));
        const tagIds = lodash_1.uniq(removals.map(removal => removal.tag));
        const response = {
            removals: removals.map(() => ({ status: null })),
        };
        const beats = await this.adapter.getWithIds(user, beatIds);
        const tags = await this.tags.getWithIds(user, tagIds);
        // Handle assignments containing non-existing beat IDs or tags
        const nonExistentBeatIds = find_non_existent_items_1.findNonExistentItems(beats, beatIds);
        const nonExistentTags = await find_non_existent_items_1.findNonExistentItems(tags, tagIds);
        addNonExistentItemToResponse(response, removals, nonExistentBeatIds, nonExistentTags, 'removals');
        // FIXME abstract this
        const validRemovals = removals
            .map((removal, idxInRequest) => ({
            beatId: removal.beatId,
            idxInRequest,
            tag: removal.tag,
        }))
            .filter((removal, idx) => response.removals[idx].status === null);
        if (validRemovals.length > 0) {
            const removalResults = await this.adapter.removeTagsFromBeats(user, validRemovals);
            return addToResultsToResponse('removals', response, removalResults);
        }
        return response;
    }
    async assignTagsToBeats(user, assignments) {
        const beatIds = lodash_1.uniq(assignments.map(assignment => assignment.beatId));
        const tagIds = lodash_1.uniq(assignments.map(assignment => assignment.tag));
        const response = {
            assignments: assignments.map(() => ({ status: null })),
        };
        const beats = await this.adapter.getWithIds(user, beatIds);
        const tags = await this.tags.getWithIds(user, tagIds);
        // Handle assignments containing non-existing beat IDs or tags
        const nonExistentBeatIds = find_non_existent_items_1.findNonExistentItems(beats, beatIds);
        const nonExistentTags = find_non_existent_items_1.findNonExistentItems(tags, tagIds);
        // FIXME break out back into route / function response
        // FIXME causes function to error if a beat or tag does not exist
        addNonExistentItemToResponse(response, assignments, nonExistentBeatIds, nonExistentTags, 'assignments');
        // FIXME abstract this
        const validAssignments = assignments
            .map((assignment, idxInRequest) => ({
            beatId: assignment.beatId,
            idxInRequest,
            tag: assignment.tag,
        }))
            .filter((assignment, idx) => response.assignments[idx].status === null);
        if (validAssignments.length > 0) {
            const assignmentResults = await this.adapter.assignTagsToBeats(user, validAssignments);
            // TODO This should prob not mutate
            return addToResultsToResponse('assignments', response, assignmentResults);
        }
        return response;
    }
}
exports.CMBeatsDomain = CMBeatsDomain;
// FIXME abstract to the route, also the key arg is a temp fix
function addNonExistentItemToResponse(response, assignments, nonExistentBeatIds, nonExistentTags, key) {
    assignments.forEach(({ beatId, tag }, idx) => {
        const isBeatNonExistent = nonExistentBeatIds.includes(beatId);
        const isTagNonExistent = nonExistentTags.includes(tag);
        if (isBeatNonExistent && isTagNonExistent) {
            response[key][idx].status = 404;
            response[key][idx].result = `Beat ${beatId} and tag ${tag} not found`;
        }
        else if (isBeatNonExistent) {
            response[key][idx].status = 404;
            response[key][idx].result = `Beat ${beatId} not found`;
        }
        else if (isTagNonExistent) {
            response[key][idx].status = 404;
            response[key][idx].result = `Tag ${tag} not found`;
        }
    });
}
// TODO dont mutate response
function addToResultsToResponse(key, response, assignmentResults) {
    assignmentResults.forEach((assignmentResult) => {
        const { idxInRequest, status, result } = assignmentResult;
        response[key][idxInRequest].status = status;
        response[key][idxInRequest].result = result;
    });
    return response;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL2hvbWUvYW50aG9ueS9naXRfd29ya3NwYWNlcy9raWJhbmEveC1wYWNrL3BsdWdpbnMvYmVhdHNfbWFuYWdlbWVudC9zZXJ2ZXIvbGliL2JlYXRzLnRzIiwic291cmNlcyI6WyIvaG9tZS9hbnRob255L2dpdF93b3Jrc3BhY2VzL2tpYmFuYS94LXBhY2svcGx1Z2lucy9iZWF0c19tYW5hZ2VtZW50L3NlcnZlci9saWIvYmVhdHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7O0dBSUc7OztBQUVILG1DQUE4QjtBQUM5Qiw0REFBNEI7QUFFNUIsOEVBQXdFO0FBUXhFLG1DQUEwRTtBQUUxRSxNQUFhLGFBQWE7SUFLeEIsWUFDbUIsT0FBdUIsRUFDeEMsSUFJQztRQUxnQixZQUFPLEdBQVAsT0FBTyxDQUFnQjtRQU94QyxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztRQUN2QixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7UUFDdEIsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDO1FBQzFCLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQztJQUNsQyxDQUFDO0lBRU0sS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFtQixFQUFFLE1BQWM7UUFDdEQsTUFBTSxJQUFJLEdBQUcsTUFBTSxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDbEQsT0FBTyxJQUFJLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFDM0MsQ0FBQztJQUVNLEtBQUssQ0FBQyxRQUFRLENBQUMsSUFBbUIsRUFBRSxPQUFpQjtRQUMxRCxNQUFNLEtBQUssR0FBRyxNQUFNLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQztRQUMz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O1lBQ2hDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLEdBQUcsUUFBUSxNQUFNLFlBQVksR0FBRyxZQUFZLENBQUM7U0FDdkU7YUFBTSxJQUFJLGlCQUFpQixFQUFFO1lBQzVCLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLEdBQUcsR0FBRyxDQUFDO1lBQ2hDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLEdBQUcsUUFBUSxNQUFNLFlBQVksQ0FBQztTQUN4RDthQUFNLElBQUksZ0JBQWdCLEVBQUU7WUFDM0IsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sR0FBRyxHQUFHLENBQUM7WUFDaEMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sR0FBRyxPQUFPLEdBQUcsWUFBWSxDQUFDO1NBQ3BEO0lBQ0gsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDO0FBRUQsNEJBQTRCO0FBQzVCLFNBQVMsc0JBQXNCLENBQUMsR0FBVyxFQUFFLFFBQWEsRUFBRSxpQkFBc0I7SUFDaEYsaUJBQWlCLENBQUMsT0FBTyxDQUFDLENBQUMsZ0JBQXFCLEVBQUUsRUFBRTtRQUNsRCxNQUFNLEVBQUUsWUFBWSxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsR0FBRyxnQkFBZ0IsQ0FBQztRQUMxRCxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUM1QyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztJQUM5QyxDQUFDLENBQUMsQ0FBQztJQUNILE9BQU8sUUFBUSxDQUFDO0FBQ2xCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQ29weXJpZ2h0IEVsYXN0aWNzZWFyY2ggQi5WLiBhbmQvb3IgbGljZW5zZWQgdG8gRWxhc3RpY3NlYXJjaCBCLlYuIHVuZGVyIG9uZVxuICogb3IgbW9yZSBjb250cmlidXRvciBsaWNlbnNlIGFncmVlbWVudHMuIExpY2Vuc2VkIHVuZGVyIHRoZSBFbGFzdGljIExpY2Vuc2U7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIEVsYXN0aWMgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyB1bmlxIH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBtb21lbnQgZnJvbSAnbW9tZW50JztcbmltcG9ydCB7IENNQmVhdCB9IGZyb20gJy4uLy4uL2NvbW1vbi9kb21haW5fdHlwZXMnO1xuaW1wb3J0IHsgZmluZE5vbkV4aXN0ZW50SXRlbXMgfSBmcm9tICcuLi91dGlscy9maW5kX25vbl9leGlzdGVudF9pdGVtcyc7XG5pbXBvcnQge1xuICBCZWF0c1JlbW92YWxSZXR1cm4sXG4gIEJlYXRzVGFnQXNzaWdubWVudCxcbiAgQ01Bc3NpZ25tZW50UmV0dXJuLFxuICBDTUJlYXRzQWRhcHRlcixcbn0gZnJvbSAnLi9hZGFwdGVycy9iZWF0cy9hZGFwdGVyX3R5cGVzJztcbmltcG9ydCB7IEZyYW1ld29ya1VzZXIgfSBmcm9tICcuL2FkYXB0ZXJzL2ZyYW1ld29yay9hZGFwdGVyX3R5cGVzJztcbmltcG9ydCB7IEJlYXRFbnJvbGxtZW50U3RhdHVzLCBDTVNlcnZlckxpYnMsIFVzZXJPclRva2VuIH0gZnJvbSAnLi90eXBlcyc7XG5cbmV4cG9ydCBjbGFzcyBDTUJlYXRzRG9tYWluIHtcbiAgcHJpdmF0ZSB0YWdzOiBDTVNlcnZlckxpYnNbJ3RhZ3MnXTtcbiAgcHJpdmF0ZSB0b2tlbnM6IENNU2VydmVyTGlic1sndG9rZW5zJ107XG4gIHByaXZhdGUgZnJhbWV3b3JrOiBDTVNlcnZlckxpYnNbJ2ZyYW1ld29yayddO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgYWRhcHRlcjogQ01CZWF0c0FkYXB0ZXIsXG4gICAgbGliczoge1xuICAgICAgdGFnczogQ01TZXJ2ZXJMaWJzWyd0YWdzJ107XG4gICAgICB0b2tlbnM6IENNU2VydmVyTGlic1sndG9rZW5zJ107XG4gICAgICBmcmFtZXdvcms6IENNU2VydmVyTGlic1snZnJhbWV3b3JrJ107XG4gICAgfVxuICApIHtcbiAgICB0aGlzLmFkYXB0ZXIgPSBhZGFwdGVyO1xuICAgIHRoaXMudGFncyA9IGxpYnMudGFncztcbiAgICB0aGlzLnRva2VucyA9IGxpYnMudG9rZW5zO1xuICAgIHRoaXMuZnJhbWV3b3JrID0gbGlicy5mcmFtZXdvcms7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZ2V0QnlJZCh1c2VyOiBGcmFtZXdvcmtVc2VyLCBiZWF0SWQ6IHN0cmluZyk6IFByb21pc2U8Q01CZWF0IHwgbnVsbD4ge1xuICAgIGNvbnN0IGJlYXQgPSBhd2FpdCB0aGlzLmFkYXB0ZXIuZ2V0KHVzZXIsIGJlYXRJZCk7XG4gICAgcmV0dXJuIGJlYXQgJiYgYmVhdC5hY3RpdmUgPyBiZWF0IDogbnVsbDtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBnZXRCeUlkcyh1c2VyOiBGcmFtZXdvcmtVc2VyLCBiZWF0SWRzOiBzdHJpbmdbXSk6IFByb21pc2U8Q01CZWF0W10+IHtcbiAgICBjb25zdCBiZWF0cyA9IGF3YWl0IHRoaXMuYWRhcHRlci5nZXRXaXRoSWRzKHVzZXIsIGJlYXRJZHMpO1xuICAgIHJldHVybiBiZWF0cy5maWx0ZXIoYmVhdCA9PiBiZWF0LmFjdGl2ZSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZ2V0QWxsKHVzZXI6IEZyYW1ld29ya1VzZXIsIEVTUXVlcnk/OiBhbnkpIHtcbiAgICByZXR1cm4gKGF3YWl0IHRoaXMuYWRhcHRlci5nZXRBbGwodXNlciwgRVNRdWVyeSkpLmZpbHRlcihcbiAgICAgIChiZWF0OiBDTUJlYXQpID0+IGJlYXQuYWN0aXZlID09PSB0cnVlXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBnZXRBbGxXaXRoVGFnKHVzZXI6IEZyYW1ld29ya1VzZXIsIHRhZ0lkOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gKGF3YWl0IHRoaXMuYWRhcHRlci5nZXRBbGxXaXRoVGFncyh1c2VyLCBbdGFnSWRdKSkuZmlsdGVyKFxuICAgICAgKGJlYXQ6IENNQmVhdCkgPT4gYmVhdC5hY3RpdmUgPT09IHRydWVcbiAgICApO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGdldEJ5RW5yb2xsbWVudFRva2VuKHVzZXI6IEZyYW1ld29ya1VzZXIsIGVucm9sbG1lbnRUb2tlbjogc3RyaW5nKSB7XG4gICAgY29uc3QgYmVhdCA9IGF3YWl0IHRoaXMuYWRhcHRlci5nZXRCZWF0V2l0aFRva2VuKHVzZXIsIGVucm9sbG1lbnRUb2tlbik7XG4gICAgcmV0dXJuIGJlYXQgJiYgYmVhdC5hY3RpdmUgPyBiZWF0IDogbnVsbDtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyB1cGRhdGUodXNlck9yVG9rZW46IFVzZXJPclRva2VuLCBiZWF0SWQ6IHN0cmluZywgYmVhdERhdGE6IFBhcnRpYWw8Q01CZWF0Pikge1xuICAgIGNvbnN0IGJlYXQgPSBhd2FpdCB0aGlzLmFkYXB0ZXIuZ2V0KHRoaXMuZnJhbWV3b3JrLmludGVybmFsVXNlciwgYmVhdElkKTtcblxuICAgIC8vIEZJWE1FIG1ha2UgcmV0dXJuIHR5cGUgZW51bVxuICAgIGlmIChiZWF0ID09PSBudWxsKSB7XG4gICAgICByZXR1cm4gJ2JlYXQtbm90LWZvdW5kJztcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIHVzZXJPclRva2VuID09PSAnc3RyaW5nJykge1xuICAgICAgY29uc3QgeyB2ZXJpZmllZDogaXNBY2Nlc3NUb2tlblZhbGlkIH0gPSB0aGlzLnRva2Vucy52ZXJpZnlUb2tlbihcbiAgICAgICAgYmVhdCA/IGJlYXQuYWNjZXNzX3Rva2VuIDogJycsXG4gICAgICAgIHVzZXJPclRva2VuXG4gICAgICApO1xuICAgICAgaWYgKCFpc0FjY2Vzc1Rva2VuVmFsaWQpIHtcbiAgICAgICAgcmV0dXJuICdpbnZhbGlkLWFjY2Vzcy10b2tlbic7XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgdXNlciA9IHR5cGVvZiB1c2VyT3JUb2tlbiA9PT0gJ3N0cmluZycgPyB0aGlzLmZyYW1ld29yay5pbnRlcm5hbFVzZXIgOiB1c2VyT3JUb2tlbjtcblxuICAgIGF3YWl0IHRoaXMuYWRhcHRlci51cGRhdGUodXNlciwge1xuICAgICAgLi4uYmVhdCxcbiAgICAgIC4uLmJlYXREYXRhLFxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGVucm9sbEJlYXQoXG4gICAgZW5yb2xsbWVudFRva2VuOiBzdHJpbmcsXG4gICAgYmVhdElkOiBzdHJpbmcsXG4gICAgcmVtb3RlQWRkcmVzczogc3RyaW5nLFxuICAgIGJlYXQ6IFBhcnRpYWw8Q01CZWF0PlxuICApOiBQcm9taXNlPHsgc3RhdHVzOiBzdHJpbmc7IGFjY2Vzc1Rva2VuPzogc3RyaW5nIH0+IHtcbiAgICBjb25zdCB7IHRva2VuLCBleHBpcmVzX29uIH0gPSBhd2FpdCB0aGlzLnRva2Vucy5nZXRFbnJvbGxtZW50VG9rZW4oZW5yb2xsbWVudFRva2VuKTtcbiAgICBpZiAoZXhwaXJlc19vbiAmJiBtb21lbnQoZXhwaXJlc19vbikuaXNCZWZvcmUobW9tZW50KCkpKSB7XG4gICAgICByZXR1cm4geyBzdGF0dXM6IEJlYXRFbnJvbGxtZW50U3RhdHVzLkV4cGlyZWRFbnJvbGxtZW50VG9rZW4gfTtcbiAgICB9XG4gICAgaWYgKCF0b2tlbikge1xuICAgICAgcmV0dXJuIHsgc3RhdHVzOiBCZWF0RW5yb2xsbWVudFN0YXR1cy5JbnZhbGlkRW5yb2xsbWVudFRva2VuIH07XG4gICAgfVxuXG4gICAgY29uc3QgZXhpc3RpbmdCZWF0ID0gYXdhaXQgdGhpcy5nZXRCeUlkKHRoaXMuZnJhbWV3b3JrLmludGVybmFsVXNlciwgYmVhdElkKTtcbiAgICBpZiAoZXhpc3RpbmdCZWF0KSB7XG4gICAgICByZXR1cm4geyBzdGF0dXM6IEJlYXRFbnJvbGxtZW50U3RhdHVzLlN1Y2Nlc3MgfTtcbiAgICB9XG5cbiAgICBjb25zdCBhY2Nlc3NUb2tlbiA9IHRoaXMudG9rZW5zLmdlbmVyYXRlQWNjZXNzVG9rZW4oKTtcbiAgICBjb25zdCB2ZXJpZmllZE9uID0gbW9tZW50KCkudG9KU09OKCk7XG5cbiAgICBhd2FpdCB0aGlzLmFkYXB0ZXIuaW5zZXJ0KHRoaXMuZnJhbWV3b3JrLmludGVybmFsVXNlciwge1xuICAgICAgdGFnczogW10sXG4gICAgICAuLi5iZWF0LFxuICAgICAgYWN0aXZlOiB0cnVlLFxuICAgICAgZW5yb2xsbWVudF90b2tlbjogZW5yb2xsbWVudFRva2VuLFxuICAgICAgdmVyaWZpZWRfb246IHZlcmlmaWVkT24sXG4gICAgICBhY2Nlc3NfdG9rZW46IGFjY2Vzc1Rva2VuLFxuICAgICAgaG9zdF9pcDogcmVtb3RlQWRkcmVzcyxcbiAgICAgIGlkOiBiZWF0SWQsXG4gICAgfSBhcyBDTUJlYXQpO1xuXG4gICAgYXdhaXQgdGhpcy50b2tlbnMuZGVsZXRlRW5yb2xsbWVudFRva2VuKGVucm9sbG1lbnRUb2tlbik7XG5cbiAgICByZXR1cm4geyBzdGF0dXM6IEJlYXRFbnJvbGxtZW50U3RhdHVzLlN1Y2Nlc3MsIGFjY2Vzc1Rva2VuIH07XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgcmVtb3ZlVGFnc0Zyb21CZWF0cyhcbiAgICB1c2VyOiBGcmFtZXdvcmtVc2VyLFxuICAgIHJlbW92YWxzOiBCZWF0c1RhZ0Fzc2lnbm1lbnRbXVxuICApOiBQcm9taXNlPEJlYXRzUmVtb3ZhbFJldHVybj4ge1xuICAgIGNvbnN0IGJlYXRJZHMgPSB1bmlxKHJlbW92YWxzLm1hcChyZW1vdmFsID0+IHJlbW92YWwuYmVhdElkKSk7XG4gICAgY29uc3QgdGFnSWRzID0gdW5pcShyZW1vdmFscy5tYXAocmVtb3ZhbCA9PiByZW1vdmFsLnRhZykpO1xuXG4gICAgY29uc3QgcmVzcG9uc2UgPSB7XG4gICAgICByZW1vdmFsczogcmVtb3ZhbHMubWFwKCgpID0+ICh7IHN0YXR1czogbnVsbCB9KSksXG4gICAgfTtcblxuICAgIGNvbnN0IGJlYXRzID0gYXdhaXQgdGhpcy5hZGFwdGVyLmdldFdpdGhJZHModXNlciwgYmVhdElkcyk7XG4gICAgY29uc3QgdGFncyA9IGF3YWl0IHRoaXMudGFncy5nZXRXaXRoSWRzKHVzZXIsIHRhZ0lkcyk7XG5cbiAgICAvLyBIYW5kbGUgYXNzaWdubWVudHMgY29udGFpbmluZyBub24tZXhpc3RpbmcgYmVhdCBJRHMgb3IgdGFnc1xuICAgIGNvbnN0IG5vbkV4aXN0ZW50QmVhdElkcyA9IGZpbmROb25FeGlzdGVudEl0ZW1zKGJlYXRzLCBiZWF0SWRzKTtcbiAgICBjb25zdCBub25FeGlzdGVudFRhZ3MgPSBhd2FpdCBmaW5kTm9uRXhpc3RlbnRJdGVtcyh0YWdzLCB0YWdJZHMpO1xuXG4gICAgYWRkTm9uRXhpc3RlbnRJdGVtVG9SZXNwb25zZShcbiAgICAgIHJlc3BvbnNlLFxuICAgICAgcmVtb3ZhbHMsXG4gICAgICBub25FeGlzdGVudEJlYXRJZHMsXG4gICAgICBub25FeGlzdGVudFRhZ3MsXG4gICAgICAncmVtb3ZhbHMnXG4gICAgKTtcblxuICAgIC8vIEZJWE1FIGFic3RyYWN0IHRoaXNcbiAgICBjb25zdCB2YWxpZFJlbW92YWxzID0gcmVtb3ZhbHNcbiAgICAgIC5tYXAoKHJlbW92YWwsIGlkeEluUmVxdWVzdCkgPT4gKHtcbiAgICAgICAgYmVhdElkOiByZW1vdmFsLmJlYXRJZCxcbiAgICAgICAgaWR4SW5SZXF1ZXN0LCAvLyBzbyB3ZSBjYW4gYWRkIHRoZSByZXN1bHQgb2YgdGhpcyByZW1vdmFsIHRvIHRoZSBjb3JyZWN0IHBsYWNlIGluIHRoZSByZXNwb25zZVxuICAgICAgICB0YWc6IHJlbW92YWwudGFnLFxuICAgICAgfSkpXG4gICAgICAuZmlsdGVyKChyZW1vdmFsLCBpZHgpID0+IHJlc3BvbnNlLnJlbW92YWxzW2lkeF0uc3RhdHVzID09PSBudWxsKTtcblxuICAgIGlmICh2YWxpZFJlbW92YWxzLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IHJlbW92YWxSZXN1bHRzID0gYXdhaXQgdGhpcy5hZGFwdGVyLnJlbW92ZVRhZ3NGcm9tQmVhdHModXNlciwgdmFsaWRSZW1vdmFscyk7XG4gICAgICByZXR1cm4gYWRkVG9SZXN1bHRzVG9SZXNwb25zZSgncmVtb3ZhbHMnLCByZXNwb25zZSwgcmVtb3ZhbFJlc3VsdHMpO1xuICAgIH1cbiAgICByZXR1cm4gcmVzcG9uc2U7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgYXNzaWduVGFnc1RvQmVhdHMoXG4gICAgdXNlcjogRnJhbWV3b3JrVXNlcixcbiAgICBhc3NpZ25tZW50czogQmVhdHNUYWdBc3NpZ25tZW50W11cbiAgKTogUHJvbWlzZTxDTUFzc2lnbm1lbnRSZXR1cm4+IHtcbiAgICBjb25zdCBiZWF0SWRzID0gdW5pcShhc3NpZ25tZW50cy5tYXAoYXNzaWdubWVudCA9PiBhc3NpZ25tZW50LmJlYXRJZCkpO1xuICAgIGNvbnN0IHRhZ0lkcyA9IHVuaXEoYXNzaWdubWVudHMubWFwKGFzc2lnbm1lbnQgPT4gYXNzaWdubWVudC50YWcpKTtcblxuICAgIGNvbnN0IHJlc3BvbnNlID0ge1xuICAgICAgYXNzaWdubWVudHM6IGFzc2lnbm1lbnRzLm1hcCgoKSA9PiAoeyBzdGF0dXM6IG51bGwgfSkpLFxuICAgIH07XG4gICAgY29uc3QgYmVhdHMgPSBhd2FpdCB0aGlzLmFkYXB0ZXIuZ2V0V2l0aElkcyh1c2VyLCBiZWF0SWRzKTtcbiAgICBjb25zdCB0YWdzID0gYXdhaXQgdGhpcy50YWdzLmdldFdpdGhJZHModXNlciwgdGFnSWRzKTtcbiAgICAvLyBIYW5kbGUgYXNzaWdubWVudHMgY29udGFpbmluZyBub24tZXhpc3RpbmcgYmVhdCBJRHMgb3IgdGFnc1xuICAgIGNvbnN0IG5vbkV4aXN0ZW50QmVhdElkcyA9IGZpbmROb25FeGlzdGVudEl0ZW1zKGJlYXRzLCBiZWF0SWRzKTtcbiAgICBjb25zdCBub25FeGlzdGVudFRhZ3MgPSBmaW5kTm9uRXhpc3RlbnRJdGVtcyh0YWdzLCB0YWdJZHMpO1xuXG4gICAgLy8gRklYTUUgYnJlYWsgb3V0IGJhY2sgaW50byByb3V0ZSAvIGZ1bmN0aW9uIHJlc3BvbnNlXG4gICAgLy8gRklYTUUgY2F1c2VzIGZ1bmN0aW9uIHRvIGVycm9yIGlmIGEgYmVhdCBvciB0YWcgZG9lcyBub3QgZXhpc3RcbiAgICBhZGROb25FeGlzdGVudEl0ZW1Ub1Jlc3BvbnNlKFxuICAgICAgcmVzcG9uc2UsXG4gICAgICBhc3NpZ25tZW50cyxcbiAgICAgIG5vbkV4aXN0ZW50QmVhdElkcyxcbiAgICAgIG5vbkV4aXN0ZW50VGFncyxcbiAgICAgICdhc3NpZ25tZW50cydcbiAgICApO1xuXG4gICAgLy8gRklYTUUgYWJzdHJhY3QgdGhpc1xuICAgIGNvbnN0IHZhbGlkQXNzaWdubWVudHMgPSBhc3NpZ25tZW50c1xuICAgICAgLm1hcCgoYXNzaWdubWVudCwgaWR4SW5SZXF1ZXN0KSA9PiAoe1xuICAgICAgICBiZWF0SWQ6IGFzc2lnbm1lbnQuYmVhdElkLFxuICAgICAgICBpZHhJblJlcXVlc3QsIC8vIHNvIHdlIGNhbiBhZGQgdGhlIHJlc3VsdCBvZiB0aGlzIGFzc2lnbm1lbnQgdG8gdGhlIGNvcnJlY3QgcGxhY2UgaW4gdGhlIHJlc3BvbnNlXG4gICAgICAgIHRhZzogYXNzaWdubWVudC50YWcsXG4gICAgICB9KSlcbiAgICAgIC5maWx0ZXIoKGFzc2lnbm1lbnQsIGlkeCkgPT4gcmVzcG9uc2UuYXNzaWdubWVudHNbaWR4XS5zdGF0dXMgPT09IG51bGwpO1xuXG4gICAgaWYgKHZhbGlkQXNzaWdubWVudHMubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3QgYXNzaWdubWVudFJlc3VsdHMgPSBhd2FpdCB0aGlzLmFkYXB0ZXIuYXNzaWduVGFnc1RvQmVhdHModXNlciwgdmFsaWRBc3NpZ25tZW50cyk7XG5cbiAgICAgIC8vIFRPRE8gVGhpcyBzaG91bGQgcHJvYiBub3QgbXV0YXRlXG4gICAgICByZXR1cm4gYWRkVG9SZXN1bHRzVG9SZXNwb25zZSgnYXNzaWdubWVudHMnLCByZXNwb25zZSwgYXNzaWdubWVudFJlc3VsdHMpO1xuICAgIH1cbiAgICByZXR1cm4gcmVzcG9uc2U7XG4gIH1cbn1cblxuLy8gRklYTUUgYWJzdHJhY3QgdG8gdGhlIHJvdXRlLCBhbHNvIHRoZSBrZXkgYXJnIGlzIGEgdGVtcCBmaXhcbmZ1bmN0aW9uIGFkZE5vbkV4aXN0ZW50SXRlbVRvUmVzcG9uc2UoXG4gIHJlc3BvbnNlOiBhbnksXG4gIGFzc2lnbm1lbnRzOiBhbnksXG4gIG5vbkV4aXN0ZW50QmVhdElkczogYW55LFxuICBub25FeGlzdGVudFRhZ3M6IGFueSxcbiAga2V5OiBzdHJpbmdcbikge1xuICBhc3NpZ25tZW50cy5mb3JFYWNoKCh7IGJlYXRJZCwgdGFnIH06IEJlYXRzVGFnQXNzaWdubWVudCwgaWR4OiBhbnkpID0+IHtcbiAgICBjb25zdCBpc0JlYXROb25FeGlzdGVudCA9IG5vbkV4aXN0ZW50QmVhdElkcy5pbmNsdWRlcyhiZWF0SWQpO1xuXG4gICAgY29uc3QgaXNUYWdOb25FeGlzdGVudCA9IG5vbkV4aXN0ZW50VGFncy5pbmNsdWRlcyh0YWcpO1xuXG4gICAgaWYgKGlzQmVhdE5vbkV4aXN0ZW50ICYmIGlzVGFnTm9uRXhpc3RlbnQpIHtcbiAgICAgIHJlc3BvbnNlW2tleV1baWR4XS5zdGF0dXMgPSA0MDQ7XG4gICAgICByZXNwb25zZVtrZXldW2lkeF0ucmVzdWx0ID0gYEJlYXQgJHtiZWF0SWR9IGFuZCB0YWcgJHt0YWd9IG5vdCBmb3VuZGA7XG4gICAgfSBlbHNlIGlmIChpc0JlYXROb25FeGlzdGVudCkge1xuICAgICAgcmVzcG9uc2Vba2V5XVtpZHhdLnN0YXR1cyA9IDQwNDtcbiAgICAgIHJlc3BvbnNlW2tleV1baWR4XS5yZXN1bHQgPSBgQmVhdCAke2JlYXRJZH0gbm90IGZvdW5kYDtcbiAgICB9IGVsc2UgaWYgKGlzVGFnTm9uRXhpc3RlbnQpIHtcbiAgICAgIHJlc3BvbnNlW2tleV1baWR4XS5zdGF0dXMgPSA0MDQ7XG4gICAgICByZXNwb25zZVtrZXldW2lkeF0ucmVzdWx0ID0gYFRhZyAke3RhZ30gbm90IGZvdW5kYDtcbiAgICB9XG4gIH0pO1xufVxuXG4vLyBUT0RPIGRvbnQgbXV0YXRlIHJlc3BvbnNlXG5mdW5jdGlvbiBhZGRUb1Jlc3VsdHNUb1Jlc3BvbnNlKGtleTogc3RyaW5nLCByZXNwb25zZTogYW55LCBhc3NpZ25tZW50UmVzdWx0czogYW55KSB7XG4gIGFzc2lnbm1lbnRSZXN1bHRzLmZvckVhY2goKGFzc2lnbm1lbnRSZXN1bHQ6IGFueSkgPT4ge1xuICAgIGNvbnN0IHsgaWR4SW5SZXF1ZXN0LCBzdGF0dXMsIHJlc3VsdCB9ID0gYXNzaWdubWVudFJlc3VsdDtcbiAgICByZXNwb25zZVtrZXldW2lkeEluUmVxdWVzdF0uc3RhdHVzID0gc3RhdHVzO1xuICAgIHJlc3BvbnNlW2tleV1baWR4SW5SZXF1ZXN0XS5yZXN1bHQgPSByZXN1bHQ7XG4gIH0pO1xuICByZXR1cm4gcmVzcG9uc2U7XG59XG4iXX0=