"use strict";
/*
 * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
 * or more contributor license agreements. Licensed under the Elastic License;
 * you may not use this file except in compliance with the Elastic License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const lodash_1 = require("lodash");
const v4_1 = tslib_1.__importDefault(require("uuid/v4"));
const constants_1 = require("../../../../common/constants");
class ElasticsearchConfigurationBlockAdapter {
    constructor(database) {
        this.database = database;
    }
    async getByIds(user, ids) {
        if (ids.length === 0) {
            return [];
        }
        const params = {
            ignore: [404],
            _source: true,
            size: 10000,
            index: constants_1.INDEX_NAMES.BEATS,
            type: '_doc',
            body: {
                ids: ids.map(id => `configuration_block:${id}`),
            },
        };
        const response = await this.database.search(user, params);
        const configs = lodash_1.get(response, 'hits.hits', []);
        return configs.map((tag) => ({ ...tag._source.tag, config: JSON.parse(tag._source.tag) }));
    }
    async getForTags(user, tagIds, page = 0, size = 100) {
        if (tagIds.length === 0) {
            return {
                page: 0,
                total: 0,
                blocks: [],
            };
        }
        const params = {
            ignore: [404],
            index: constants_1.INDEX_NAMES.BEATS,
            type: '_doc',
            body: {
                from: page === -1 ? undefined : page * size,
                size,
                query: {
                    terms: { 'configuration_block.tag': tagIds },
                },
            },
        };
        let response;
        if (page === -1) {
            response = await this.database.searchAll(user, params);
        }
        else {
            response = await this.database.search(user, params);
        }
        const configs = lodash_1.get(response, 'hits.hits', []);
        return {
            blocks: configs.map((block) => ({
                ...block._source.configuration_block,
                config: JSON.parse(block._source.configuration_block.config || '{}'),
            })),
            page,
            total: response.hits ? response.hits.total.value : 0,
        };
    }
    async delete(user, ids) {
        const result = await this.database.bulk(user, {
            body: ids.map(id => ({ delete: { _id: `configuration_block:${id}` } })),
            index: constants_1.INDEX_NAMES.BEATS,
            refresh: 'wait_for',
            type: '_doc',
        });
        if (result.errors) {
            if (result.items[0].result) {
                throw new Error(result.items[0].result);
            }
            throw new Error(result.items[0].index.error.reason);
        }
        return result.items.map((item) => {
            return {
                id: item.delete._id,
                success: item.delete.result === 'deleted',
                reason: item.delete.result !== 'deleted' ? item.delete.result : undefined,
            };
        });
    }
    async deleteForTags(user, tagIds) {
        const result = await this.database.deleteByQuery(user, {
            body: {
                query: {
                    terms: { 'configuration_block.tag': tagIds },
                },
            },
            index: constants_1.INDEX_NAMES.BEATS,
            type: '_doc',
        });
        if (result.failures.length > 0) {
            return {
                success: false,
                reason: result.failures[0],
            };
        }
        return {
            success: true,
        };
    }
    async create(user, configs) {
        const body = lodash_1.flatten(configs.map(config => {
            const id = config.id || v4_1.default();
            return [
                { index: { _id: `configuration_block:${id}` } },
                {
                    type: 'configuration_block',
                    configuration_block: { id, ...config, config: JSON.stringify(config.config) },
                },
            ];
        }));
        const result = await this.database.bulk(user, {
            body,
            index: constants_1.INDEX_NAMES.BEATS,
            refresh: 'wait_for',
            type: '_doc',
        });
        if (result.errors) {
            if (result.items[0].result) {
                throw new Error(result.items[0].result);
            }
            throw new Error(result.items[0].index.error.reason);
        }
        return result.items.map((item) => item.index._id);
    }
}
exports.ElasticsearchConfigurationBlockAdapter = ElasticsearchConfigurationBlockAdapter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL2hvbWUvYW50aG9ueS9naXRfd29ya3NwYWNlcy9raWJhbmEveC1wYWNrL3BsdWdpbnMvYmVhdHNfbWFuYWdlbWVudC9zZXJ2ZXIvbGliL2FkYXB0ZXJzL2NvbmZpZ3VyYXRpb25fYmxvY2tzL2VsYXN0aWNzZWFyY2hfY29uZmlndXJhdGlvbl9ibG9ja19hZGFwdGVyLnRzIiwic291cmNlcyI6WyIvaG9tZS9hbnRob255L2dpdF93b3Jrc3BhY2VzL2tpYmFuYS94LXBhY2svcGx1Z2lucy9iZWF0c19tYW5hZ2VtZW50L3NlcnZlci9saWIvYWRhcHRlcnMvY29uZmlndXJhdGlvbl9ibG9ja3MvZWxhc3RpY3NlYXJjaF9jb25maWd1cmF0aW9uX2Jsb2NrX2FkYXB0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7O0dBSUc7OztBQUVILG1DQUFzQztBQUN0Qyx5REFBNkI7QUFDN0IsNERBQTJEO0FBTTNELE1BQWEsc0NBQXNDO0lBR2pELFlBQVksUUFBeUI7UUFDbkMsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7SUFDM0IsQ0FBQztJQUVNLEtBQUssQ0FBQyxRQUFRLENBQUMsSUFBbUIsRUFBRSxHQUFhO1FBQ3RELElBQUksR0FBRyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7WUFDcEIsT0FBTyxFQUFFLENBQUM7U0FDWDtRQUVELE1BQU0sTUFBTSxHQUFHO1lBQ2IsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDO1lBQ2IsT0FBTyxFQUFFLElBQUk7WUFDYixJQUFJLEVBQUUsS0FBSztZQUNYLEtBQUssRUFBRSx1QkFBVyxDQUFDLEtBQUs7WUFDeEIsSUFBSSxFQUFFLE1BQU07WUFDWixJQUFJLEVBQUU7Z0JBQ0osR0FBRyxFQUFFLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyx1QkFBdUIsRUFBRSxFQUFFLENBQUM7YUFDaEQ7U0FDRixDQUFDO1FBRUYsTUFBTSxRQUFRLEdBQUcsTUFBTSxJQUFJLENBQUMsUUFB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LENBQUMsQ0FBQyxDQUFTLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUM5RDtRQUVELE9BQU8sTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFTLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDekQsQ0FBQztDQUNGO0FBNUpELHdGQTRKQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgRWxhc3RpY3NlYXJjaCBCLlYuIGFuZC9vciBsaWNlbnNlZCB0byBFbGFzdGljc2VhcmNoIEIuVi4gdW5kZXIgb25lXG4gKiBvciBtb3JlIGNvbnRyaWJ1dG9yIGxpY2Vuc2UgYWdyZWVtZW50cy4gTGljZW5zZWQgdW5kZXIgdGhlIEVsYXN0aWMgTGljZW5zZTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgRWxhc3RpYyBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IGZsYXR0ZW4sIGdldCB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgdXVpZHY0IGZyb20gJ3V1aWQvdjQnO1xuaW1wb3J0IHsgSU5ERVhfTkFNRVMgfSBmcm9tICcuLi8uLi8uLi8uLi9jb21tb24vY29uc3RhbnRzJztcbmltcG9ydCB7IENvbmZpZ3VyYXRpb25CbG9jayB9IGZyb20gJy4uLy4uLy4uLy4uL2NvbW1vbi9kb21haW5fdHlwZXMnO1xuaW1wb3J0IHsgRGF0YWJhc2VBZGFwdGVyIH0gZnJvbSAnLi4vZGF0YWJhc2UvYWRhcHRlcl90eXBlcyc7XG5pbXBvcnQgeyBGcmFtZXdvcmtVc2VyIH0gZnJvbSAnLi4vZnJhbWV3b3JrL2FkYXB0ZXJfdHlwZXMnO1xuaW1wb3J0IHsgQ29uZmlndXJhdGlvbkJsb2NrQWRhcHRlciB9IGZyb20gJy4vYWRhcHRlcl90eXBlcyc7XG5cbmV4cG9ydCBjbGFzcyBFbGFzdGljc2VhcmNoQ29uZmlndXJhdGlvbkJsb2NrQWRhcHRlciBpbXBsZW1lbnRzIENvbmZpZ3VyYXRpb25CbG9ja0FkYXB0ZXIge1xuICBwcml2YXRlIGRhdGFiYXNlOiBEYXRhYmFzZUFkYXB0ZXI7XG5cbiAgY29uc3RydWN0b3IoZGF0YWJhc2U6IERhdGFiYXNlQWRhcHRlcikge1xuICAgIHRoaXMuZGF0YWJhc2UgPSBkYXRhYmFzZTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBnZXRCeUlkcyh1c2VyOiBGcmFtZXdvcmtVc2VyLCBpZHM6IHN0cmluZ1tdKTogUHJvbWlzZTxDb25maWd1cmF0aW9uQmxvY2tbXT4ge1xuICAgIGlmIChpZHMubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuXG4gICAgY29uc3QgcGFyYW1zID0ge1xuICAgICAgaWdub3JlOiBbNDA0XSxcbiAgICAgIF9zb3VyY2U6IHRydWUsXG4gICAgICBzaXplOiAxMDAwMCxcbiAgICAgIGluZGV4OiBJTkRFWF9OQU1FUy5CRUFUUyxcbiAgICAgIHR5cGU6ICdfZG9jJyxcbiAgICAgIGJvZHk6IHtcbiAgICAgICAgaWRzOiBpZHMubWFwKGlkID0+IGBjb25maWd1cmF0aW9uX2Jsb2NrOiR7aWR9YCksXG4gICAgICB9LFxuICAgIH07XG5cbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuZGF0YWJhc2Uuc2VhcmNoKHVzZXIsIHBhcmFtcyk7XG4gICAgY29uc3QgY29uZmlncyA9IGdldDxhbnk+KHJlc3BvbnNlLCAnaGl0cy5oaXRzJywgW10pO1xuXG4gICAgcmV0dXJuIGNvbmZpZ3MubWFwKCh0YWc6IGFueSkgPT4gKHsgLi4udGFnLl9zb3VyY2UudGFnLCBjb25maWc6IEpTT04ucGFyc2UodGFnLl9zb3VyY2UudGFnKSB9KSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZ2V0Rm9yVGFncyhcbiAgICB1c2VyOiBGcmFtZXdvcmtVc2VyLFxuICAgIHRhZ0lkczogc3RyaW5nW10sXG4gICAgcGFnZTogbnVtYmVyID0gMCxcbiAgICBzaXplOiBudW1iZXIgPSAxMDBcbiAgKTogUHJvbWlzZTx7IGJsb2NrczogQ29uZmlndXJhdGlvbkJsb2NrW107IHBhZ2U6IG51bWJlcjsgdG90YWw6IG51bWJlciB9PiB7XG4gICAgaWYgKHRhZ0lkcy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHBhZ2U6IDAsXG4gICAgICAgIHRvdGFsOiAwLFxuICAgICAgICBibG9ja3M6IFtdIGFzIENvbmZpZ3VyYXRpb25CbG9ja1tdLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICBjb25zdCBwYXJhbXMgPSB7XG4gICAgICBpZ25vcmU6IFs0MDRdLFxuICAgICAgaW5kZXg6IElOREVYX05BTUVTLkJFQVRTLFxuICAgICAgdHlwZTogJ19kb2MnLFxuICAgICAgYm9keToge1xuICAgICAgICBmcm9tOiBwYWdlID09PSAtMSA/IHVuZGVmaW5lZCA6IHBhZ2UgKiBzaXplLFxuICAgICAgICBzaXplLFxuICAgICAgICBxdWVyeToge1xuICAgICAgICAgIHRlcm1zOiB7ICdjb25maWd1cmF0aW9uX2Jsb2NrLnRhZyc6IHRhZ0lkcyB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9O1xuICAgIGxldCByZXNwb25zZTtcbiAgICBpZiAocGFnZSA9PT0gLTEpIHtcbiAgICAgIHJlc3BvbnNlID0gYXdhaXQgdGhpcy5kYXRhYmFzZS5zZWFyY2hBbGwodXNlciwgcGFyYW1zKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLmRhdGFiYXNlLnNlYXJjaCh1c2VyLCBwYXJhbXMpO1xuICAgIH1cbiAgICBjb25zdCBjb25maWdzID0gZ2V0PGFueT4ocmVzcG9uc2UsICdoaXRzLmhpdHMnLCBbXSk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgYmxvY2tzOiBjb25maWdzLm1hcCgoYmxvY2s6IGFueSkgPT4gKHtcbiAgICAgICAgLi4uYmxvY2suX3NvdXJjZS5jb25maWd1cmF0aW9uX2Jsb2NrLFxuICAgICAgICBjb25maWc6IEpTT04ucGFyc2UoYmxvY2suX3NvdXJjZS5jb25maWd1cmF0aW9uX2Jsb2NrLmNvbmZpZyB8fCAne30nKSxcbiAgICAgIH0pKSxcbiAgICAgIHBhZ2UsXG4gICAgICB0b3RhbDogcmVzcG9uc2UuaGl0cyA/IChyZXNwb25zZS5oaXRzLnRvdGFsIGFzIGFueSkudmFsdWUgOiAwLFxuICAgIH07XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZGVsZXRlKFxuICAgIHVzZXI6IEZyYW1ld29ya1VzZXIsXG4gICAgaWRzOiBzdHJpbmdbXVxuICApOiBQcm9taXNlPEFycmF5PHsgaWQ6IHN0cmluZzsgc3VjY2VzczogYm9vbGVhbjsgcmVhc29uPzogc3RyaW5nIH0+PiB7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5kYXRhYmFzZS5idWxrKHVzZXIsIHtcbiAgICAgIGJvZHk6IGlkcy5tYXAoaWQgPT4gKHsgZGVsZXRlOiB7IF9pZDogYGNvbmZpZ3VyYXRpb25fYmxvY2s6JHtpZH1gIH0gfSkpLFxuICAgICAgaW5kZXg6IElOREVYX05BTUVTLkJFQVRTLFxuICAgICAgcmVmcmVzaDogJ3dhaXRfZm9yJyxcbiAgICAgIHR5cGU6ICdfZG9jJyxcbiAgICB9KTtcblxuICAgIGlmIChyZXN1bHQuZXJyb3JzKSB7XG4gICAgICBpZiAocmVzdWx0Lml0ZW1zWzBdLnJlc3VsdCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IocmVzdWx0Lml0ZW1zWzBdLnJlc3VsdCk7XG4gICAgICB9XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoKHJlc3VsdC5pdGVtc1swXSBhcyBhbnkpLmluZGV4LmVycm9yLnJlYXNvbik7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3VsdC5pdGVtcy5tYXAoKGl0ZW06IGFueSkgPT4ge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgaWQ6IGl0ZW0uZGVsZXRlLl9pZCxcbiAgICAgICAgc3VjY2VzczogaXRlbS5kZWxldGUucmVzdWx0ID09PSAnZGVsZXRlZCcsXG4gICAgICAgIHJlYXNvbjogaXRlbS5kZWxldGUucmVzdWx0ICE9PSAnZGVsZXRlZCcgPyBpdGVtLmRlbGV0ZS5yZXN1bHQgOiB1bmRlZmluZWQsXG4gICAgICB9O1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGRlbGV0ZUZvclRhZ3MoXG4gICAgdXNlcjogRnJhbWV3b3JrVXNlcixcbiAgICB0YWdJZHM6IHN0cmluZ1tdXG4gICk6IFByb21pc2U8eyBzdWNjZXNzOiBib29sZWFuOyByZWFzb24/OiBzdHJpbmcgfT4ge1xuICAgIGNvbnN0IHJlc3VsdDogYW55ID0gYXdhaXQgdGhpcy5kYXRhYmFzZS5kZWxldGVCeVF1ZXJ5KHVzZXIsIHtcbiAgICAgIGJvZHk6IHtcbiAgICAgICAgcXVlcnk6IHtcbiAgICAgICAgICB0ZXJtczogeyAnY29uZmlndXJhdGlvbl9ibG9jay50YWcnOiB0YWdJZHMgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgICBpbmRleDogSU5ERVhfTkFNRVMuQkVBVFMsXG4gICAgICB0eXBlOiAnX2RvYycsXG4gICAgfSk7XG5cbiAgICBpZiAocmVzdWx0LmZhaWx1cmVzLmxlbmd0aCA+IDApIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICByZWFzb246IHJlc3VsdC5mYWlsdXJlc1swXSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgfTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBjcmVhdGUodXNlcjogRnJhbWV3b3JrVXNlciwgY29uZmlnczogQ29uZmlndXJhdGlvbkJsb2NrW10pOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gICAgY29uc3QgYm9keSA9IGZsYXR0ZW4oXG4gICAgICBjb25maWdzLm1hcChjb25maWcgPT4ge1xuICAgICAgICBjb25zdCBpZCA9IGNvbmZpZy5pZCB8fCB1dWlkdjQoKTtcbiAgICAgICAgcmV0dXJuIFtcbiAgICAgICAgICB7IGluZGV4OiB7IF9pZDogYGNvbmZpZ3VyYXRpb25fYmxvY2s6JHtpZH1gIH0gfSxcbiAgICAgICAgICB7XG4gICAgICAgICAgICB0eXBlOiAnY29uZmlndXJhdGlvbl9ibG9jaycsXG4gICAgICAgICAgICBjb25maWd1cmF0aW9uX2Jsb2NrOiB7IGlkLCAuLi5jb25maWcsIGNvbmZpZzogSlNPTi5zdHJpbmdpZnkoY29uZmlnLmNvbmZpZykgfSxcbiAgICAgICAgICB9LFxuICAgICAgICBdO1xuICAgICAgfSlcbiAgICApO1xuXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5kYXRhYmFzZS5idWxrKHVzZXIsIHtcbiAgICAgIGJvZHksXG4gICAgICBpbmRleDogSU5ERVhfTkFNRVMuQkVBVFMsXG4gICAgICByZWZyZXNoOiAnd2FpdF9mb3InLFxuICAgICAgdHlwZTogJ19kb2MnLFxuICAgIH0pO1xuXG4gICAgaWYgKHJlc3VsdC5lcnJvcnMpIHtcbiAgICAgIGlmIChyZXN1bHQuaXRlbXNbMF0ucmVzdWx0KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihyZXN1bHQuaXRlbXNbMF0ucmVzdWx0KTtcbiAgICAgIH1cbiAgICAgIHRocm93IG5ldyBFcnJvcigocmVzdWx0Lml0ZW1zWzBdIGFzIGFueSkuaW5kZXguZXJyb3IucmVhc29uKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVzdWx0Lml0ZW1zLm1hcCgoaXRlbTogYW55KSA9PiBpdGVtLmluZGV4Ll9pZCk7XG4gIH1cbn1cbiJdfQ==