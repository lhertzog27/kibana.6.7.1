"use strict";
/*
 * Licensed to Elasticsearch B.V. under one or more contributor
 * license agreements. See the NOTICE file distributed with
 * this work for additional information regarding copyright
 * ownership. Elasticsearch B.V. licenses this file to you under
 * the Apache License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const fs_1 = require("fs");
const path_1 = require("path");
const semver_1 = require("semver");
const util_1 = require("util");
const config_1 = require("../../config");
const plugin_discovery_error_1 = require("./plugin_discovery_error");
const fsReadFileAsync = util_1.promisify(fs_1.readFile);
const fsStatAsync = util_1.promisify(fs_1.stat);
/**
 * Name of the JSON manifest file that should be located in the plugin directory.
 */
const MANIFEST_FILE_NAME = 'kibana.json';
/**
 * The special "kibana" version can be used by the plugins to be always compatible.
 */
const ALWAYS_COMPATIBLE_VERSION = 'kibana';
/**
 * Names of the known manifest fields.
 */
const KNOWN_MANIFEST_FIELDS = (() => {
    // We use this trick to have type safety around the keys we use, if we forget to
    // add a new key here or misspell existing one, TypeScript compiler will complain.
    // We do this once at run time, so performance impact is negligible.
    const manifestFields = {
        id: true,
        kibanaVersion: true,
        version: true,
        configPath: true,
        requiredPlugins: true,
        optionalPlugins: true,
        ui: true,
        server: true,
    };
    return new Set(Object.keys(manifestFields));
})();
/**
 * Tries to load and parse the plugin manifest file located at the provided plugin
 * directory path and produces an error result if it fails to do so or plugin manifest
 * isn't valid.
 * @param pluginPath Path to the plugin directory where manifest should be loaded from.
 * @param packageInfo Kibana package info.
 * @internal
 */
async function parseManifest(pluginPath, packageInfo) {
    const manifestPath = path_1.resolve(pluginPath, MANIFEST_FILE_NAME);
    let manifestContent;
    try {
        manifestContent = await fsReadFileAsync(manifestPath);
    }
    catch (err) {
        throw plugin_discovery_error_1.PluginDiscoveryError.missingManifest(manifestPath, err);
    }
    let manifest;
    try {
        manifest = JSON.parse(manifestContent.toString());
    }
    catch (err) {
        throw plugin_discovery_error_1.PluginDiscoveryError.invalidManifest(manifestPath, err);
    }
    if (!manifest || typeof manifest !== 'object') {
        throw plugin_discovery_error_1.PluginDiscoveryError.invalidManifest(manifestPath, new Error('Plugin manifest must contain a JSON encoded object.'));
    }
    if (!manifest.id || typeof manifest.id !== 'string') {
        throw plugin_discovery_error_1.PluginDiscoveryError.invalidManifest(manifestPath, new Error('Plugin manifest must contain an "id" property.'));
    }
    // Plugin id can be used as a config path or as a logger context and having dots
    // in there may lead to various issues, so we forbid that.
    if (manifest.id.includes('.')) {
        throw plugin_discovery_error_1.PluginDiscoveryError.invalidManifest(manifestPath, new Error('Plugin "id" must not include `.` characters.'));
    }
    if (!manifest.version || typeof manifest.version !== 'string') {
        throw plugin_discovery_error_1.PluginDiscoveryError.invalidManifest(manifestPath, new Error(`Plugin manifest for "${manifest.id}" must contain a "version" property.`));
    }
    if (manifest.configPath !== undefined && !config_1.isConfigPath(manifest.configPath)) {
        throw plugin_discovery_error_1.PluginDiscoveryError.invalidManifest(manifestPath, new Error(`The "configPath" in plugin manifest for "${manifest.id}" should either be a string or an array of strings.`));
    }
    const expectedKibanaVersion = typeof manifest.kibanaVersion === 'string' && manifest.kibanaVersion
        ? manifest.kibanaVersion
        : manifest.version;
    if (!isVersionCompatible(expectedKibanaVersion, packageInfo.version)) {
        throw plugin_discovery_error_1.PluginDiscoveryError.incompatibleVersion(manifestPath, new Error(`Plugin "${manifest.id}" is only compatible with Kibana version "${expectedKibanaVersion}", but used Kibana version is "${packageInfo.version}".`));
    }
    const includesServerPlugin = typeof manifest.server === 'boolean' ? manifest.server : false;
    const includesUiPlugin = typeof manifest.ui === 'boolean' ? manifest.ui : false;
    if (!includesServerPlugin && !includesUiPlugin) {
        throw plugin_discovery_error_1.PluginDiscoveryError.invalidManifest(manifestPath, new Error(`Both "server" and "ui" are missing or set to "false" in plugin manifest for "${manifest.id}", but at least one of these must be set to "true".`));
    }
    const unknownManifestKeys = Object.keys(manifest).filter(key => !KNOWN_MANIFEST_FIELDS.has(key));
    if (unknownManifestKeys.length > 0) {
        throw plugin_discovery_error_1.PluginDiscoveryError.invalidManifest(manifestPath, new Error(`Manifest for plugin "${manifest.id}" contains the following unrecognized properties: ${unknownManifestKeys}.`));
    }
    return {
        id: manifest.id,
        version: manifest.version,
        kibanaVersion: expectedKibanaVersion,
        configPath: manifest.configPath || manifest.id,
        requiredPlugins: Array.isArray(manifest.requiredPlugins) ? manifest.requiredPlugins : [],
        optionalPlugins: Array.isArray(manifest.optionalPlugins) ? manifest.optionalPlugins : [],
        ui: includesUiPlugin,
        server: includesServerPlugin,
    };
}
exports.parseManifest = parseManifest;
/**
 * Checks whether specified folder contains Kibana new platform plugin. It's only
 * intended to be used by the legacy systems when they need to check whether specific
 * plugin path is handled by the core plugin system or not.
 * @param pluginPath Path to the plugin.
 * @internal
 */
async function isNewPlatformPlugin(pluginPath) {
    try {
        return (await fsStatAsync(path_1.resolve(pluginPath, MANIFEST_FILE_NAME))).isFile();
    }
    catch (err) {
        return false;
    }
}
exports.isNewPlatformPlugin = isNewPlatformPlugin;
/**
 * Checks whether plugin expected Kibana version is compatible with the used Kibana version.
 * @param expectedKibanaVersion Kibana version expected by the plugin.
 * @param actualKibanaVersion Used Kibana version.
 */
function isVersionCompatible(expectedKibanaVersion, actualKibanaVersion) {
    if (expectedKibanaVersion === ALWAYS_COMPATIBLE_VERSION) {
        return true;
    }
    const coercedActualKibanaVersion = semver_1.coerce(actualKibanaVersion);
    if (coercedActualKibanaVersion == null) {
        return false;
    }
    const coercedExpectedKibanaVersion = semver_1.coerce(expectedKibanaVersion);
    if (coercedExpectedKibanaVersion == null) {
        return false;
    }
    // Compare coerced versions, e.g. `1.2.3` ---> `1.2.3` and `7.0.0-alpha1` ---> `7.0.0`.
    return coercedActualKibanaVersion.compare(coercedExpectedKibanaVersion) === 0;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL2hvbWUvYW50aG9ueS9naXRfd29ya3NwYWNlcy9raWJhbmEvc3JjL2NvcmUvc2VydmVyL3BsdWdpbnMvZGlzY292ZXJ5L3BsdWdpbl9tYW5pZmVzdF9wYXJzZXIudHMiLCJzb3VyY2VzIjpbIi9ob21lL2FudGhvbnkvZ2l0X3dvcmtzcGFjZXMva2liYW5hL3NyYy9jb3JlL3NlcnZlci9wbHVnaW5zL2Rpc2NvdmVyeS9wbHVnaW5fbWFuaWZlc3RfcGFyc2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FpQkc7O0FBRUgsMkJBQW9DO0FBQ3BDLCtCQUErQjtBQUMvQixtQ0FBZ0M7QUFDaEMsK0JBQWlDO0FBQ2pDLHlDQUF5RDtBQUV6RCxxRUFBZ0U7QUFFaEUsTUFBTSxlQUFlLEdBQUcsZ0JBQVMsQ0FBQyxhQUFRLENBQUMsQ0FBQztBQUM1QyxNQUFNLFdBQVcsR0FBRyxnQkFBUyxDQUFDLFNBQUksQ0FBQyxDQUFDO0FBRXBDOztHQUVHO0FBQ0gsTUFBTSxrQkFBa0IsR0FBRyxhQUFhLENBQUM7QUFFekM7O0dBRUc7QUFDSCxNQUFNLHlCQUF5QixHQUFHLFFBQVEsQ0FBQztBQUUzQzs7R0FFRztBQUNILE1BQU0scUJBQXFCLEdBQUcsQ0FBQyxHQUFHLEVBQUU7SUFDbEMsZ0ZBQWdGO0lBQ2hGLGtGQUFrRjtJQUNsRixvRUFBb0U7SUFDcEUsTUFBTSxjQUFjLEdBQTZDO1FBQy9ELEVBQUUsRUFBRSxJQUFJO1FBQ1IsYUFBYSxFQUFFLElBQUk7UUFDbkIsT0FBTyxFQUFFLElBQUk7UUFDYixVQUFVLEVBQUUsSUFBSTtRQUNoQixlQUFlLEVBQUUsSUFBSTtRQUNyQixlQUFlLEVBQUUsSUFBSTtRQUNyQixFQUFFLEVBQUUsSUFBSTtRQUNSLE1BQU0sRUFBRSxJQUFJO0tBQ2IsQ0FBQztJQUVGLE9BQU8sSUFBSSxHQUFHLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDO0FBQzlDLENBQUMs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QWdCO1FBQ3BCLE1BQU0sRUFBRSxvQkFBb0I7S0FDN0IsQ0FBQztBQUNKLENBQUM7QUE5R0Qsc0NBOEdDO0FBRUQ7Ozs7OztHQU1HO0FBQ0ksS0FBSyxVQUFVLG1CQUFtQixDQUFDLFVBQWtCO0lBQzFELElBQUk7UUFDRixPQUFPLENBQUMsTUFBTSxXQUFXLENBQUMsY0FBTyxDQUFDLFVBQVUsRUFBRSxrQkFBa0IsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQztLQUM5RTtJQUFDLE9BQU8sR0FBRyxFQUFFO1FBQ1osT0FBTyxLQUFLLENBQUM7S0FDZDtBQUNILENBQUM7QUFORCxrREFNQztBQUVEOzs7O0dBSUc7QUFDSCxTQUFTLG1CQUFtQixDQUFDLHFCQUE2QixFQUFFLG1CQUEyQjtJQUNyRixJQUFJLHFCQUFxQixLQUFLLHlCQUF5QixFQUFFO1FBQ3ZELE9BQU8sSUFBSSxDQUFDO0tBQ2I7SUFFRCxNQUFNLDBCQUEwQixHQUFHLGVBQU0sQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0lBQy9ELElBQUksMEJBQTBCLElBQUksSUFBSSxFQUFFO1FBQ3RDLE9BQU8sS0FBSyxDQUFDO0tBQ2Q7SUFFRCxNQUFNLDRCQUE0QixHQUFHLGVBQU0sQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO0lBQ25FLElBQUksNEJBQTRCLElBQUksSUFBSSxFQUFFO1FBQ3hDLE9BQU8sS0FBSyxDQUFDO0tBQ2Q7SUFFRCx1RkFBdUY7SUFDdkYsT0FBTywwQkFBMEIsQ0FBQyxPQUFPLENBQUMsNEJBQTRCLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDaEYsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBMaWNlbnNlZCB0byBFbGFzdGljc2VhcmNoIEIuVi4gdW5kZXIgb25lIG9yIG1vcmUgY29udHJpYnV0b3JcbiAqIGxpY2Vuc2UgYWdyZWVtZW50cy4gU2VlIHRoZSBOT1RJQ0UgZmlsZSBkaXN0cmlidXRlZCB3aXRoXG4gKiB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3JtYXRpb24gcmVnYXJkaW5nIGNvcHlyaWdodFxuICogb3duZXJzaGlwLiBFbGFzdGljc2VhcmNoIEIuVi4gbGljZW5zZXMgdGhpcyBmaWxlIHRvIHlvdSB1bmRlclxuICogdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTsgeW91IG1heVxuICogbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZyxcbiAqIHNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuXG4gKiBcIkFTIElTXCIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWVxuICogS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlXG4gKiBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zXG4gKiB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyByZWFkRmlsZSwgc3RhdCB9IGZyb20gJ2ZzJztcbmltcG9ydCB7IHJlc29sdmUgfSBmcm9tICdwYXRoJztcbmltcG9ydCB7IGNvZXJjZSB9IGZyb20gJ3NlbXZlcic7XG5pbXBvcnQgeyBwcm9taXNpZnkgfSBmcm9tICd1dGlsJztcbmltcG9ydCB7IGlzQ29uZmlnUGF0aCwgUGFja2FnZUluZm8gfSBmcm9tICcuLi8uLi9jb25maWcnO1xuaW1wb3J0IHsgUGx1Z2luTWFuaWZlc3QgfSBmcm9tICcuLi9wbHVnaW4nO1xuaW1wb3J0IHsgUGx1Z2luRGlzY292ZXJ5RXJyb3IgfSBmcm9tICcuL3BsdWdpbl9kaXNjb3ZlcnlfZXJyb3InO1xuXG5jb25zdCBmc1JlYWRGaWxlQXN5bmMgPSBwcm9taXNpZnkocmVhZEZpbGUpO1xuY29uc3QgZnNTdGF0QXN5bmMgPSBwcm9taXNpZnkoc3RhdCk7XG5cbi8qKlxuICogTmFtZSBvZiB0aGUgSlNPTiBtYW5pZmVzdCBmaWxlIHRoYXQgc2hvdWxkIGJlIGxvY2F0ZWQgaW4gdGhlIHBsdWdpbiBkaXJlY3RvcnkuXG4gKi9cbmNvbnN0IE1BTklGRVNUX0ZJTEVfTkFNRSA9ICdraWJhbmEuanNvbic7XG5cbi8qKlxuICogVGhlIHNwZWNpYWwgXCJraWJhbmFcIiB2ZXJzaW9uIGNhbiBiZSB1c2VkIGJ5IHRoZSBwbHVnaW5zIHRvIGJlIGFsd2F5cyBjb21wYXRpYmxlLlxuICovXG5jb25zdCBBTFdBWVNfQ09NUEFUSUJMRV9WRVJTSU9OID0gJ2tpYmFuYSc7XG5cbi8qKlxuICogTmFtZXMgb2YgdGhlIGtub3duIG1hbmlmZXN0IGZpZWxkcy5cbiAqL1xuY29uc3QgS05PV05fTUFOSUZFU1RfRklFTERTID0gKCgpID0+IHtcbiAgLy8gV2UgdXNlIHRoaXMgdHJpY2sgdG8gaGF2ZSB0eXBlIHNhZmV0eSBhcm91bmQgdGhlIGtleXMgd2UgdXNlLCBpZiB3ZSBmb3JnZXQgdG9cbiAgLy8gYWRkIGEgbmV3IGtleSBoZXJlIG9yIG1pc3NwZWxsIGV4aXN0aW5nIG9uZSwgVHlwZVNjcmlwdCBjb21waWxlciB3aWxsIGNvbXBsYWluLlxuICAvLyBXZSBkbyB0aGlzIG9uY2UgYXQgcnVuIHRpbWUsIHNvIHBlcmZvcm1hbmNlIGltcGFjdCBpcyBuZWdsaWdpYmxlLlxuICBjb25zdCBtYW5pZmVzdEZpZWxkczogeyBbUCBpbiBrZXlvZiBQbHVnaW5NYW5pZmVzdF06IGJvb2xlYW4gfSA9IHtcbiAgICBpZDogdHJ1ZSxcbiAgICBraWJhbmFWZXJzaW9uOiB0cnVlLFxuICAgIHZlcnNpb246IHRydWUsXG4gICAgY29uZmlnUGF0aDogdHJ1ZSxcbiAgICByZXF1aXJlZFBsdWdpbnM6IHRydWUsXG4gICAgb3B0aW9uYWxQbHVnaW5zOiB0cnVlLFxuICAgIHVpOiB0cnVlLFxuICAgIHNlcnZlcjogdHJ1ZSxcbiAgfTtcblxuICByZXR1cm4gbmV3IFNldChPYmplY3Qua2V5cyhtYW5pZmVzdEZpZWxkcykpO1xufSkoKTtcblxuLyoqXG4gKiBUcmllcyB0byBsb2FkIGFuZCBwYXJzZSB0aGUgcGx1Z2luIG1hbmlmZXN0IGZpbGUgbG9jYXRlZCBhdCB0aGUgcHJvdmlkZWQgcGx1Z2luXG4gKiBkaXJlY3RvcnkgcGF0aCBhbmQgcHJvZHVjZXMgYW4gZXJyb3IgcmVzdWx0IGlmIGl0IGZhaWxzIHRvIGRvIHNvIG9yIHBsdWdpbiBtYW5pZmVzdFxuICogaXNuJ3QgdmFsaWQuXG4gKiBAcGFyYW0gcGx1Z2luUGF0aCBQYXRoIHRvIHRoZSBwbHVnaW4gZGlyZWN0b3J5IHdoZXJlIG1hbmlmZXN0IHNob3VsZCBiZSBsb2FkZWQgZnJvbS5cbiAqIEBwYXJhbSBwYWNrYWdlSW5mbyBLaWJhbmEgcGFja2FnZSBpbmZvLlxuICogQGludGVybmFsXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBwYXJzZU1hbmlmZXN0KHBsdWdpblBhdGg6IHN0cmluZywgcGFja2FnZUluZm86IFBhY2thZ2VJbmZvKSB7XG4gIGNvbnN0IG1hbmlmZXN0UGF0aCA9IHJlc29sdmUocGx1Z2luUGF0aCwgTUFOSUZFU1RfRklMRV9OQU1FKTtcblxuICBsZXQgbWFuaWZlc3RDb250ZW50O1xuICB0cnkge1xuICAgIG1hbmlmZXN0Q29udGVudCA9IGF3YWl0IGZzUmVhZEZpbGVBc3luYyhtYW5pZmVzdFBhdGgpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICB0aHJvdyBQbHVnaW5EaXNjb3ZlcnlFcnJvci5taXNzaW5nTWFuaWZlc3QobWFuaWZlc3RQYXRoLCBlcnIpO1xuICB9XG5cbiAgbGV0IG1hbmlmZXN0OiBQYXJ0aWFsPFBsdWdpbk1hbmlmZXN0PjtcbiAgdHJ5IHtcbiAgICBtYW5pZmVzdCA9IEpTT04ucGFyc2UobWFuaWZlc3RDb250ZW50LnRvU3RyaW5nKCkpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICB0aHJvdyBQbHVnaW5EaXNjb3ZlcnlFcnJvci5pbnZhbGlkTWFuaWZlc3QobWFuaWZlc3RQYXRoLCBlcnIpO1xuICB9XG5cbiAgaWYgKCFtYW5pZmVzdCB8fCB0eXBlb2YgbWFuaWZlc3QgIT09ICdvYmplY3QnKSB7XG4gICAgdGhyb3cgUGx1Z2luRGlzY292ZXJ5RXJyb3IuaW52YWxpZE1hbmlmZXN0KFxuICAgICAgbWFuaWZlc3RQYXRoLFxuICAgICAgbmV3IEVycm9yKCdQbHVnaW4gbWFuaWZlc3QgbXVzdCBjb250YWluIGEgSlNPTiBlbmNvZGVkIG9iamVjdC4nKVxuICAgICk7XG4gIH1cblxuICBpZiAoIW1hbmlmZXN0LmlkIHx8IHR5cGVvZiBtYW5pZmVzdC5pZCAhPT0gJ3N0cmluZycpIHtcbiAgICB0aHJvdyBQbHVnaW5EaXNjb3ZlcnlFcnJvci5pbnZhbGlkTWFuaWZlc3QoXG4gICAgICBtYW5pZmVzdFBhdGgsXG4gICAgICBuZXcgRXJyb3IoJ1BsdWdpbiBtYW5pZmVzdCBtdXN0IGNvbnRhaW4gYW4gXCJpZFwiIHByb3BlcnR5LicpXG4gICAgKTtcbiAgfVxuXG4gIC8vIFBsdWdpbiBpZCBjYW4gYmUgdXNlZCBhcyBhIGNvbmZpZyBwYXRoIG9yIGFzIGEgbG9nZ2VyIGNvbnRleHQgYW5kIGhhdmluZyBkb3RzXG4gIC8vIGluIHRoZXJlIG1heSBsZWFkIHRvIHZhcmlvdXMgaXNzdWVzLCBzbyB3ZSBmb3JiaWQgdGhhdC5cbiAgaWYgKG1hbmlmZXN0LmlkLmluY2x1ZGVzKCcuJykpIHtcbiAgICB0aHJvdyBQbHVnaW5EaXNjb3ZlcnlFcnJvci5pbnZhbGlkTWFuaWZlc3QoXG4gICAgICBtYW5pZmVzdFBhdGgsXG4gICAgICBuZXcgRXJyb3IoJ1BsdWdpbiBcImlkXCIgbXVzdCBub3QgaW5jbHVkZSBgLmAgY2hhcmFjdGVycy4nKVxuICAgICk7XG4gIH1cblxuICBpZiAoIW1hbmlmZXN0LnZlcnNpb24gfHwgdHlwZW9mIG1hbmlmZXN0LnZlcnNpb24gIT09ICdzdHJpbmcnKSB7XG4gICAgdGhyb3cgUGx1Z2luRGlzY292ZXJ5RXJyb3IuaW52YWxpZE1hbmlmZXN0KFxuICAgICAgbWFuaWZlc3RQYXRoLFxuICAgICAgbmV3IEVycm9yKGBQbHVnaW4gbWFuaWZlc3QgZm9yIFwiJHttYW5pZmVzdC5pZH1cIiBtdXN0IGNvbnRhaW4gYSBcInZlcnNpb25cIiBwcm9wZXJ0eS5gKVxuICAgICk7XG4gIH1cblxuICBpZiAobWFuaWZlc3QuY29uZmlnUGF0aCAhPT0gdW5kZWZpbmVkICYmICFpc0NvbmZpZ1BhdGgobWFuaWZlc3QuY29uZmlnUGF0aCkpIHtcbiAgICB0aHJvdyBQbHVnaW5EaXNjb3ZlcnlFcnJvci5pbnZhbGlkTWFuaWZlc3QoXG4gICAgICBtYW5pZmVzdFBhdGgsXG4gICAgICBuZXcgRXJyb3IoXG4gICAgICAgIGBUaGUgXCJjb25maWdQYXRoXCIgaW4gcGx1Z2luIG1hbmlmZXN0IGZvciBcIiR7XG4gICAgICAgICAgbWFuaWZlc3QuaWRcbiAgICAgICAgfVwiIHNob3VsZCBlaXRoZXIgYmUgYSBzdHJpbmcgb3IgYW4gYXJyYXkgb2Ygc3RyaW5ncy5gXG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIGNvbnN0IGV4cGVjdGVkS2liYW5hVmVyc2lvbiA9XG4gICAgdHlwZW9mIG1hbmlmZXN0LmtpYmFuYVZlcnNpb24gPT09ICdzdHJpbmcnICYmIG1hbmlmZXN0LmtpYmFuYVZlcnNpb25cbiAgICAgID8gbWFuaWZlc3Qua2liYW5hVmVyc2lvblxuICAgICAgOiBtYW5pZmVzdC52ZXJzaW9uO1xuICBpZiAoIWlzVmVyc2lvbkNvbXBhdGlibGUoZXhwZWN0ZWRLaWJhbmFWZXJzaW9uLCBwYWNrYWdlSW5mby52ZXJzaW9uKSkge1xuICAgIHRocm93IFBsdWdpbkRpc2NvdmVyeUVycm9yLmluY29tcGF0aWJsZVZlcnNpb24oXG4gICAgICBtYW5pZmVzdFBhdGgsXG4gICAgICBuZXcgRXJyb3IoXG4gICAgICAgIGBQbHVnaW4gXCIke1xuICAgICAgICAgIG1hbmlmZXN0LmlkXG4gICAgICAgIH1cIiBpcyBvbmx5IGNvbXBhdGlibGUgd2l0aCBLaWJhbmEgdmVyc2lvbiBcIiR7ZXhwZWN0ZWRLaWJhbmFWZXJzaW9ufVwiLCBidXQgdXNlZCBLaWJhbmEgdmVyc2lvbiBpcyBcIiR7XG4gICAgICAgICAgcGFja2FnZUluZm8udmVyc2lvblxuICAgICAgICB9XCIuYFxuICAgICAgKVxuICAgICk7XG4gIH1cblxuICBjb25zdCBpbmNsdWRlc1NlcnZlclBsdWdpbiA9IHR5cGVvZiBtYW5pZmVzdC5zZXJ2ZXIgPT09ICdib29sZWFuJyA/IG1hbmlmZXN0LnNlcnZlciA6IGZhbHNlO1xuICBjb25zdCBpbmNsdWRlc1VpUGx1Z2luID0gdHlwZW9mIG1hbmlmZXN0LnVpID09PSAnYm9vbGVhbicgPyBtYW5pZmVzdC51aSA6IGZhbHNlO1xuICBpZiAoIWluY2x1ZGVzU2VydmVyUGx1Z2luICYmICFpbmNsdWRlc1VpUGx1Z2luKSB7XG4gICAgdGhyb3cgUGx1Z2luRGlzY292ZXJ5RXJyb3IuaW52YWxpZE1hbmlmZXN0KFxuICAgICAgbWFuaWZlc3RQYXRoLFxuICAgICAgbmV3IEVycm9yKFxuICAgICAgICBgQm90aCBcInNlcnZlclwiIGFuZCBcInVpXCIgYXJlIG1pc3Npbmcgb3Igc2V0IHRvIFwiZmFsc2VcIiBpbiBwbHVnaW4gbWFuaWZlc3QgZm9yIFwiJHtcbiAgICAgICAgICBtYW5pZmVzdC5pZFxuICAgICAgICB9XCIsIGJ1dCBhdCBsZWFzdCBvbmUgb2YgdGhlc2UgbXVzdCBiZSBzZXQgdG8gXCJ0cnVlXCIuYFxuICAgICAgKVxuICAgICk7XG4gIH1cblxuICBjb25zdCB1bmtub3duTWFuaWZlc3RLZXlzID0gT2JqZWN0LmtleXMobWFuaWZlc3QpLmZpbHRlcihrZXkgPT4gIUtOT1dOX01BTklGRVNUX0ZJRUxEUy5oYXMoa2V5KSk7XG4gIGlmICh1bmtub3duTWFuaWZlc3RLZXlzLmxlbmd0aCA+IDApIHtcbiAgICB0aHJvdyBQbHVnaW5EaXNjb3ZlcnlFcnJvci5pbnZhbGlkTWFuaWZlc3QoXG4gICAgICBtYW5pZmVzdFBhdGgsXG4gICAgICBuZXcgRXJyb3IoXG4gICAgICAgIGBNYW5pZmVzdCBmb3IgcGx1Z2luIFwiJHtcbiAgICAgICAgICBtYW5pZmVzdC5pZFxuICAgICAgICB9XCIgY29udGFpbnMgdGhlIGZvbGxvd2luZyB1bnJlY29nbml6ZWQgcHJvcGVydGllczogJHt1bmtub3duTWFuaWZlc3RLZXlzfS5gXG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgaWQ6IG1hbmlmZXN0LmlkLFxuICAgIHZlcnNpb246IG1hbmlmZXN0LnZlcnNpb24sXG4gICAga2liYW5hVmVyc2lvbjogZXhwZWN0ZWRLaWJhbmFWZXJzaW9uLFxuICAgIGNvbmZpZ1BhdGg6IG1hbmlmZXN0LmNvbmZpZ1BhdGggfHwgbWFuaWZlc3QuaWQsXG4gICAgcmVxdWlyZWRQbHVnaW5zOiBBcnJheS5pc0FycmF5KG1hbmlmZXN0LnJlcXVpcmVkUGx1Z2lucykgPyBtYW5pZmVzdC5yZXF1aXJlZFBsdWdpbnMgOiBbXSxcbiAgICBvcHRpb25hbFBsdWdpbnM6IEFycmF5LmlzQXJyYXkobWFuaWZlc3Qub3B0aW9uYWxQbHVnaW5zKSA/IG1hbmlmZXN0Lm9wdGlvbmFsUGx1Z2lucyA6IFtdLFxuICAgIHVpOiBpbmNsdWRlc1VpUGx1Z2luLFxuICAgIHNlcnZlcjogaW5jbHVkZXNTZXJ2ZXJQbHVnaW4sXG4gIH07XG59XG5cbi8qKlxuICogQ2hlY2tzIHdoZXRoZXIgc3BlY2lmaWVkIGZvbGRlciBjb250YWlucyBLaWJhbmEgbmV3IHBsYXRmb3JtIHBsdWdpbi4gSXQncyBvbmx5XG4gKiBpbnRlbmRlZCB0byBiZSB1c2VkIGJ5IHRoZSBsZWdhY3kgc3lzdGVtcyB3aGVuIHRoZXkgbmVlZCB0byBjaGVjayB3aGV0aGVyIHNwZWNpZmljXG4gKiBwbHVnaW4gcGF0aCBpcyBoYW5kbGVkIGJ5IHRoZSBjb3JlIHBsdWdpbiBzeXN0ZW0gb3Igbm90LlxuICogQHBhcmFtIHBsdWdpblBhdGggUGF0aCB0byB0aGUgcGx1Z2luLlxuICogQGludGVybmFsXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBpc05ld1BsYXRmb3JtUGx1Z2luKHBsdWdpblBhdGg6IHN0cmluZykge1xuICB0cnkge1xuICAgIHJldHVybiAoYXdhaXQgZnNTdGF0QXN5bmMocmVzb2x2ZShwbHVnaW5QYXRoLCBNQU5JRkVTVF9GSUxFX05BTUUpKSkuaXNGaWxlKCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufVxuXG4vKipcbiAqIENoZWNrcyB3aGV0aGVyIHBsdWdpbiBleHBlY3RlZCBLaWJhbmEgdmVyc2lvbiBpcyBjb21wYXRpYmxlIHdpdGggdGhlIHVzZWQgS2liYW5hIHZlcnNpb24uXG4gKiBAcGFyYW0gZXhwZWN0ZWRLaWJhbmFWZXJzaW9uIEtpYmFuYSB2ZXJzaW9uIGV4cGVjdGVkIGJ5IHRoZSBwbHVnaW4uXG4gKiBAcGFyYW0gYWN0dWFsS2liYW5hVmVyc2lvbiBVc2VkIEtpYmFuYSB2ZXJzaW9uLlxuICovXG5mdW5jdGlvbiBpc1ZlcnNpb25Db21wYXRpYmxlKGV4cGVjdGVkS2liYW5hVmVyc2lvbjogc3RyaW5nLCBhY3R1YWxLaWJhbmFWZXJzaW9uOiBzdHJpbmcpIHtcbiAgaWYgKGV4cGVjdGVkS2liYW5hVmVyc2lvbiA9PT0gQUxXQVlTX0NPTVBBVElCTEVfVkVSU0lPTikge1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgY29uc3QgY29lcmNlZEFjdHVhbEtpYmFuYVZlcnNpb24gPSBjb2VyY2UoYWN0dWFsS2liYW5hVmVyc2lvbik7XG4gIGlmIChjb2VyY2VkQWN0dWFsS2liYW5hVmVyc2lvbiA9PSBudWxsKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgY29uc3QgY29lcmNlZEV4cGVjdGVkS2liYW5hVmVyc2lvbiA9IGNvZXJjZShleHBlY3RlZEtpYmFuYVZlcnNpb24pO1xuICBpZiAoY29lcmNlZEV4cGVjdGVkS2liYW5hVmVyc2lvbiA9PSBudWxsKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgLy8gQ29tcGFyZSBjb2VyY2VkIHZlcnNpb25zLCBlLmcuIGAxLjIuM2AgLS0tPiBgMS4yLjNgIGFuZCBgNy4wLjAtYWxwaGExYCAtLS0+IGA3LjAuMGAuXG4gIHJldHVybiBjb2VyY2VkQWN0dWFsS2liYW5hVmVyc2lvbi5jb21wYXJlKGNvZXJjZWRFeHBlY3RlZEtpYmFuYVZlcnNpb24pID09PSAwO1xufVxuIl19