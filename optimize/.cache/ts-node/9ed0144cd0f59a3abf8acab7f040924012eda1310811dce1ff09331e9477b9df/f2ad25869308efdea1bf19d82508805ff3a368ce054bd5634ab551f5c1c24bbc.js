"use strict";
/*
 * Licensed to Elasticsearch B.V. under one or more contributor
 * license agreements. See the NOTICE file distributed with
 * this work for additional information regarding copyright
 * ownership. Elasticsearch B.V. licenses this file to you under
 * the Apache License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const path_1 = require("path");
const type_detect_1 = tslib_1.__importDefault(require("type-detect"));
/**
 * Lightweight wrapper around discovered plugin that is responsible for instantiating
 * plugin and dispatching proper context and dependencies into plugin's lifecycle hooks.
 * @internal
 */
class Plugin {
    constructor(path, manifest, initializerContext) {
        this.path = path;
        this.manifest = manifest;
        this.initializerContext = initializerContext;
        this.log = initializerContext.logger.get();
        this.name = manifest.id;
        this.configPath = manifest.configPath;
        this.requiredDependencies = manifest.requiredPlugins;
        this.optionalDependencies = manifest.optionalPlugins;
        this.includesServerPlugin = manifest.server;
        this.includesUiPlugin = manifest.ui;
    }
    /**
     * Instantiates plugin and calls `start` function exposed by the plugin initializer.
     * @param startContext Context that consists of various core services tailored specifically
     * for the `start` lifecycle event.
     * @param dependencies The dictionary where the key is the dependency name and the value
     * is the contract returned by the dependency's `start` function.
     */
    async start(startContext, dependencies) {
        this.instance = this.createPluginInstance();
        this.log.info('Starting plugin');
        return await this.instance.start(startContext, dependencies);
    }
    /**
     * Calls optional `stop` function exposed by the plugin initializer.
     */
    async stop() {
        if (this.instance === undefined) {
            throw new Error(`Plugin "${this.name}" can't be stopped since it isn't started.`);
        }
        this.log.info('Stopping plugin');
        if (typeof this.instance.stop === 'function') {
            await this.instance.stop();
        }
        this.instance = undefined;
    }
    createPluginInstance() {
        this.log.debug('Initializing plugin');
        const pluginDefinition = require(path_1.join(this.path, 'server'));
        if (!('plugin' in pluginDefinition)) {
            throw new Error(`Plugin "${this.name}" does not export "plugin" definition (${this.path}).`);
        }
        const { plugin: initializer } = pluginDefinition;
        if (!initializer || typeof initializer !== 'function') {
            throw new Error(`Definition of plugin "${this.name}" should be a function (${this.path}).`);
        }
        const instance = initializer(this.initializerContext);
        if (!instance || typeof instance !== 'object') {
            throw new Error(`Initializer for plugin "${this.manifest.id}" is expected to return plugin instance, but returned "${type_detect_1.default(instance)}".`);
        }
        if (typeof instance.start !== 'function') {
            throw new Error(`Instance of plugin "${this.name}" does not define "start" function.`);
        }
        return instance;
    }
}
exports.Plugin = Plugin;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL2hvbWUvYW50aG9ueS9naXRfd29ya3NwYWNlcy9raWJhbmEvc3JjL2NvcmUvc2VydmVyL3BsdWdpbnMvcGx1Z2luLnRzIiwic291cmNlcyI6WyIvaG9tZS9hbnRob255L2dpdF93b3Jrc3BhY2VzL2tpYmFuYS9zcmMvY29yZS9zZXJ2ZXIvcGx1Z2lucy9wbHVnaW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7Ozs7Ozs7Ozs7OztHQWlCRzs7O0FBRUgsK0JBQTRCO0FBQzVCLHNFQUFxQztBQXFFckM7Ozs7R0FJRztBQUNILE1BQWEsTUFBTTtJQWVqQixZQUNrQixJQUFZLEVBQ1gsUUFBd0IsRUFDeEIsa0JBQTRDO1FBRjdDLFNBQUksR0FBSixJQUFJLENBQVE7UUFDWCxhQUFRLEdBQVIsUUFBUSxDQUFnQjtRQUN4Qix1QkFBa0IsR0FBbEIsa0JBQWtCLENBQTBCO1FBRTdELElBQUksQ0FBQyxHQUFHLEdBQUcsa0JBQWtCLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQzNDLElBQUksQ0FBQyxJQUFJLEdBQUcsUUFBUSxDQUFDLEVBQUUsQ0FBQztRQUN4QixJQUFJLENBQUMsVUFBVSxHQUFHLFFBQVEsQ0FBQyxVQUFVLENBQUM7UUFDdEMsSUFBSSxDQUFDLG9CQUFvQixHQUFHLFFBQVEsQ0FBQyxlQUFlLENBQUM7UUFDckQsSUFBSSxDQUFDLG9CQUFvQixHQUFHLFFBQVEsQ0FBQyxlQUFlLENBQUM7UUFDckQsSUFBSSxDQUFDLG9CQUFvQixHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUM7UUFDNUMsSUFBSSxDQUFDLGdCQUFnQixHQUFHLFFBQVEsQ0FBQyxFQUFFLENBQUM7SUFDdEMsQ0FBQztJQUVEOzs7Ozs7T0FNRztJQUNJLEtBQUssQ0FBQyxLQUFLLENBQUMsWUFBZ0MsRUFBRSxZQUEyQjtRQUM5RSxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1FBRTVDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFFakMsT0FBTyxNQUFNLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLFlBQVksRUFBRSxZQUFZLENBQUMsQ0FBQztJQUMvRCxDQUFDO0lBRUQ7O09BRUc7SUFDSSxLQUFLLENBQUMsSUFBSTtRQUNmLElBQUksSUFBSSxDQUFDLFFBQVEsS0FBSyxTQUFTLEVBQUU7WUFDL0IsTUFBTSxJQUFJLEtBQUssQ0FBQyxXQUFXLElBQUksQ0FBQyxJQUFJLDRDQUE0QyxDQUFDLENBQUM7U0FDbkY7UUFFRCxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBRWpDLElBQUksT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksS0FBSyxVQUFVLEVBQUU7WUFDNUMsTUFBTSxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDO1NBQzVCO1FBRUQsSUFBSSxDQUFDLFFBQVEsR0FBRyxTQUFTLENBQUM7SUFDNUIsQ0FBQztJQUVPLG9CQUFvQjtRQUMxQixJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1FBRXRDLE1BQU0sZ0JBQWdCLEdBQUcsT0FBTyxDQUFDLFdBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFDNUQsSUFBSSxDQUFDLENBQUMsUUFBUSxJQUFJLGdCQUFnQixDQUFDLEVBQUU7WUFDbkMsTUFBTSxJQUFJLEtBQUssQ0FBQyxXQUFXLElBQUksQ0FBQyxJQUFJLDBDQUEwQyxJQUFJLENBQUMsSUFBSSxJQUFJLENBQUMsQ0FBQztTQUM5RjtRQUVELE1BQU0sRUFBRSxNQUFNLEVBQUUsV0FBVyxFQUFFLEdBQUcsZ0JBRS9CLENBQUM7UUFDRixJQUFJLENBQUMsV0FBVyxJQUFJLE9BQU8sV0FBVyxLQUFLLFVBQVUsRUFBRTtZQUNyRCxNQUFNLElBQUksS0FBSyxDQUFDLHlCQUF5QixJQUFJLENBQUMsSUFBSSwyQkFBMkIsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLENBQUM7U0FDN0Y7UUFFRCxNQUFNLFFBQVEsR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUM7UUFDdEQsSUFBSSxDQUFDLFFBQVEsSUFBSSxPQUFPLFFBQVEsS0FBSyxRQUFRLEVBQUU7WUFDN0MsTUFBTSxJQUFJLEtBQUssQ0FDYiwyQkFDRSxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQ2hCLDBEQUEwRCxxQkFBVSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQ25GLENBQUM7U0FDSDtRQUVELElBQUksT0FBTyxRQUFRLENBQUMsS0FBSyxLQUFLLFVBQVUsRUFBRTtZQUN4QyxNQUFNLElBQUksS0FBSyxDQUFDLHVCQUF1QixJQUFJLENBQUMsSUFBSSxxQ0FBcUMsQ0FBQyxDQUFDO1NBQ3hGO1FBRUQsT0FBTyxRQUFRLENBQUM7SUFDbEIsQ0FBQztDQUNGO0FBM0ZELHdCQTJGQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBMaWNlbnNlZCB0byBFbGFzdGljc2VhcmNoIEIuVi4gdW5kZXIgb25lIG9yIG1vcmUgY29udHJpYnV0b3JcbiAqIGxpY2Vuc2UgYWdyZWVtZW50cy4gU2VlIHRoZSBOT1RJQ0UgZmlsZSBkaXN0cmlidXRlZCB3aXRoXG4gKiB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3JtYXRpb24gcmVnYXJkaW5nIGNvcHlyaWdodFxuICogb3duZXJzaGlwLiBFbGFzdGljc2VhcmNoIEIuVi4gbGljZW5zZXMgdGhpcyBmaWxlIHRvIHlvdSB1bmRlclxuICogdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTsgeW91IG1heVxuICogbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZyxcbiAqIHNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuXG4gKiBcIkFTIElTXCIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWVxuICogS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlXG4gKiBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zXG4gKiB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBqb2luIH0gZnJvbSAncGF0aCc7XG5pbXBvcnQgdHlwZURldGVjdCBmcm9tICd0eXBlLWRldGVjdCc7XG5pbXBvcnQgeyBDb25maWdQYXRoIH0gZnJvbSAnLi4vY29uZmlnJztcbmltcG9ydCB7IExvZ2dlciB9IGZyb20gJy4uL2xvZ2dpbmcnO1xuaW1wb3J0IHsgUGx1Z2luSW5pdGlhbGl6ZXJDb250ZXh0LCBQbHVnaW5TdGFydENvbnRleHQgfSBmcm9tICcuL3BsdWdpbl9jb250ZXh0JztcblxuLyoqXG4gKiBEZWRpY2F0ZWQgdHlwZSBmb3IgcGx1Z2luIG5hbWUvaWQgdGhhdCBpcyBzdXBwb3NlZCB0byBtYWtlIE1hcC9TZXQvQXJyYXlzXG4gKiB0aGF0IHVzZSBpdCBhcyBhIGtleSBvciB2YWx1ZSBtb3JlIG9idmlvdXMuXG4gKi9cbmV4cG9ydCB0eXBlIFBsdWdpbk5hbWUgPSBzdHJpbmc7XG5cbi8qKlxuICogRGVzY3JpYmVzIHRoZSBzZXQgb2YgcmVxdWlyZWQgYW5kIG9wdGlvbmFsIHByb3BlcnRpZXMgcGx1Z2luIGNhbiBkZWZpbmUgaW4gaXRzXG4gKiBtYW5kYXRvcnkgSlNPTiBtYW5pZmVzdCBmaWxlLlxuICogQGludGVybmFsXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgUGx1Z2luTWFuaWZlc3Qge1xuICAvKipcbiAgICogSWRlbnRpZmllciBvZiB0aGUgcGx1Z2luLlxuICAgKi9cbiAgcmVhZG9ubHkgaWQ6IFBsdWdpbk5hbWU7XG5cbiAgLyoqXG4gICAqIFZlcnNpb24gb2YgdGhlIHBsdWdpbi5cbiAgICovXG4gIHJlYWRvbmx5IHZlcnNpb246IHN0cmluZztcblxuICAvKipcbiAgICogVGhlIHZlcnNpb24gb2YgS2liYW5hIHRoZSBwbHVnaW4gaXMgY29tcGF0aWJsZSB3aXRoLCBkZWZhdWx0cyB0byBcInZlcnNpb25cIi5cbiAgICovXG4gIHJlYWRvbmx5IGtpYmFuYVZlcnNpb246IHN0cmluZztcblxuICAvKipcbiAgICogUm9vdCBjb25maWd1cmF0aW9uIHBhdGggdXNlZCBieSB0aGUgcGx1Z2luLCBkZWZhdWx0cyB0byBcImlkXCIuXG4gICAqL1xuICByZWFkb25seSBjb25maWdQYXRoOiBDb25maWdQYXRoO1xuXG4gIC8qKlxuICAgKiBBbiBvcHRpb25hbCBsaXN0IG9mIHRoZSBvdGhlciBwbHVnaW5zIHRoYXQgKiptdXN0IGJlKiogaW5zdGFsbGVkIGFuZCBlbmFibGVkXG4gICAqIGZvciB0aGlzIHBsdWdpbiB0byBmdW5jdGlvbiBwcm9wZXJseS5cbiAgICovXG4gIHJlYWRvbmx5IHJlcXVpcmVkUGx1Z2luczogUmVhZG9ubHlBcnJheTxQbHVnaW5OYW1lPjtcblxuICAvKipcbiAgICogQW4gb3B0aW9uYWwgbGlzdCBvZiB0aGUgb3RoZXIgcGx1Z2lucyB0aGF0IGlmIGluc3RhbGxlZCBhbmQgZW5hYmxlZCAqKm1heSBiZSoqXG4gICAqIGxldmVyYWdlZCBieSB0aGlzIHBsdWdpbiBmb3Igc29tZSBhZGRpdGlvbmFsIGZ1bmN0aW9uYWxpdHkgYnV0IG90aGVyd2lzZSBhcmVcbiAgICogbm90IHJlcXVpcmVkIGZvciB0aGlzIHBsdWdpbiB0byB3b3JrIHByb3Blcmx5LlxuICAgKi9cbiAgcmVhZG9ubHkgb3B0aW9uYWxQbHVnaW5zOiBSZWFkb25seUFycmF5PFBsdWdpbk5hbWU+O1xuXG4gIC8qKlxuICAgKiBTcGVjaWZpZXMgd2hldGhlciBwbHVnaW4gaW5jbHVkZXMgc29tZSBjbGllbnQvYnJvd3NlciBzcGVjaWZpYyBmdW5jdGlvbmFsaXR5XG4gICAqIHRoYXQgc2hvdWxkIGJlIGluY2x1ZGVkIGludG8gY2xpZW50IGJ1bmRsZSB2aWEgYHB1YmxpYy91aV9wbHVnaW4uanNgIGZpbGUuXG4gICAqL1xuICByZWFkb25seSB1aTogYm9vbGVhbjtcblxuICAvKipcbiAgICogU3BlY2lmaWVzIHdoZXRoZXIgcGx1Z2luIGluY2x1ZGVzIHNvbWUgc2VydmVyLXNpZGUgc3BlY2lmaWMgZnVuY3Rpb25hbGl0eS5cbiAgICovXG4gIHJlYWRvbmx5IHNlcnZlcjogYm9vbGVhbjtcbn1cblxudHlwZSBQbHVnaW5Jbml0aWFsaXplcjxURXhwb3NlZENvbnRyYWN0LCBURGVwZW5kZW5jaWVzIGV4dGVuZHMgUmVjb3JkPFBsdWdpbk5hbWUsIHVua25vd24+PiA9IChcbiAgY29yZUNvbnRleHQ6IFBsdWdpbkluaXRpYWxpemVyQ29udGV4dFxuKSA9PiB7XG4gIHN0YXJ0OiAocGx1Z2luU3RhcnRDb250ZXh0OiBQbHVnaW5TdGFydENvbnRleHQsIGRlcGVuZGVuY2llczogVERlcGVuZGVuY2llcykgPT4gVEV4cG9zZWRDb250cmFjdDtcbiAgc3RvcD86ICgpID0+IHZvaWQ7XG59O1xuXG4vKipcbiAqIExpZ2h0d2VpZ2h0IHdyYXBwZXIgYXJvdW5kIGRpc2NvdmVyZWQgcGx1Z2luIHRoYXQgaXMgcmVzcG9uc2libGUgZm9yIGluc3RhbnRpYXRpbmdcbiAqIHBsdWdpbiBhbmQgZGlzcGF0Y2hpbmcgcHJvcGVyIGNvbnRleHQgYW5kIGRlcGVuZGVuY2llcyBpbnRvIHBsdWdpbidzIGxpZmVjeWNsZSBob29rcy5cbiAqIEBpbnRlcm5hbFxuICovXG5leHBvcnQgY2xhc3MgUGx1Z2luPFxuICBUU3RhcnRDb250cmFjdCA9IHVua25vd24sXG4gIFREZXBlbmRlbmNpZXMgZXh0ZW5kcyBSZWNvcmQ8UGx1Z2luTmFtZSwgdW5rbm93bj4gPSBSZWNvcmQ8UGx1Z2luTmFtZSwgdW5rbm93bj5cbj4ge1xuICBwdWJsaWMgcmVhZG9ubHkgbmFtZTogUGx1Z2luTWFuaWZlc3RbJ2lkJ107XG4gIHB1YmxpYyByZWFkb25seSBjb25maWdQYXRoOiBQbHVnaW5NYW5pZmVzdFsnY29uZmlnUGF0aCddO1xuICBwdWJsaWMgcmVhZG9ubHkgcmVxdWlyZWREZXBlbmRlbmNpZXM6IFBsdWdpbk1hbmlmZXN0WydyZXF1aXJlZFBsdWdpbnMnXTtcbiAgcHVibGljIHJlYWRvbmx5IG9wdGlvbmFsRGVwZW5kZW5jaWVzOiBQbHVnaW5NYW5pZmVzdFsnb3B0aW9uYWxQbHVnaW5zJ107XG4gIHB1YmxpYyByZWFkb25seSBpbmNsdWRlc1NlcnZlclBsdWdpbjogUGx1Z2luTWFuaWZlc3RbJ3NlcnZlciddO1xuICBwdWJsaWMgcmVhZG9ubHkgaW5jbHVkZXNVaVBsdWdpbjogUGx1Z2luTWFuaWZlc3RbJ3VpJ107XG5cbiAgcHJpdmF0ZSByZWFkb25seSBsb2c6IExvZ2dlcjtcblxuICBwcml2YXRlIGluc3RhbmNlPzogUmV0dXJuVHlwZTxQbHVnaW5Jbml0aWFsaXplcjxUU3RhcnRDb250cmFjdCwgVERlcGVuZGVuY2llcz4+O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyByZWFkb25seSBwYXRoOiBzdHJpbmcsXG4gICAgcHJpdmF0ZSByZWFkb25seSBtYW5pZmVzdDogUGx1Z2luTWFuaWZlc3QsXG4gICAgcHJpdmF0ZSByZWFkb25seSBpbml0aWFsaXplckNvbnRleHQ6IFBsdWdpbkluaXRpYWxpemVyQ29udGV4dFxuICApIHtcbiAgICB0aGlzLmxvZyA9IGluaXRpYWxpemVyQ29udGV4dC5sb2dnZXIuZ2V0KCk7XG4gICAgdGhpcy5uYW1lID0gbWFuaWZlc3QuaWQ7XG4gICAgdGhpcy5jb25maWdQYXRoID0gbWFuaWZlc3QuY29uZmlnUGF0aDtcbiAgICB0aGlzLnJlcXVpcmVkRGVwZW5kZW5jaWVzID0gbWFuaWZlc3QucmVxdWlyZWRQbHVnaW5zO1xuICAgIHRoaXMub3B0aW9uYWxEZXBlbmRlbmNpZXMgPSBtYW5pZmVzdC5vcHRpb25hbFBsdWdpbnM7XG4gICAgdGhpcy5pbmNsdWRlc1NlcnZlclBsdWdpbiA9IG1hbmlmZXN0LnNlcnZlcjtcbiAgICB0aGlzLmluY2x1ZGVzVWlQbHVnaW4gPSBtYW5pZmVzdC51aTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbnN0YW50aWF0ZXMgcGx1Z2luIGFuZCBjYWxscyBgc3RhcnRgIGZ1bmN0aW9uIGV4cG9zZWQgYnkgdGhlIHBsdWdpbiBpbml0aWFsaXplci5cbiAgICogQHBhcmFtIHN0YXJ0Q29udGV4dCBDb250ZXh0IHRoYXQgY29uc2lzdHMgb2YgdmFyaW91cyBjb3JlIHNlcnZpY2VzIHRhaWxvcmVkIHNwZWNpZmljYWxseVxuICAgKiBmb3IgdGhlIGBzdGFydGAgbGlmZWN5Y2xlIGV2ZW50LlxuICAgKiBAcGFyYW0gZGVwZW5kZW5jaWVzIFRoZSBkaWN0aW9uYXJ5IHdoZXJlIHRoZSBrZXkgaXMgdGhlIGRlcGVuZGVuY3kgbmFtZSBhbmQgdGhlIHZhbHVlXG4gICAqIGlzIHRoZSBjb250cmFjdCByZXR1cm5lZCBieSB0aGUgZGVwZW5kZW5jeSdzIGBzdGFydGAgZnVuY3Rpb24uXG4gICAqL1xuICBwdWJsaWMgYXN5bmMgc3RhcnQoc3RhcnRDb250ZXh0OiBQbHVnaW5TdGFydENvbnRleHQsIGRlcGVuZGVuY2llczogVERlcGVuZGVuY2llcykge1xuICAgIHRoaXMuaW5zdGFuY2UgPSB0aGlzLmNyZWF0ZVBsdWdpbkluc3RhbmNlKCk7XG5cbiAgICB0aGlzLmxvZy5pbmZvKCdTdGFydGluZyBwbHVnaW4nKTtcblxuICAgIHJldHVybiBhd2FpdCB0aGlzLmluc3RhbmNlLnN0YXJ0KHN0YXJ0Q29udGV4dCwgZGVwZW5kZW5jaWVzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDYWxscyBvcHRpb25hbCBgc3RvcGAgZnVuY3Rpb24gZXhwb3NlZCBieSB0aGUgcGx1Z2luIGluaXRpYWxpemVyLlxuICAgKi9cbiAgcHVibGljIGFzeW5jIHN0b3AoKSB7XG4gICAgaWYgKHRoaXMuaW5zdGFuY2UgPT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBQbHVnaW4gXCIke3RoaXMubmFtZX1cIiBjYW4ndCBiZSBzdG9wcGVkIHNpbmNlIGl0IGlzbid0IHN0YXJ0ZWQuYCk7XG4gICAgfVxuXG4gICAgdGhpcy5sb2cuaW5mbygnU3RvcHBpbmcgcGx1Z2luJyk7XG5cbiAgICBpZiAodHlwZW9mIHRoaXMuaW5zdGFuY2Uuc3RvcCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgYXdhaXQgdGhpcy5pbnN0YW5jZS5zdG9wKCk7XG4gICAgfVxuXG4gICAgdGhpcy5pbnN0YW5jZSA9IHVuZGVmaW5lZDtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlUGx1Z2luSW5zdGFuY2UoKSB7XG4gICAgdGhpcy5sb2cuZGVidWcoJ0luaXRpYWxpemluZyBwbHVnaW4nKTtcblxuICAgIGNvbnN0IHBsdWdpbkRlZmluaXRpb24gPSByZXF1aXJlKGpvaW4odGhpcy5wYXRoLCAnc2VydmVyJykpO1xuICAgIGlmICghKCdwbHVnaW4nIGluIHBsdWdpbkRlZmluaXRpb24pKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFBsdWdpbiBcIiR7dGhpcy5uYW1lfVwiIGRvZXMgbm90IGV4cG9ydCBcInBsdWdpblwiIGRlZmluaXRpb24gKCR7dGhpcy5wYXRofSkuYCk7XG4gICAgfVxuXG4gICAgY29uc3QgeyBwbHVnaW46IGluaXRpYWxpemVyIH0gPSBwbHVnaW5EZWZpbml0aW9uIGFzIHtcbiAgICAgIHBsdWdpbjogUGx1Z2luSW5pdGlhbGl6ZXI8VFN0YXJ0Q29udHJhY3QsIFREZXBlbmRlbmNpZXM+O1xuICAgIH07XG4gICAgaWYgKCFpbml0aWFsaXplciB8fCB0eXBlb2YgaW5pdGlhbGl6ZXIgIT09ICdmdW5jdGlvbicpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRGVmaW5pdGlvbiBvZiBwbHVnaW4gXCIke3RoaXMubmFtZX1cIiBzaG91bGQgYmUgYSBmdW5jdGlvbiAoJHt0aGlzLnBhdGh9KS5gKTtcbiAgICB9XG5cbiAgICBjb25zdCBpbnN0YW5jZSA9IGluaXRpYWxpemVyKHRoaXMuaW5pdGlhbGl6ZXJDb250ZXh0KTtcbiAgICBpZiAoIWluc3RhbmNlIHx8IHR5cGVvZiBpbnN0YW5jZSAhPT0gJ29iamVjdCcpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYEluaXRpYWxpemVyIGZvciBwbHVnaW4gXCIke1xuICAgICAgICAgIHRoaXMubWFuaWZlc3QuaWRcbiAgICAgICAgfVwiIGlzIGV4cGVjdGVkIHRvIHJldHVybiBwbHVnaW4gaW5zdGFuY2UsIGJ1dCByZXR1cm5lZCBcIiR7dHlwZURldGVjdChpbnN0YW5jZSl9XCIuYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIGluc3RhbmNlLnN0YXJ0ICE9PSAnZnVuY3Rpb24nKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEluc3RhbmNlIG9mIHBsdWdpbiBcIiR7dGhpcy5uYW1lfVwiIGRvZXMgbm90IGRlZmluZSBcInN0YXJ0XCIgZnVuY3Rpb24uYCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGluc3RhbmNlO1xuICB9XG59XG4iXX0=